---
name: 比特币隐私
goal: 了解并掌握使用比特币时的隐私保护原则
objectives: 

  - 定义理解隐私保护利害关系所需的理论概念
  - 了解如何识别和降低与比特币用户隐私泄露相关的风险
  - 使用方法和工具在比特币上保护您的隐私
  - 了解连锁分析方法并制定防御策略

---
# 保护比特币隐私

在金融交易隐私逐渐成为奢侈品的今天，了解和掌握比特币使用中的隐私保护原则至关重要。本培训从理论和实践两方面为您提供了自主实现这一目标的所有关键。

如今，在比特币上有一些专门从事链分析的公司。他们的核心业务正是侵入你的私人领域，以破坏你交易的保密性。事实上，比特币上的 "隐私权 "并不存在。因此，你，用户，应该维护自己的自然权利，保护自己交易的机密性，因为没有人会为你做这些。

本培训是一个完整的通识课程。每个技术概念都很详细，并配有解释性图表。目的是让每个人都能掌握知识。因此，BTC204 对初学者和中级用户来说都很容易接受。本培训还为经验丰富的比特币使用者提供了附加值，因为我们深入探讨了一些通常不为人知的技术概念。

加入我们，改变你对比特币的使用，成为一个知情的用户，能够理解与保密和保护隐私有关的问题。

+++
# 导言

<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## 培训简介

<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

在金融交易隐私逐渐成为奢侈品的今天，了解和掌握比特币使用中的隐私保护原则至关重要。本培训从理论和实践两方面为您提供了自主实现这一目标的所有关键。

如今，在比特币生态系统中，有一些公司专门从事链分析。他们的核心业务正是侵入你的私人领域，破坏你交易的保密性。实际上，比特币的 "隐私权 "并不存在。因此，用户应该维护自己的自然权利，保护自己交易的机密性，因为没有人会替你这么做。

比特币的存在不仅仅是为了 "数字上涨 "和储蓄保值。由于其独特的特性和历史，它主要是反经济的工具。有了这项非凡的发明，你可以自由地管理你的钱，花掉它，积累它，没有任何人可以阻止你。

比特币提供了一种摆脱国家枷锁的和平方式，使你能够充分享受你的自然权利，而这些权利是既定法律所无法挑战的。有了中本聪的发明，你就有能力让自己的私有财产得到尊重，重新获得契约自由。

然而，比特币默认情况下不是匿名的，这可能会给从事反经济活动的个人带来风险，尤其是在专制政权统治下的地区。但这并不是唯一的危险。鉴于比特币是一种有价值的、不可检查的资产，它可能会引起小偷的注意。因此，保护个人隐私也是一个安全问题：它可以帮助你防止网络攻击和人身攻击。

正如我们将要看到的，尽管协议提供了某些内在的隐私保护，但使用其他工具来优化和保护这种隐私也是至关重要的。

本培训是为了解比特币隐私的利害关系而设计的综合通识课程。每个技术概念都有详细的讨论，并配有解释性图表。我们的目标是让每个人，甚至是初级和中级用户，都能了解相关知识。对于更有经验的比特币使用者，我们也会在培训中涉及一些非常技术性的，有时是鲜为人知的概念，以加深对每个主题的理解。

本培训的目的不是让你在使用比特币时完全匿名，而是为你提供必要的工具，让你知道如何根据个人目标保护自己的隐私。您可以根据自己的具体目标和需求，自由选择所介绍的概念和工具，制定自己的策略。

### 第 1 部分：定义和关键概念

首先，我们将一起回顾比特币运行的基本原则，然后冷静地探讨与隐私相关的概念。掌握一些基本概念，如UTXOs、接收地址或脚本，对于充分理解我们在下面章节中要讨论的概念是非常重要的。我们还将介绍中本聪设想的比特币隐私的一般模型，这将使我们能够掌握相关的利害关系和风险。

![BTC204](assets/en/11/1.webp)

### 第 2 部分：了解连锁分析和如何防范连锁分析

在第二部分，我们将研究链分析公司用来追踪你在比特币上的活动的技术。了解这些方法对于加强隐私保护至关重要。这一部分旨在研究攻击者的策略，以便更好地了解风险，并为我们在接下来的章节中研究的技术打下基础。我们将分析交易模式、内部和外部启发式方法以及对这些模式的合理解释。除了理论部分，我们还将通过实际案例和练习，学习使用区块资源管理器进行链分析。

![BTC204](assets/notext/11/2.webp)

### 第 3 部分：掌握保护隐私的最佳做法

在培训的第三部分，我们将进入问题的核心：实践！我们的目标是掌握所有基本的最佳实践，这应该成为任何比特币用户的自然反应。我们将介绍新地址的使用、标签、合并、全节点的使用以及 KYC 和获取方法。我们的目的是为你提供一个全面的概览，让你了解在寻求隐私保护的过程中应该避免的陷阱，从而建立坚实的基础。对于其中的一些做法，您将在具体的教程指导下加以实施。

![BTC204](assets/en/11/3.webp)

### 第 4 节：了解 Coinjoin 交易

谈到比特币的隐私问题，怎么能不讨论币合呢？在第 4 部分中，你将了解到关于这种混合方法的所有知识。你将了解到什么是币币联合，它的历史和目标，以及现有的不同类型的币币联合。最后，对于更有经验的用户，我们将了解什么是匿名和熵，以及如何计算这些指标。

![BTC204](assets/en/11/4.webp)

### 第 5 节：了解其他高级隐私技术的利害关系

在第五部分，我们将概述除了 Coinjoin 之外，比特币上保护隐私的所有其他现有技术。多年来，开发者们在设计隐私保护工具方面表现出了非凡的创造力。我们将研究所有这些方法，如 payjoin、协同交易、币币交换和原子交换，详细介绍它们的操作、目标和潜在弱点。

我们还将讨论节点网络和交易传播层面的隐私问题。我们还将讨论多年来为提高比特币用户隐私而提出的各种协议，包括静态地址协议。

![BTC204](assets/notext/11/5.webp)

# 定义和关键概念

<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>

## 比特币UTXO模型

<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

比特币主要是一种货币，但你知道比特币在协议中是如何具体体现的吗？

### 比特币UTXOs：它们是什么？

在比特币协议中，货币单位的管理围绕着UTXO模型展开，UTXO是"_Unspent Transaction Output_"的缩写。

这种模式与传统的银行系统大相径庭，后者依靠账户和余额机制来跟踪资金流动。事实上，在银行系统中，个人余额保存在与身份相关的账户中。例如，当你从面包师那里买了一根法棍时，你的银行只需从你的账户中扣除购买金额，从而减少你的余额，而面包师的账户则记入相同的金额，增加他的余额。在这个系统中，除了交易记录之外，并不存在进入你账户的钱和离开你账户的钱之间的联系。

![BTC204](assets/en/21/1.webp)

在比特币上，情况有所不同。账户的概念并不存在，货币单位的管理也不是通过余额，而是通过UTXO。一个UTXO代表一个尚未花费的特定数量的比特币，从而形成一个可大可小的 "比特币碎片"。例如，一个UTXO可能价值 "500 BTC"，也可能只价值 "700 SATS"。

**> 提醒：** Satoshi（通常缩写为 sat）是比特币的最小单位，相当于法定货币中的美分。

```plaintext
1 BTC = 100,000,000 SATS
```

从理论上讲，UTXO 可以代表任何比特币价值，从 1 个比特币到约 2 100 万个比特币的理论最高值。然而，从逻辑上讲，拥有全部 2,100 万比特币是不可能的，而且还有一个较低的经济阈值，称为 "尘埃"，低于这个阈值，UTXO 就被认为在经济上不可行。

**> 你知道吗？** 在比特币上创建的最大UTXO价值`500,000 BTC`。它是 MtGox 平台在 2011 年 11 月的一次整合行动中创建的：[29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXO 和支出条件

UTXOs是比特币的交换工具。每笔交易都会消耗作为输入的UTXOs，并产生作为输出的新UTXOs。交易完成后，作为输入的UTXOs 被视为 "已消耗"，新的UTXOs 被生成并分配给交易输出中指定的接收者。因此，UTXO 只代表未用完的交易输出，因此也代表在特定时间属于用户的比特币数量。

![BTC204](assets/en/21/2.webp)

所有UTXO都由脚本保护，脚本规定了使用UTXO的条件。要使用UTXO，用户必须向网络证明他们符合保护该UTXO的脚本规定的条件。一般来说，UTXO 受一个公开密钥（或代表该公开密钥的接收地址）的保护。要使用与该公开密钥相关的UTXO，用户必须提供用该密钥制作的数字签名，以证明自己持有相应的私人密钥。这就是为什么说你的比特币钱包实际上并不包含比特币，而是存储着你的私钥，而私钥又能让你访问你的UTXO，进而访问它们所代表的比特币。

![BTC204](assets/en/21/3.webp)

由于比特币中没有账户的概念，钱包的余额只相当于它可以使用的所有 UTXOs 的价值总和。例如，如果你的比特币钱包可以使用以下 4 个UTXOs：

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

您钱包的总余额将是 `17 BTC`。

![BTC204](assets/en/21/4.webp)

## 比特币交易的结构

<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>

### 交易的输入和输出

比特币交易是区块链上记录的一种操作，它允许将比特币的所有权从一个人转移到另一个人。更具体地说，由于我们采用的是UTXO模式，不存在账户，因此交易满足了确保一个或多个UTXO的消费条件，消耗了这些UTXO，并等同于创建了具有新消费条件的新UTXO。简而言之，交易将比特币从一个已满足条件的脚本转移到一个新的脚本中，以确保比特币的安全。

![BTC204](assets/en/22/1.webp)

因此，每个比特币交易由一个或多个输入和一个或多个输出组成。输入是交易产生输出所消耗的UTXO。输出是新的UTXO，可作为未来交易的输入。

![BTC204](assets/en/22/2.webp)

**> 你知道吗？** 理论上，比特币交易可以有无限多的输入和输出。只有区块的最大大小限制了这个数量。

比特币交易中的每一笔输入都是指之前未花费的UTXO（未花费交易输出）。要使用UTXO作为输入，其持有者必须通过验证与之相关的脚本，即通过满足规定的支出条件，来证明他们是合法的所有者。一般来说，这需要提供一个数字签名，该数字签名是用私钥制作的，而私钥与最初为该UTXO提供担保的公钥相对应。这样，脚本就能验证该签名是否与接收资金时使用的公钥相符。

![BTC204](assets/en/22/3.webp)

另一方面，每次输出都会指定要转移的比特币数量和接收方。后者由一个新脚本定义，一般来说，脚本会用接收地址或新的公钥锁定新创建的 UTXO。

根据共识规则，一个交易要被视为有效，输出的总和必须小于或等于输入的总和。换句话说，交易产生的新UTXOs 总和不得超过作为输入消耗的UTXOs 总和。这一原则是合乎逻辑的：如果你只有`500,000 SATS`，你就不能购买`700,000 SATS`。

### 比特币交易中的变更和合并

因此，比特币交易对UTXO的作用可以比作金币的熔化。事实上，UTXO 是不可分割的，只能合并。这意味着，用户不能简单地将一个代表一定数量比特币的UTXO分割成几个较小的UTXO。他们必须在交易中将其全部消耗掉，以创建一个或多个新的UTXO，其输出值必须小于或等于初始值。

这种机制与金币类似。假设你拥有一枚 2 盎司的金币，而你想支付 1 盎司的货款，前提是卖方不能找零。您需要熔化您的金币，然后铸造 2 枚每枚 1 盎司的新金币。

比特币的操作也类似。假设爱丽丝有一个 `10,000 SATS` 的UTXO，她想买一个 `4,000 SATS` 的法棍。爱丽丝将进行一笔交易，输入 1 个价值 `10,000 SATS` 的UTXO，她将完全消耗掉这个UTXO，输出时，她将产生 2 个价值 `4,000 SATS` 和 `6,000 SATS` 的UTXO。4,000 SATS` 的UTXO 将被送到面包师那里，作为购买法棍的付款，而 6,000 SATS` 的UTXO 将作为零钱回到爱丽丝那里。在比特币的行话中，返回给交易初始发送者的UTXO被称为 "零钱"。

![BTC204](assets/en/22/4.webp)

现在设想一下，爱丽丝没有一个UTXO`10,000 SATS`，而是有两个UTXO，每个UTXO`3,000 SATS`。在这种情况下，任何一个UTXO都不足以支付长棍面包的`4,000 SATS`。因此，爱丽丝必须同时使用两个UTXO`3,000 SATS`作为交易输入。这样，投入的总金额将达到 6 000 SATS，使她能够支付给面包师 4 000 SATS。这种将交易投入中的几个UTXO组合在一起的方法通常被称为 "合并"。

![BTC204](assets/en/22/5.webp)

### 交易费用

直觉上，人们可能会认为交易费也是交易的一种产出。但实际上并非如此。交易费用代表的是投入总额与产出总额之间的差额。这意味着，在使用部分投入价值来支付交易中的预期产出之后，仍有一定的投入价值未被使用。这部分余额就是交易费用。

```plaintext
Fees = total inputs - total outputs
```

让我们回到爱丽丝的例子，她的UTXO为`10,000 SATS`，想用`4,000 SATS`买一根法棍。爱丽丝以她的UTXO`10,000 SATS`为输入创建了一个交易。然后，她生成一个 4,000 SATS` 的输出，用于支付面包师的长棍面包款。为了鼓励矿工将她的交易纳入区块，爱丽丝分配了 `200 SATS` 作为费用。这样，她就产生了第二个输出，即零钱，零钱将返回给她，数额为 `5,800SATS`。

![BTC204](assets/en/22/6.webp)

根据费用计算公式，我们确实可以看到矿工们还能得到 "200 SATS"：

```plaintext
Fees = total inputs - total outputs
Expenses = 10,000 - (4,000 + 5,800)
Expenses = 10,000 - 9,800
Expenses = 200
```

当矿工成功验证一个区块后，他们就可以通过所谓的 "coinbase "交易，为其区块中包含的所有交易收取这些费用。

### 在比特币上创建UTXOs

如果你仔细阅读了前面的段落，你就会知道，UTXO 只能通过消耗其他现有的 UTXO 来产生。因此，比特币上的币形成了一个连续的链。不过，你可能想知道这条链上的第一个UTXO是如何出现的。这就产生了一个类似于鸡和蛋的问题：这些最初的UTXO是从哪里来的？

答案就在 **coinbase 交易中。

代币库是一种特殊的比特币交易类型，在每个区块中都是独一无二的，而且总是其中的第一个。它允许找到有效工作证明的矿工获得区块奖励。这种奖励由两个元素组成： **区块补贴**和交易费用**。

Coinbase 交易的独特之处在于，它是唯一一种可以凭空创造比特币的交易，无需消耗输入来产生输出。这些新创建的比特币构成了所谓的 "原始 UTXOs"。

![BTC204](assets/en/22/7.webp)

来自区块补贴的比特币是按照共识规则中预先确定的发行时间表从无到有创造出来的新 BTC。区块补贴每 21 万个区块减半一次，大约每四年减半一次，这个过程被称为 "减半"。最初，每次补贴会产生 50 个比特币，但这一数量逐渐减少；目前，每个区块补贴为 3.125 个比特币。

至于与交易费用相关的部分，虽然也代表了新创建的 BTC，但它们不得超过一个区块中所有交易的总投入和总产出之间的差额。我们在前面已经看到，这些费用代表的是输入中未用于交易输出的部分。从技术上讲，这部分在交易过程中 "损失 "了，矿工有权以一个或多个新的 UTXO 的形式重新创造这部分价值。因此，这是交易发送者向矿工的价值转移，矿工将其添加到区块链中。

**> 您知道吗？ ** 由 coinbase 交易产生的比特币有 100 个区块的成熟期，在此期间，矿工不能使用这些比特币。这一规则旨在避免在链上使用新创建的比特币时出现复杂情况，因为这些新创建的比特币日后可能会被淘汰。

### UTXO模型的意义

首先，UTXO 模式直接影响比特币的交易费用。由于每个区块的容量是有限的，矿工会倾向于那些相对于其在区块中所占空间能提供最好费用的交易。事实上，一个交易的输入和输出所包含的UTXO越多，它就越重，因此需要的费用也就越高。这也是我们经常努力减少钱包中 UTXO 数量的原因之一，这也会影响隐私，我们将在本培训的第三部分详细探讨这个话题。

其次，如前文所述，比特币上的币本质上是一条UTXO 链。因此，每笔交易都在过去的UTXO和未来的UTXO之间建立了联系。因此，UTXO 可以明确追踪比特币从产生到当前支出的路径。这种透明度是积极的，因为它允许每个用户确保收到的比特币的真实性。然而，链式分析也正是基于这种可追溯性和可审计性原则，这种做法的目的是泄露你的隐私。我们将在培训的第二部分深入研究这种做法。

## 比特币的隐私模式

<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### 货币：真实性、完整性和双重消费

货币的功能之一是解决需求的双重重合问题。在一个以物易物的体系中，进行交换不仅需要找到一个提供满足我的需求的物品的人，还需要为他们提供满足他们自己的需求的等值物品。事实证明，找到这种平衡是很复杂的。

![BTC204](assets/notext/23/1.webp)

这就是为什么我们要使用货币，因为货币可以在空间和时间上进行价值转移。

![BTC204](assets/notext/23/2.webp)

货币要解决这个问题，就必须让提供商品或服务的一方相信他们有能力在日后花掉这笔钱。因此，任何希望接受一种货币（无论是数字货币还是实物货币）的理性个体都会确保这种货币符合两个基本标准：


- 硬币必须完好无损且为真币；**
- 不得重复花费。

在使用实物货币时，第一个特征是最复杂的。在不同的历史时期，金属硬币的完整性经常会受到剪切或钻孔等做法的损害。例如，在古罗马时期，市民们通常会刮掉金币的边缘，以收集一点贵金属，同时保留金币以备将来交易之用。这样，金币的内在价值就降低了，但其面值保持不变。这就是后来在硬币边缘铸上脊线的主要原因。

真实性也是实物货币媒介难以验证的一个特征。如今，打假技术越来越复杂，迫使商家投资昂贵的验证系统。

另一方面，由于其性质，重复消费对实物货币来说不是问题。如果我给你一张 10 欧元的钞票，它就不可逆转地离开了我，进入了你的手中，自然也就排除了多次消费相同货币单位的可能性。简而言之，我将无法再次使用这张 10 欧元的钞票。

![BTC204](assets/notext/23/3.webp)

数字货币的难度则不同。确保一个币的真实性和完整性通常比较简单。正如我们在上一节中看到的，比特币的UTXO模式允许追溯一个币的来源，从而验证它确实是由矿工按照共识规则创建的。

然而，要确保没有重复消费则更为复杂，因为任何数字商品本质上都是信息。与实物商品不同，信息在交换过程中不会分裂，而是通过倍增的方式传播。例如，如果我通过电子邮件发送给你一份文件，它就会被复制。在你这边，你无法确认我是否删除了原始文件。

![BTC204](assets/notext/23/4.webp)

### 防止比特币重复消费

避免数字商品重复的唯一方法就是了解系统内的所有交易所。这样，人们就能知道谁拥有什么，并根据交易情况更新每个人的持有量。例如，银行系统中的记账货币就是这样做的。当您用信用卡向商家支付 10 欧元时，银行会记录下这笔交易并更新分类账。

在比特币上，防止重复消费也是通过同样的方式实现的。这样做的目的是为了确认没有已经使用过相关币种的交易。如果这些币从未被使用过，那么我们就可以保证不会发生重复消费。中本聪在白皮书中用这句名言描述了这一原则：

**"**确认没有交易的唯一办法是了解所有交易。

然而，与银行模式不同的是，人们并不希望在比特币上信任一个中央实体。所有用户都必须能够确认没有重复消费，而不依赖第三方。因此，每个人都必须了解所有比特币交易。这就是比特币交易在所有网络节点上公开广播并在区块链上清晰记录的原因。

正是这种信息的公开传播使比特币的隐私保护变得复杂。在传统的银行系统中，理论上只有金融机构知道所进行的交易。而在比特币上，所有用户都可以通过各自的节点获知所有交易。

### 隐私模式：银行系统与比特币

在传统系统中，您的银行账户与您的身份相关联。银行家能够知道哪个银行账户属于哪个客户，以及与之相关的交易。然而，银行与公共领域之间的信息流被切断了。换句话说，不可能知道属于另一个人的银行账户的余额和交易情况。只有银行才能获得这些信息。

例如，你的银行家知道你每天早上在附近的面包店买法棍，但你的邻居并不知道这笔交易。因此，相关方，尤其是银行，可以获得信息流，但外人却无法获得。

由于我们在上一部分看到的交易公开传播的限制，比特币的隐私模式不能沿用银行系统的模式。就比特币而言，由于交易和公共领域之间的信息流无法切断，**隐私模式依赖于用户身份和交易**本身之间的分离。

例如，如果您用 BTC 支付从面包师那里买了一条法棍，您的邻居（拥有自己的完整节点）可以看到您的交易，就像他们可以看到系统中的所有其他交易一样。不过，如果尊重隐私原则，他们应该无法将这笔特定交易与您的身份联系起来。

![BTC204](assets/en/23/9.webp)

但是，由于比特币交易是公开的，因此还是有可能在它们之间建立联系，从而推断出相关方的信息。这种活动本身甚至构成了一门专业，叫做 "链分析"。在培训的下一部分，我将邀请你探索链分析的基本原理，以了解你的比特币是如何被追踪的，并知道如何更好地抵御它。

# 了解连锁分析和如何保护自己

<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## 什么是比特币的链式分析？

<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### 定义和操作

链分析是一种实践，包括用于追踪区块链上比特币流向的所有方法。一般来说，链分析依赖于观察先前交易样本的特征。然后，在想要分析的交易中找出这些相同的特征，并推导出合理的解释。这种从实际出发解决问题的方法被称为 "启发式"，目的是找到足够好的解决方案。

为简化起见，连锁分析主要分三步进行：

1. **观察区块链；**

2. **确定已知特征；**

3. **教育假设**

![BTC204](assets/en/31/1.webp)

任何人都可以进行链分析。只需通过一个完整的节点访问区块链的公共信息，就可以观察交易的动向并做出假设。也有一些免费工具可以促进这种分析，比如我们将在本部分最后两章详细探讨的网站 [OXT.me](https://oxt.me/)。不过，隐私面临的主要风险来自专门从事链分析的公司。这些公司已将链分析发展到工业规模，并向金融机构或政府出售服务。在这些公司中，Chainalysis 可能是最知名的。

### 产业链分析的目标

链式分析的目的之一是将比特币上的各种活动归类，以确定进行这些活动的用户的独特性。随后，就可以尝试将这些活动与真实身份联系起来。

![BTC204](assets/notext/31/2.webp)

还记得上一章吗？我解释过为什么比特币的隐私模型最初依赖于将用户的身份与其交易分离。因此，人们很容易认为链分析是不必要的，因为即使人们设法将链上活动归类，也无法将它们与真实身份联系起来。

从理论上讲，这种说法是准确的。在本培训的第一部分，我们看到加密密钥对用于建立UTXO的条件。从本质上讲，这些密钥对不会泄露其持有者的任何身份信息。因此，即使我们成功地将与不同密钥对相关的活动归为一组，也无法了解这些活动背后的实体。

![BTC204](assets/notext/31/3.webp)

然而，实际情况要复杂得多。有许多行为都有可能将真实身份与链上活动联系起来。在分析中，这被称为切入点，而切入点有很多。

最常见的当然是 KYC（*了解你的客户*）。如果你把比特币从一个受监管的平台提现到你的一个个人接收地址，那么有些人就能把你的身份和这个地址联系起来。更广泛地说，切入点可以是你的现实生活和比特币交易之间的任何形式的互动。例如，如果你在社交网络上公布了一个收款地址，这就可以成为分析的切入点。如果你用比特币向你的面包师付款，他们就可以把你的脸（这是你身份的一部分）和比特币地址联系起来。

在使用比特币的过程中，这些切入点几乎是不可避免的。虽然我们可以设法限制其范围，但它们依然存在。因此，将保护个人隐私的方法结合起来至关重要。虽然将真实身份和交易分离是一种有趣的方法，但在今天仍然是不够的。事实上，如果你的所有链上活动都可以被归类，那么最微小的切入点都有可能破坏你建立的唯一一层隐私。

![BTC204](assets/notext/31/4.webp)

### 抵御连锁分析

因此，我们在使用比特币时也有必要面对区块链分析。通过这种方式，我们可以最大限度地减少我们活动的聚集，并限制切入点对我们隐私的影响。

![BTC204](assets/notext/31/5.webp)

事实上，为了更好地对抗区块链分析，还有什么比熟悉区块链分析方法更好的方法呢？如果你想知道如何提高比特币的隐私性，就必须了解这些方法。这将使你更好地掌握 coinjoin 或 payjoin 等技术（我们将在培训的最后部分学习这些技术），并减少你可能犯的错误。

https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/fr/tutorials/privacy/on-chain/payjoin-848b6a23-deb2-4c5f-a27e-93e2f842140f
在这方面，我们可以用密码学和密码分析进行类比。一个好的密码学家首先是一个好的密码分析家。要设想一种新的加密算法，就必须知道它要面对哪些攻击，还要研究以前的算法为什么会被破解。同样的原则也适用于比特币的隐私保护。了解区块链分析的方法是防范它的关键。这就是为什么我在这次培训中提出了一个关于区块链分析的完整章节。

### 区块链分析方法

重要的是要明白，区块链分析不是一门精确的科学。它依赖于从以前的观察或逻辑解释中得出的启发式方法。这些规则可以得出相当可靠的结果，但绝不会绝对精确。换句话说，**区块链分析得出的结论总是涉及概率维度**。例如，可以或多或少地确定两个地址属于同一个实体，但总是无法完全确定。

区块链分析的整个目标正是在于汇总各种启发式方法，以最大限度地降低错误风险。从某种程度上说，这是一种证据积累，让我们能够更接近现实。

这些著名的启发式方法可以分为不同的类别，我们将一并详述：


- 交易模式（或交易模型）；**
- 交易内部启发法；**
- 交易之外的启发式**

### 中本聪与区块链分析

值得注意的是，链分析的前两个启发式方法是中本聪自己发现的。他在《比特币白皮书》第 10 部分中讨论了这两个启发式方法。它们是


- 共同输入所有权启发式（CIOH）；
- 和地址重复使用。

![BTC204](assets/notext/31/6.webp)

资料来源S. Nakamoto，《比特币：点对点电子现金系统》，https://bitcoin.org/bitcoin.pdf，2009 年。

在接下来的章节中，我们将探讨这两种启发式方法的内容，但值得注意的是，这两种启发式方法在当今的链式分析中仍然占据着主导地位。

## 交易模式

<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

交易模式只是区块链上典型交易的一个模型或整体结构，其解释可能是已知的。在研究模式时，我们将重点关注单个交易，并对其进行高层次分析。

换句话说，我们将只关注输入中的UTXOs 数量和输出中的UTXOs 数量，而不关注更具体的细节或交易环境。从观察到的模型中，我们可以解读出交易的性质。然后，我们将寻找其结构中的特征，并推导出一种解释。

![BTC204](assets/en/32/01.webp)

在这一部分中，我们将一起发现链分析中可能遇到的主要交易模式，对于每种模式，我都会给出这种结构的可能解释，并举出一个具体的例子。

### 简单发送（或简单支付）

我们从一个非常普遍的模式开始，因为它是大多数比特币支付中出现的模式。这种简单支付模式的特点是：输入消费一个或多个UTXO，输出生产 2 个UTXO。因此，这种模式是这样的

![BTC204](assets/en/32/02.webp)

当我们在区块链上发现这种交易结构时，我们已经可以得出一种解释。顾名思义，这种模式表明我们正在进行发送或支付交易。用户在输入时消耗了自己的UTXO，在输出时满足了支付UTXO和找零UTXO（资金返还给同一用户）。

因此我们知道，被观测的用户很可能已经不再拥有输出中的两个 UTXO 中的一个（付款 UTXO），但他们仍然拥有另一个 UTXO（变更 UTXO）。

目前，我们不可能明确指出哪个输出代表哪个UTXO，因为这不是研究模式的目的。我们将通过启发式方法来实现这一目标，我们将在下文中研究启发式方法。在现阶段，我们的目标仅限于确定相关事务的性质，在本例中，该事务是一次简单的发送。

例如，下面是一个采用简单发送模式的比特币交易：

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/en/32/03.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

看完第一个例子，你应该能更好地理解研究 "交易模型 "的含义了。我们研究交易时只关注其结构，而不考虑其环境或交易的具体细节。在第一步中，我们只对其进行全局观察。

既然你已经了解了什么是模式，那么让我们来看看其他现有的模式。

### 清扫

第二种模式的特点是将消耗单个 UTXO 作为输入，将生产单个 UTXO 作为输出。

![BTC204](assets/en/32/04.webp)

对这种模式的解释是，我们正处于自我转移的过程中。用户将自己的比特币转移到自己拥有的另一个地址。由于交易中没有任何变化，我们不太可能看到付款。事实上，在付款时，付款人的UTXO几乎不可能与卖方要求的金额完全一致，再加上交易费用。因此，付款方一般都被迫产生一个变化输出。

这样我们就知道，被观察到的用户很可能仍持有该UTXO。在链式分析中，如果我们知道交易中作为输入的UTXO属于爱丽丝，我们就可以假设输出的UTXO也属于她。稍后有趣的是找到交易的内部启发式方法来加强这一假设（我们将在第 3.3 章中研究这些启发式方法）。

例如，下面是一个采用扫码模式的比特币交易：

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/en/32/05.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d)

不过，这种模式也可以揭示向加密货币交易所平台账户的自我转账。通过对已知地址和交易背景的研究，我们可以知道这是向自我保管的钱包扫码，还是向平台取款。事实上，交易所平台的地址通常很容易识别。

让我们回到爱丽丝的例子：如果扫码指向一个已知的平台地址（例如 Binance），这可能意味着比特币被转移出了爱丽丝的直接财产，其目的可能是将其出售或存储在该平台上。另一方面，如果目标地址未知，则可以合理地认为这只是另一个仍属于 Alice 的钱包。但这类研究更多属于启发式研究，而非模式研究。

### 合并

该模型的特点是，消耗多个UTXO 作为输入，生产一个UTXO 作为输出。

![BTC204](assets/en/32/06.webp)

对这一模式的解释是，我们正处于合并阶段。这是比特币用户的常见做法，目的是合并几个UTXO，以应对可能出现的交易费用上涨。在费用较低的时期进行这种操作，可以节省未来的费用。我们将在第 4.3 章详细介绍这种做法。

我们可以推断出，这个交易模型背后的用户很可能拥有输入中的所有UTXO，并且仍然拥有输出中的UTXO。这肯定是一种自我转移。

就像扫码一样，这种模式也可以揭示向交易所平台账户的自我转账。通过对已知地址和交易背景的研究，我们就能知道这是向自我保管的钱包合并，还是向平台取款。

例如，下面是一笔采用盘整模式的比特币交易：

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/en/32/07.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)

在链式分析中，这个模型可以揭示很多信息。例如，如果我们知道其中一个输入属于爱丽丝，那么我们就可以假设该交易的所有其他输入和输出也属于她。根据这一假设，我们可以追溯之前的交易链，发现并分析可能与爱丽丝有关的其他交易。

![BTC204](assets/en/32/08.webp)

### 分组支出

这种模式的特点是消耗少量的UTXO 作为输入（通常只有一个），生产大量的UTXO 作为输出。

![BTC204](assets/en/32/09.webp)

对这一模型的解释是，我们正处于分组消费的环境中。这种做法很可能揭示了重要的经济活动，例如交换平台。分组消费允许这些实体将其支出合并为单笔交易，从而节省费用。

我们可以从这个模型中推断出，UTXO 的输入来自一家有重大经济活动的公司，而 UTXO 的输出将是分散的。其中许多将属于从平台上提取比特币的公司客户。其他的可能会流向合作公司。最后，肯定会有一个或多个交易所返回发行公司。

例如，这里有一笔采用分组消费模式的比特币交易（很可能是 Bybit 平台发布的交易）：

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/en/32/10.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### 特定协议交易

在交易模式中，我们还可以识别出揭示特定协议使用情况的模式。例如，漩涡币合并（我们将在第五部分讨论）将有一个易于识别的结构，使其能够与其他更传统的交易区分开来。

![BTC204](assets/en/32/11.webp)

对这种模式的分析表明，我们很可能正在进行合作交易。我们也有可能观察到了联合交易。如果后一种假设被证明是准确的，那么输出的数量就可以为我们提供一个关于联合行动参与者数量的近似估计。

例如，这里有一笔比特币交易，采用了协作交易类型 Coinjoin 的模式：

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/en/32/12.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

还有许多其他协议都有自己的特定结构。例如，我们可以区分 Wabisabi 类型的交易、Stamps 交易，甚至是 Runes 交易。

有了这些交易模式，我们就可以解读特定交易的大量信息。但是，交易结构并不是唯一的分析信息来源。我们还可以研究它的细节。这些交易内部的细节，我称之为 "内部启发式"，我们将在下一章研究它们。

## 内部启发式方法

<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

内部启发式是在交易本身中识别出的特定特征，无需对其环境进行检查，就能让我们做出推断。与关注交易整体结构的高层次模式不同，内部启发式以可提取的数据集为基础。这包括


- 流入和流出的不同 UTXO 的数量；
- 有关脚本的一切：接收地址、版本、锁定时间...

一般来说，这种启发式方法可以让我们识别特定交易中的变化。这样，我们就可以在多个不同的交易中继续追踪一个实体。事实上，如果我们识别出属于我们希望跟踪的用户的UTXO，那么在他们进行交易时，确定哪些输出被转移给了另一个用户，哪些输出代表了变化，从而由他们继续拥有，这一点至关重要。

![BTC204](assets/en/33/01.webp)

我再次提醒大家，这些启发式方法并不是绝对精确的。单独来看，它们只能让我们确定似是而非的情况。正是几种启发式方法的累积，才有助于减少不确定性，而不会完全消除不确定性。

### 内部相似性

这种启发式方法涉及对同一交易的输入和输出之间相似性的研究。如果我们在输入端观察到相同的特征，而只在交易的一个输出端观察到相同的特征，那么这个输出端就很可能构成了变化。

最明显的特征是在同一交易中重复使用接收地址。

![BTC204](assets/en/33/02.webp)

这种启发式方法几乎没有可疑之处。除非某人的私钥被黑客窃取，否则相同的接收地址不可避免地会暴露单个用户的活动。由此得出的解释是，交易的变化是输出与输入相同的地址。这样就可以根据这一变化继续追踪个人。

例如，以下交易就可以合理地采用这种启发式：

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/notext/33/03.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

输入和输出之间的这些相似性并不仅限于地址的重复使用。脚本使用中的任何相似之处都可以应用启发式。例如，有时可以观察到交易的输入和其中一个输出之间存在相同的版本。

![BTC204](assets/en/33/04.webp)

在该图中，我们可以看到 0 号输入解锁了一个 P2WPKH 脚本（以 `bc1q` 开头的 SegWit V0）。0 号输出使用相同类型的脚本。但是，1 号输出使用的是 P2TR 脚本（以 `bc1p` 开头的 SegWit V1）。对这一特征的解释是，与输入具有相同版本的地址很可能是变更地址。因此，它仍属于同一个用户。

下面是一个可以合理应用这一启发式的交易：

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/notext/33/05.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)

在这种情况下，我们可以看到 0 号输入和 1 号输出使用的是 P2WPKH 脚本（SegWit V0），而 0 号输出使用的是另一种类型的脚本，即 P2PKH（传统）。

在 2010 年代初，由于可用脚本类型的限制，这种基于脚本版本的启发式方法作用相对较小。然而，随着时间的推移和比特币的不断更新，脚本类型也越来越多样化。这种启发式方法变得越来越重要，因为随着脚本类型的增多，用户被分成了更小的群体，从而增加了应用内部版本重用这种启发式方法的机会。因此，仅从隐私角度考虑，建议选择最常见的脚本类型。例如，在我写下这些行文时，Taproot 脚本（`bc1p`）的使用频率低于 SegWit V0 脚本（`bc1q`）。虽然前者在某些特定情况下具有经济和隐私优势，但对于更传统的单一签名用途，出于隐私考虑，在新标准被更广泛采用之前，坚持使用旧标准可能是明智之举。

### 整数付款

另一个可以帮助我们识别变化的内部启发式是整数。一般来说，面对一个简单的付款模式（1 个输入和 2 个输出），如果其中一个输出支出的金额是整数，那么它就代表付款。

![BTC204](assets/en/33/06.webp)

根据排除法，如果一个输出代表付款，则另一个输出代表变动。因此可以推断，输入交易的用户很可能仍然拥有被识别为变动的输出。

需要注意的是，这种启发式并不总是适用，因为大多数支付仍然是以法定货币单位进行的。事实上，当法国的商家接受比特币时，他们一般不会用比特币显示稳定的价格。他们更愿意选择在欧元价格和比特币支付金额之间进行换算。因此，交易输出中不应该出现整数。

尽管如此，分析人员仍可根据交易在网络上广播时的有效汇率，尝试进行这种换算。让我们举一个交易的例子，输入为 97,552 萨特，输出为 31,085 萨特和 64,152 萨特。乍一看，这笔交易似乎不涉及整数。然而，按照交易时 64 339 欧元的汇率，我们可以得到如下欧元换算：


- 投入 62.76 欧元；
- 产出为 20 欧元；
- 产出为 41.27 欧元。

一旦兑换成法定货币，这笔交易就可以应用整数付款启发式。20 欧元的输出很可能是给一个商人的，或者至少改变了所有权。由此推断，41.27 欧元的输出可能仍为原用户所有。

![BTC204](assets/en/33/07.webp)

如果有一天，比特币成为我们交易中的首选记账单位，那么这种启发式分析就会变得更加有用。

例如，以下交易就有可能采用这种启发式：

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/notext/33/08.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)

### 最大的产出

在一个简单的支付模型中，当两个交易产出之间出现足够大的差距时，可以估计较大的产出很可能就是变化。

![BTC204](assets/en/33/09.webp)

这种最大产出的启发式方法可能是最不精确的。如果单独识别，它是相当薄弱的。不过，这一特点可以与其他启发式方法相结合，以减少我们解释的不确定性。

例如，如果我们对一项交易进行审查，发现一项产出的金额为整数，而另一项产出的金额较大，那么我们就可以联合应用整数支付启发式和最大产出启发式，从而降低不确定性水平。

例如，以下交易就有可能采用这种启发式：

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/notext/33/10.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## 外部启发式方法

<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

外部启发法的研究涉及分析某些非交易本身固有元素的相似性、模式和特征。换句话说，如果说以前我们仅限于通过内部启发式来利用交易中固有的元素，那么现在我们则借助外部启发式将分析领域扩展到了交易环境。

### 地址重用

这是比特币爱好者最熟悉的启发式方法之一。地址重用允许在不同的交易和不同的UTXO之间建立联系。当一个比特币接收地址被多次使用时，就会出现这种情况。

因此，可以利用同一事务中的地址重用作为内部启发式来识别变更（如上一章所述）。不过，地址重用也可以作为一种外部启发式来识别多个事务背后实体的唯一性。

对地址重用的解释是，锁定在该地址上的所有UTXO都属于（或曾经属于）同一个实体。这种启发式方法几乎不存在不确定性。当可以识别时，接下来的解释就很有可能符合实际情况。因此，它允许对不同的链上活动进行分组。

![BTC204](assets/en/34/01.webp)

正如本第 3 部分导言中所解释的，这种启发式是中本聪自己发现的。在白皮书中，他特别提到了用户避免产生这种现象的解决方案，即每次新交易都使用一个新地址：

"_作为额外的防火墙，可以为每笔交易使用一对新的密钥，以防止它们被链接到一个共同的所有者。

![BTC204](assets/notext/34/02.webp)

资料来源S. Nakamoto，《比特币：点对点电子现金系统》，https://bitcoin.org/bitcoin.pdf，2009 年。

例如，下面是一个在多个交易中重复使用的地址：

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/notext/34/03.webp)

来源：[Mempool.space]()[Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### 脚本相似性和钱包指纹

除了地址重用，还有许多其他启发式方法可以将操作链接到同一个钱包或地址集群。

首先，分析人员可以从脚本使用的相似性中获益。例如，某些少数脚本（如 multisig）比 SegWit V0 脚本更容易识别。我们隐藏的群体越大，就越难被发现。这就是为什么在优秀的 Coinjoin 协议中，所有参与者都使用完全相同类型的脚本。

更广义地说，分析师还可以关注钱包的特征指纹。这些是与使用相关的特定过程，人们可以设法识别这些过程，以便利用它们作为追踪启发式方法。换句话说，如果观察到被追踪实体的交易中积累了相同的内部特征，就可以尝试在其他交易中识别这些相同的特征。

例如，可以发现被跟踪的用户系统性地向 P2TR 地址（"bc1p......"）发送更改。如果这一过程重复出现，我们就可以将其作为启发式方法继续进行分析。还可以使用其他指纹，如 UTXO 的顺序、输出中更改的位置、RBF（Replace-by-Fee）信号，甚至版本号、"nSequence "字段和 "nLockTime "字段。

![BTC204](assets/en/34/04.webp)

正如[@LaurentMT](https://twitter.com/LaurentMT)在[Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)（法语播客）中所指出的，随着时间的推移，钱包指纹在链分析中的实用性显著增加。事实上，随着脚本类型的不断增加，以及钱包软件对这些新功能的逐步应用，这些差异就更加明显了。我们甚至可以准确地识别出被追踪实体所使用的软件。因此，重要的是要明白，对钱包指纹的研究证明与近期交易特别相关，比 2010 年代初开始的交易更相关。

总之，指纹可以是钱包自动执行或用户手动执行的任何特定操作，它可以在其他交易中找到，以帮助我们进行分析。

### 共同投入所有权启发式（CIOH）

CIOH 的英文全称是 "Common Input Ownership Heuristic"（共同输入所有权启发式），它是一种启发式，指出当一项交易包含多个输入时，这些输入很可能都来自一个实体。因此，它们的所有权是共同的。

要应用共同输入所有权启发式（CIOH），我们首先要观察一笔有多个输入的交易。这种情况可能只有 2 个输入，也可能多达 30 个输入。一旦确定了这一特征，我们就要检查该交易是否不符合已知的交易模型。例如，如果它有 5 个金额大致相同的输入和 5 个金额完全相同的输出，我们就知道这是一个硬币连接的结构。因此，我们不能应用 CIOH。

但是，如果该事务不符合任何已知的协作事务模型，我们就可以推断所有输入可能来自同一个实体。这对于扩展已知群集或继续追踪非常有用。

中本聪发现了 CIOH。他在《白皮书》第 10 部分中对此进行了讨论：

"_[......]链接在多输入交易中是不可避免的，它必然会揭示其输入为同一所有者所有。风险在于，如果密钥的所有者被揭露，链接就会揭露属于同一所有者的其他交易。

特别令人感兴趣的是，中本聪甚至在比特币正式推出之前，就已经发现了用户隐私方面的两个主要漏洞，即 CIOH 和地址重用。这种先见之明非常了不起，因为这两种启发式方法直到今天仍然是链分析中最有用的方法。

举例来说，我们可以在以下交易中使用 CIOH：

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

来源：[Mempool.space]()[Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### 离链数据

显然，链分析并不局限于链上数据。以往分析或互联网上的任何数据都可以用来完善分析。

例如，如果观察到追踪到的交易系统地从同一个比特币节点发出，并且可以确定其 IP 地址，那么除了确定发送者的部分身份外，还有可能发现来自同一实体的其他交易。虽然这种做法不容易实现，因为它需要操作许多节点，但一些专门从事链分析的公司有可能采用这种方法。

分析人员还可以选择依赖以前的开源分析或自己以前的分析。也许我们可以找到一个输出结果，指向一个已经被识别的地址集群。有时，也可以依靠指向交换平台的输出结果，这些公司的地址一般都是众所周知的。

同样，我们也可以通过排除法进行分析。例如，在分析一个有两个输出的事务时，如果其中一个输出与已知的地址集群有关联，但与被追踪的实体不同，那么就可以解释为另一个输出很可能代表了变化。

链式分析还包括一部分 OSINT（*开源情报*），它与互联网搜索的关系更为广泛。因此，建议不要在社交媒体或网站上直接公布接收地址，无论是否使用化名。

![BTC204](assets/notext/34/10.webp)

### 时间模型

虽然不那么常见，但人类的某些行为在链上是可以识别的。最有用的分析可能是你的睡眠模式！是的，当你在睡觉的时候，你可能没有在进行比特币交易。由于你的睡眠时间一般都差不多，在链分析中使用时间分析是很常见的。简单来说，就是把某个实体的交易在比特币网络上广播的时间编成目录。通过分析这些时间模式，我们可以推断出许多信息。

首先，时间分析有时可以确定被追踪实体的性质。如果观察到交易在 24 小时内持续播出，那么这将揭示出强烈的经济活动。这些交易背后的实体很可能是一家公司，可能是国际公司，内部可能有自动化程序。

例如，[几个月前我就通过分析[错误分配 19 个比特币费用的交易](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd) 认识到了这种模式](https://twitter.com/Loic_Pandul/status/1701127409712452072)。通过简单的时间分析，我推测我们面对的是一个自动化服务，因此很可能是一个大型实体，比如交易所平台。

事实上，几天后，人们发现这些资金属于贝宝公司，是通过 Paxos 交易平台进行交易的。

相反，如果我们看到时间模式分布在 16 个非常具体的小时内，那么我们就可以估计，我们面对的是一个个人用户，或者根据交易量，可能是一个本地企业。

除了观察到的实体的性质外，时间模式还能通过时区为我们提供用户的大致位置。因此，我们可以将其他交易联系起来，并将这些交易的时间戳作为额外的启发式方法添加到我们的分析中。

例如，在我之前谈到的重复使用的地址上，我们可以观察到，无论是传入还是传出的交易，都集中在 13 个小时的时间间隔内。

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/notext/34/11.webp)

来源：OXT.me来源：OXT.me

这个时间段很可能对应欧洲、非洲或中东。因此，我们可以推断，这些交易背后的用户就住在那里。

从另一个角度看，也正是这种类型的时区分析，让我们提出了中本聪不是在日本而是在美国运作的假设：[中本聪的时区*](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## 区块资源管理器的实际应用

<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

在这最后一章中，我们将具体应用迄今为止所学到的概念。我将向你展示真实的比特币交易实例，你需要提取我所要求的信息。

理想情况下，这些练习最好使用专业的链分析工具。然而，自从 Samourai Wallet 的创建者被捕后，唯一的免费分析工具 OXT.me 就不再可用了。因此，我们将选择经典的区块资源管理器来进行这些练习。我推荐使用[Mempool.space](https://mempool.space/)，因为它的功能和链分析工具种类繁多，但你也可以选择其他资源管理器，如[Bitcoin Explorer](https://bitcoinexplorer.org/)。

首先，我来介绍一下练习。请使用图块资源管理器完成这些练习，并将答案写在纸上。然后，在本章末尾，我将提供答案，以便你检查和更正你的结果。

*这些练习所选的交易完全是根据其特点随机选择的。本章仅用于教育和提供信息。我想说明的是，我并不支持或鼓励出于恶意目的使用这些工具。我们的目的是教你如何保护自己免受链式分析的侵害，而不是进行分析以暴露他人的私人信息。

### 练习 1

要分析的交易 ID：

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

这种交易模式的名称是什么？只研究其模式，即交易结构，可以得出哪些合理的解释？

### 练习 2

要分析的交易 ID：

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

这种交易模式的名称是什么？只研究其模式，即交易结构，可以得出哪些合理的解释？

### 练习 3

要分析的交易 ID：

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

这次交易的模式是什么？

在确定其模型后，利用交易的内部启发式，哪种输出可能代表变化？

### 练习 4

要分析的交易 ID：

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

这次交易的模式是什么？

在确定其模型后，利用交易的内部启发式，哪种输出可能代表变化？

### 练习 5

想象一下，Loïc 在社交网络 Twitter 上发布了他的一个比特币接收地址：

![BTC204](assets/notext/35/1.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

仅使用**地址重用启发式**，我们可以将哪些比特币交易与 Loïc 的身份联系起来？

*显然，我不是这个接收地址的真正主人，也没有在社交网络上发布过。这是我从区块链中随机选取的地址*。

### 练习 6

在练习 5 之后，通过地址重用启发式，您可以识别出 Loïc 似乎参与的几笔比特币交易。通常情况下，在已识别的交易中，您应该已经发现了这一交易：

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
```

这笔交易是向 Loïc 地址发送资金的第一笔交易。在你看来，Loïc 通过这笔交易收到的比特币是从哪里来的？

### 练习 7

在练习 5 之后，通过地址重用启发式，您可以确定 Loïc 似乎参与了几笔比特币交易。现在您想知道 Loïc 来自哪里。根据找到的交易，进行时间分析，找出 Loïc 可能使用的时区。根据这个时区，确定 Loïc 似乎居住的地点（国家、州/地区、城市......）。

![BTC204](assets/notext/35/2.webp)

### 练习 8

下面是要研究的比特币交易：

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

只观察这笔交易，我们能解读出哪些信息？

### 练习解答

***练习 1：***

这笔交易的模式是简单的支付。如果我们只研究它的结构，我们可以解释为一个输出代表变化，另一个输出代表实际支付。因此我们知道，被观察到的用户很可能不再拥有两个输出中的一个 UTXO（用于支付的输出），但仍然拥有另一个 UTXO（用于更改的输出）。

***练习 2：***

该交易的模式是批量消费。这种模式很可能表明存在重大的经济活动，例如交易所平台。我们可以推断，输入的 UTXO 来自一家有重大经济活动的公司，而输出的 UTXO 将会分散。其中一些属于该公司的客户，他们将比特币提取到自我保管的钱包中。另一些则会流向合作伙伴公司。最后，肯定会有一部分回到发行公司。

***练习 3:***

这笔交易的模式是简单付款。因此，我们可以对该交易采用内部启发式方法来尝试识别变化。

我个人发现，至少有两种内部启发式方法支持同样的假设：


- 重复使用同一类型的脚本；
- 产量最大。

最明显的启发式方法是重复使用同一类型的脚本。事实上，输出`0`是一个`P2SH`，它的接收地址是以`3`开头的：

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

而输出`1`是一个`P2WPKH`，可通过以`bc1q`开头的地址进行识别：

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

该事务输入中使用的 UTXO 也使用 "P2WPKH "脚本：

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

因此，我们可以假设输出`0`对应的是付款，输出`1`是交易的变化，这意味着输入中的用户仍然拥有输出`1`。

为了支持或反驳这一假设，我们可以寻找其他启发式方法，要么证实我们的想法，要么降低我们假设正确的概率。

我至少还发现了一个启发式。这是最大的输出。输出 "0 "测量了 "123,689 sats"，而输出 "1 "测量了 "505,839 sats"。因此，这两个输出之间存在显著差异。最大输出的启发式表明，最大量的输出很可能是变化。因此，这一启发式进一步加强了我们最初的假设。

看来，在输入中提供 UTXO 的用户仍然持有输出`1`，这似乎体现了交易的变化。

***练习 4:***

这笔交易的模式是简单付款。因此，我们可以对该交易采用内部启发式方法来尝试识别变化。

我个人发现，至少有两种内部启发式方法支持同样的假设：


- 重复使用同一类型的脚本；
- 整数的输出。

最明显的启发式方法是重复使用同一类型的脚本。事实上，输出`0`是一个`P2SH`，其接收地址以`3`开头：

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

而输出`1`是一个`P2WPKH`，可通过以`bc1q`开头的地址进行识别：

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

用作该事务输入的 UTXO 也使用了`P2WPKH`脚本：

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

因此，我们可以假设输出`0`对应的是付款，输出`1`是交易的变化，这意味着输入中的用户仍然拥有输出`1`。

为了支持或反驳这一假设，我们可以寻找其他启发式方法，要么证实我们的想法，要么降低我们假设正确的概率。

我至少还发现了一个启发式。这是一个整数的输出。输出量`0`为`70,000 萨特`，而输出量`1`为`22,962 萨特`。因此，我们看到的是以 BTC 为记账单位的完美整数输出。圆形输出的启发式表明，具有圆形金额的 UTXO 很可能是付款，通过排除，另一个代表变化。因此，这种启发式进一步加强了我们最初的假设。

然而，在这个例子中，另一个启发式可能会质疑我们最初的假设。事实上，输出`0`大于输出`1`。如果我们基于 "最大的输出通常是变化 "这一启发式，就可以推断出输出`0`就是变化。然而，这个反假设似乎并不可信，因为其他两个启发式似乎比最大输出更有说服力。因此，尽管存在这一明显的矛盾，但维持我们最初的假设似乎是合理的。

因此，提供 UTXO 作为输入的用户很可能仍持有 "1 "输出，这似乎代表了交易的变化。

***练习 5:***

我们可以看到，有 8 笔交易与 Loïc 的身份有关。其中，4 笔涉及接收比特币：

```plaintext
2d9575553c99578268ffba49a1b2adc3b85a29926728bd0280703a04d051eace
8b70bd322e6118b8a002dbdb731d16b59c4a729c2379af376ae230cf8cdde0dd
d5864ea93e7a8db9d3fb113651d2131567e284e868021e114a67c3f5fb616ac4
bc4dcf2200c88ac1f976b8c9018ce70f9007e949435841fc5681fd33308dd762
```

另外 4 个涉及发送比特币：

```plaintext
8b52fe3c2cf8bef60828399d1c776c0e9e99e7aaeeff721fff70f4b68145d540
c12499e9a865b9e920012e39b4b9867ea821e44c047d022ebb5c9113f2910ed6
a6dbebebca119af3d05c0196b76f80fdbf78f20368ebef1b7fd3476d0814517d
3aeb7ce02c35eaecccc0a97a771d92c3e65e86bedff42a8185edd12ce89d89cc
```

***练习 6:***

如果我们研究一下这笔交易的模式，就会发现这是一笔分组支出。事实上，这笔交易有一个输入和 51 个输出，这表明有大量的经济活动。因此，我们可以假设 Loïc 从一个交换平台上提取了比特币。

有几个因素强化了这一假设。首先，用于确保输入中 UTXO 安全的脚本类型是 2/3 多位 P2SH 脚本，这表明交易所平台具有典型的高级安全级别：

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```

此外，被分析的地址 "3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF "在超过 220,000 次不同的交易中被重复使用，这通常是交易所平台的特征，它们通常不关心自己的隐私。应用于该地址的时间启发式还显示，在 3 个月的时间里，几乎每天都有固定的交易分布，时间超过 24 小时，表明交易所平台在持续活动。

最后，该实体处理的交易量巨大。事实上，在 2022 年 12 月至 2023 年 3 月期间的 222,262 次交易中，该地址接收和发送了 44 BTC。这些巨大的交易量进一步证实了交易所平台活动的可能性。

***锻炼 7:***

通过分析交易确认时间，可以注意到以下 UTC 时间：

```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

分析这些时间，UTC-7 时区和 UTC-8 时区似乎在大部分时间内与一系列常见的人类活动（08:00 至 23:00）相一致：

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7
05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

![BTC204](assets/notext/35/2.webp)

UTC-7时区在夏季尤为重要，因为它包括以下州和地区：


- 加利福尼亚州（包括洛杉矶、旧金山和圣迭戈等城市）；
- 内华达州（含拉斯维加斯）；
- 俄勒冈州（含波特兰）；
- 华盛顿（含西雅图）；
- 加拿大不列颠哥伦比亚省（包括温哥华和维多利亚等城市）。

这些信息表明，Loïc 有可能居住在美国西海岸或加拿大。

***练习 8:***

对该交易的分析显示有 5 个输入和一个输出，这似乎表明是合并交易。应用 CIOH 启发式表明，输入的所有UTXO 由一个实体持有，输出的UTXO 也属于该实体。看来，用户选择将其拥有的几个UTXO 合并为一个输出UTXO，目的是合并其硬币。这种做法的动机可能是希望利用当时的低交易费来减少未来的费用。

___

*在撰写第三部分 "链分析 "时，我参考了以下资料：* *


- 系列文章共四篇，名为：[用 OXT 理解比特币隐私](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923)，由 Samourai Wallet 于 2021 年制作；*
- OXT Research](https://medium.com/oxt-research)的各种报告，以及他们的免费链分析工具（在 Samourai Wallet 创始人被捕后，该工具目前已无法使用）；*
- 更广泛地说，我的知识来自[@LaurentMT](https://twitter.com/LaurentMT)和[@ErgoBTC](https://twitter.com/ErgoBTC)的各种推文和内容；*
- 我与[@louneskmt](https://twitter.com/louneskmt)、[@TheoPantamis](https://twitter.com/TheoPantamis)、[@Sosthene___](https://twitter.com/Sosthene___)和[@LaurentMT](https://twitter.com/LaurentMT)共同参与的[Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji)。*

*我要感谢它们的作者、开发者和制作者。还要感谢审稿人，他们对作为本第 3 部分基础的文章进行了一丝不苟的修改，并向我提供了他们的专家建议*。


- [Gilles Cadignan](https://twitter.com/gillesCadignan);*
- [Ludovic Lars](https://viresinnumeris.fr/).*

# 掌握保护隐私的最佳做法

<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## 地址重用

<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>

在研究了比特币上可能危及个人隐私的技术之后，我们将在第三部分探讨保护个人隐私的最佳方法。这一部分的目的不是探讨改善隐私的方法，这个问题将在后面讨论，而是了解如何正确地与比特币互动，以保持其自然提供的隐私，而不诉诸其他技术。

显然，在第三部分的开头，我们要谈谈地址重复使用的问题。这种现象是对用户隐私的主要威胁。因此，本章可以说是整个培训中最重要的一章。

### 什么是接收地址？

比特币接收地址是一串字符或一个标识符，用于在钱包中接收比特币。

从技术上讲，比特币接收地址并不是字面意义上的 "接收 "比特币，而是定义了比特币的使用条件。具体来说，当一笔付款发送给你时，发送方的交易会在输出端为你创建一个新的UTXO，这个输出端来自它在输入端消耗的UTXO。在这个输出中，会应用一个脚本，定义以后如何使用这个UTXO。该脚本称为 "*ScriptPubKey*"或 "*Locking Script*"。您的接收地址，更确切地说是它的有效载荷，被整合到这个脚本中。简单地说，这个脚本主要规定：

> "*要使用这一新的UTXO，必须使用与这一接收地址相关联的私人密钥提供数字签名。
![BTC204](assets/notext/41/01.webp)

比特币地址有不同的类型，取决于所使用的脚本模型。第一种模式被称为 "*Legacy*"，包括 "P2PKH"（*Pay-to-PubKey-Hash*）和 "P2SH"（*Pay-to-Script-Hash*）地址。P2PKH 地址总是以 "1 "开头，P2SH 以 "3 "开头。虽然这些格式仍然安全，但现在已经过时，因为与新标准相比，它们会导致更高的交易费用，并且隐私性更低。

SegWit V0（`P2WPKH`和`P2WSH`）和 Taproot / SegWit V1（`P2TR`）地址代表了现代格式。SegWit 地址以 `bc1q` 开头，2021 年推出的 Taproot 地址以 `bc1p` 开头。

例如，这是一个 Taproot 接收地址：

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

构建 ScriptPubKey 的方式取决于您使用的标准：

| 脚本模型 | 脚本出版键 | | ---------------- | ----------------------------------------------------------- |

| P2PKH | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG | OP_EQUALVERIFY OP_CHECKSIG

P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL | P2SH | OP_HASH160 `<scriptHash>` OP_EQUAL

| P2WPKH | 0 `<pubKeyHash>` | P2WPKH

P2WSH | 0 `<witnessScriptHash>` | P2WSH | 0 `<witnessScriptHash>` | P2WSH | 0

P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | P2SH - P2WPKH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | P2WPKH

| P2SH - P2WSH | OP_HASH160 `<redeemScriptHash>` OP_EQUAL | P2WSH

| P2TR | 1 `<pubKey>` | P2TR

至于接收地址的构建，也取决于所选择的脚本模型：


- 对于 "P2PKH "和 "P2WPKH "地址，有效载荷（即地址的核心部分）代表公钥的哈希值；
- 对于 `P2SH` 和 `P2WSH` 地址，有效载荷代表脚本的哈希值；
- 至于 `P2TR` 地址，其有效载荷是经过调整的公钥。P2TR "输出结合了_Pay-to-PubKey_和_Pay-to-Script_的各个方面。经过调整的公钥是在经典的消费公钥基础上进行 "调整 "的结果，它来自一组脚本的梅克尔根，这些脚本也可以用来消费比特币。

![BTC204](assets/en/67/01.webp)

钱包软件上显示的地址还包括一个 HRP（*人可读部分*），通常是后 SegWit 地址的 `bc`、分隔符 `1`、版本号 `q` （SegWit V0）和 `p` （Taproot/SegWit V1）。此外，还添加了校验和，以确保地址在传输过程中的完整性和有效性。

最后，将地址输入标准格式：


- Base58check 用于旧的传统地址；
- Bech32 用于 SegWit 地址；
- 用于 Taproot 地址的 Bech32m。

下面是以 10 为基数的 bech32 和 bech32m 格式（SegWit 和 Taproot）的加法矩阵：

| + | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| 0 | q | p | z | r | y | 9 | x | 8 |

| 8 | g | f | 2 | t | v | d | w | 0 |

| 16 | s | 3 | j | n | 5 | 4 | k | h |

| 24 | c | e | 6 | m | u | a | 7 | l |

### 什么是地址重用？

地址重用是指使用相同的接收地址来阻塞多个不同的 UTXO。

正如我们在上一节中看到的，每个UTXO 都有自己的 ScriptPubKey，它锁定了UTXO，必须满足这个条件，UTXO 才能作为新事务的输入被使用。正是在这个 ScriptPubKey 中集成了接收地址（有效载荷）。

当不同的 ScriptPubKeys 包含相同的接收地址时，这就是所谓的地址重复使用。实际上，这意味着用户多次向发送者提供相同的地址，通过多次支付来接收比特币。事实上，这种做法会对你的隐私造成灾难性的影响。

### 为什么地址重复使用是个问题？

由于区块链是公开的，因此很容易看到哪些地址锁定了哪些 UTXO 以及有多少比特币。如果同一个地址被用于多次交易，就有可能推断出与该地址相关的所有比特币都属于同一个人。这种做法允许在不同交易之间建立确定性链接，并在区块链上追踪比特币，从而损害了用户的隐私。中本聪本人也在《比特币白皮书》中强调了这一问题：

> *作为额外的防火墙，可以为每笔交易使用一对新的密钥，以防止它们被链接到一个共同的所有者*。
![BTC204](assets/notext/34/02.webp)

资料来源S. Nakamoto，《比特币：点对点电子现金系统》，https://bitcoin.org/bitcoin.pdf，2009 年。

中本聪在此声明中寻求的目标是，在用户身份与比特币上的一对密钥发生关联的情况下，创建一个额外的防火墙，以避免他们的所有活动都与他们的身份公开关联。如今，随着链分析公司和 KYC 法规的激增，使用唯一地址不再是 "额外的防火墙"，而是任何希望将自己的隐私保护到最低限度的人的必要做法。

当您重复使用一个地址时，您就在与该地址相关的所有交易之间建立了几乎不可否认的联系。虽然这不会直接危及你的资金，因为椭圆曲线加密法确保了你的私人密钥的安全，但它为监控你的活动提供了便利。事实上，任何拥有节点的人都可以观察到地址的交易和余额，从而完全破坏了您的匿名性。

![BTC204](assets/en/34/01.webp)

为了说明这一点，让我们以鲍勃为例，他经常通过 DCA（平均美元成本法）购买少量比特币，并总是将它们发送到同一个地址。两年后，这个地址已经有了大量的比特币。如果鲍勃使用这个地址向本地商家付款，后者就可以看到所有相关资金，并推断出鲍勃的财富。这可能会导致个人安全风险，包括盗窃或勒索企图。如果鲍勃使用一个全新的地址来接收每次定期购买，他向商家透露的信息就会大大减少。

在链分析中，我们将地址重用分为两种类型：


- 外部再利用；
- 交易内部重复使用。

第一种是当一个地址在多个不同的比特币交易中重复使用时观察到的。这就是我们之前讨论过的：通过这种启发式方法，我们可以推断出通过该地址的所有UTXO都属于一个实体。

内部地址重用不是发生在多个事务中，而是发生在同一事务中。事实上，如果用于锁定输入的同一地址在交易中被用作输出，那么我们可以推断出该输出仍属于同一用户（变更），而第二个输出代表实际付款。通过这种启发式方法，我们可以跟踪多个交易中的资金。

![BTC204](assets/en/33/02.webp)

地址重复使用是比特币的真正祸害。根据网站 OXT.me（目前无法访问）的数据，2022 年比特币地址重复使用的总体比率约为 52%：

![BTC204](assets/notext/41/02.webp)

这一比例虽然巨大，但绝大多数来自交换平台，而非个人用户。

### 如何避免地址重复使用？

避免地址重复使用非常简单： **只需在每次向钱包付款时使用一个新的地址**。

得益于 BIP32，现代钱包现在是确定性和分层的。这意味着用户可以从单一的初始信息（种子）中生成大量地址。通过保存这一条信息，就可以还原钱包的所有私钥，从而获得相应地址的资金。

![BTC204](assets/notext/41/03.webp)

这就是为什么当您在钱包软件中按下 "*接收*"按钮时，每次都会向您提供一个未使用的接收地址。在这个地址上接收比特币后，软件会自动建议一个新的地址。

> *PS: 最近，一些钱包软件宣布打算停止生成空白地址，因为它们担心这会被当局视为一种洗钱形式。如果您的软件也在其中，我强烈建议您立即更换，因为这对用户来说是不可接受的*。
如果您需要一个静态标识符来接收付款，例如接收捐款，建议不要使用传统的比特币地址，因为存在重复使用的风险。如果您更喜欢使用闪电地址，或者需要静态链上支付标识符，可以选择 BIP47 或静默支付。这些协议的操作详见本培训的第 6 部分。

## 标签和硬币控制

<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

正如我们在链分析部分所发现的，有许多启发式方法和模式可用于推断交易信息。作为用户，必须了解这些技术，以便更好地保护自己。

这就需要对自我保管的钱包进行严格管理，包括了解UTXO的来源，以及在支付过程中深思熟虑地选择要消耗的UTXO。这种有效的钱包管理依赖于优秀比特币钱包的两个重要特征：标签和硬币控制。

在本章中，我们将研究这些功能，并了解如何在不增加太多工作量的情况下智能地使用它们，从而大大优化比特币上的隐私。

### 什么是标签？

贴标签是一种为比特币钱包中的特定UTXO分配注释或标签的做法。这些注释由钱包软件本地存储，绝不会通过比特币网络传输。因此，贴标签是一种个人管理工具。

例如，如果我通过 Charles 在 Bisq 上以 P2P 方式购买了一个 UTXO，我可以给它贴上"`Non-KYC Bisq Charles`"的标签。

贴标签是一种良好的做法，有助于记住UTXO的来源或预定目的地，从而方便资金管理和优化隐私保护。事实上，您的比特币钱包可能有多个UTXO。如果这些UTXO的来源不同，您可能不希望将来合并这些UTXO，否则就会暴露它们的共同所有权。通过正确标记您的所有硬币，您可以确保在需要使用它们时，即使只是在几年后，也能记住它们的来源。

### 什么是硬币控制？

如果在钱包软件中加入硬币控制选项，标签的主动使用将变得更加有趣。

币值控制是优秀比特币钱包软件的一项功能，可以手动选择特定的UTXO作为输入来执行交易。事实上，要满足输出支付，就必须消耗一个UTXO 作为输入作为回报。出于一些原因（我们稍后会看到），您可能希望精确地选择要消耗哪些硬币作为输入，以满足给定的付款要求。这正是硬币控制所能实现的。打个比方，这一功能类似于您在支付法棍面包时在钱包中选择特定硬币的操作。

![BTC204](assets/notext/42/01.webp)

通过使用带有硬币控制功能的钱包软件，再加上UTXO 的标签，用户可以区分并精确选择用于交易的 UTXO。

### 如何正确标注UTXO？

UTXO 的标签没有适合所有人的通用方法。您可以自己确定一个标签系统，这样您就可以很容易地找到您的钱包。无论如何，请记住，好的标签是您在需要时能够理解的标签。如果你的比特币钱包主要用于储蓄，那么这些标签可能几十年后才会对你有用。因此，要确保标签清晰、准确、全面。

重要的是，如果有一天您的亲人需要使用您的钱包，他们可以很容易地识别资金的来源。这不仅可以帮助他们保护隐私，还可以帮助他们在法律面前证明资金的来源。

标签最重要的一点是注明UTXO 的来源。您只需说明这枚硬币是如何进入您的钱包的。是在交易所平台上购买的？客户付款？点对点交易所？还是购买后的零钱？因此，您可以说明


- `Withdrawal Exchange.com`；
- 付款客户 David`；
- P2P购买查尔斯；
- 购买沙发后的变化

![BTC204](assets/en/42/02.webp)

为了细化您对UTXOs的管理，并在钱包中坚持您的基金隔离策略，您可以在标签中添加一个额外的指标，以反映这些分离情况。如果您的钱包中包含两类UTXO，而您不希望将它们混在一起，您可以在标签中加入一个标记，以明确区分这两类UTXO。这些分隔标记将取决于您自己的标准，例如区分来自涉及 KYC 的收购流程的 UTXO，或区分专业资金和个人资金。以前面提到的标签为例，这可以转化为：


- KYC - Withdrawal Exchange.com"；
- KYC - 支付客户 David"；
- 无 KYC - P2P 购买查尔斯"；
- 无 KYC - 沙发购买变更

![BTC204](assets/en/42/03.webp)

此外，建议在整个交易过程中永久保留硬币的标签。例如，在合并无 KYC UTXO 时，确保不仅将生成的 UTXO 标记为 "合并"，而且特别标记为 "无 KYC 合并"，以保持钱币来源的清晰痕迹。

最后，并不是必须在标签上标注日期。大多数钱包软件都会显示交易日期，在区块资源管理器上也可以通过 TXID 检索到该信息。

### 如何正确选择硬币？

在进行交易时，金币控制允许您具体选择消耗哪些UTXO 作为输入，以满足支付的输出。在选择时应考虑两个方面：


- 收款人有可能将您的部分身份与作为输入的 UTXOs 联系起来；
- 外部观察者在作为输入消耗的所有UTXO之间建立联系的能力。

为了说明第一点，让我们举一个具体的例子。假设你用比特币从当地面包师那里买了一根法棍。你用自己拥有的一个或多个UTXO作为输入，至少可以支付法棍的输出价格以及交易费用。面包师可能会把你的脸或他们知道的你身份的任何其他部分与作为输入的硬币联系起来。知道了这种联系的存在，您在付款时可能会选择特定的 UTXO 而不是其他。

![BTC204](assets/notext/42/04.webp)

例如，如果您的一个UTXO来自一个交易所平台，而您希望面包师不知道您在这个平台上的账户，那么您就会避免使用这个UTXO付款。如果你拥有一个高价值的UTXO，显示了大量的比特币，你也可以选择不使用它，以防止面包师知道你的 BTC 财富。

因此，选择用于第一点的UTXO是基于个人的决定，受你是否愿意透露信息的影响。你在收到UTXO时给它们贴上的标签将帮助你选择那些一旦使用后只暴露你愿意向接收者透露的信息的UTXO。

除了可能透露给接收者的信息外，输入的选择也会影响您向区块链所有观察者披露的信息。事实上，根据共同输入所有权启发式（CIOH），如果使用多个UTXO作为交易输入，就会暴露出这些UTXO为同一实体所有。

![BTC204](assets/notext/42/05.webp)

因此，在选择硬币时，您必须意识到您即将进行的交易将在所有使用的 UTXO 之间建立链接。这种链接可能会对您的个人隐私造成影响，尤其是当UTXO来自不同来源时。

![BTC204](assets/notext/42/06.webp)

让我们回到 Bisq 的无 KYC UTXO 的例子；我希望避免将它与来自受监管交易所平台的 UTXO 结合使用，比如说，来自一个知道我身份的受监管交易所平台的 UTXO。事实上，如果我在同一笔交易中使用这两个UTXO 作为输入，受监管平台就能将我的身份与我在 Bisq 上购买的 UTXO 联系起来，而之前它并没有与我的身份联系起来。

![BTC204](assets/notext/42/07.webp)

最后，要正确选择使用哪些UTXO 作为交易输入，最重要的是避免使用多个UTXO。在可能的情况下，选择一个足够大的币来支付。这样做可以完全避免 COINJOIN 带来的风险。但是，如果单个 UTXO 不足以支付，而您必须使用多个 UTXO，则应确保它们的来源相似，以尽量减少不必要链接的风险。此外，请记住，收件人可能会将他们掌握的您的信息与作为输入的硬币的历史记录联系起来。

### 了解自动硬币选择

在前面的章节中，我们讨论了交易中手动选择UTXO 的问题。但如果钱包软件自动选择UTXO，会发生什么情况呢？有几种方法可以决定消耗哪些币，而选择UTXOs是比特币的一个真正研究领域。这种自动过程的主要目的通常是尽量减少用户的交易费用。

UTXO选择方法，如FIFO（*先进先出*）和LIFO（*后进先出*）是最简单但效率最低的方法。使用先进先出法时，钱包中最老的硬币会被优先使用。除了使用相对时间锁且必须定期更新的情况外，这种方法在最大限度降低交易费用和保护隐私方面通常效率较低。相反，后进先出优先使用最近的UTXO。这两种方法虽然简单，但往往被证明效率低下。

更先进的方法是*Knapsack Solver*。在 0.17 版之前，比特币核心钱包一直使用这种方法。它包括从钱包中随机迭代选择UTXO，将它们以子集的形式相加，并保留尽可能降低交易权重的解决方案，以减少用户的费用。

从 0.17 版开始，比特币核心中的 *Branch-and-Bound* (BNB) 算法（通常因其发明者而被昵称为 "默奇算法"）取代了 *Knapsack Solver* 算法。这种更先进的方法旨在找到一组UTXO，与满足交易输出所需的金额完全匹配。BNB 的目标是通过减少所谓的 "浪费标准"（该标准考虑了当前成本和未来预期成本），最大限度地减少变动金额和费用。这种方法源自艾尔莎-兰德和艾莉森-哈考特于 1960 年设计的*分支与边界*的原始概念，与*卡纳帕克求解器*相比，它能更精确地优化费用。

所有这些自动UTXO选择方法都能有效降低交易费用，但在保护用户隐私方面往往效率低下。事实上，这些算法可以将多个UTXO合并为输入，从而揭示出这些UTXO的共同所有权，因为COH。显然，这些方法无法考虑到UTXO所附的标签，而这些标签对于有意识地选择向交易接收者披露的硬币至关重要。目前，在选择硬币时优化隐私的唯一解决方案就是手动选择。

### UTXO标记教程

如果你想学习如何给你的UTXO贴标签，我们在现有的主要比特币钱包软件上创建了一个完整的教程：

https://planb.network/tutorials/privacy/on-chain/utxo-labelling-d997f80f-8a96-45b5-8a4e-a3e1b7788c52
## KYC 和关键识别

<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>

KYC 是 "了解你的客户 "的缩写，是在比特币领域运营的一些公司实施的一项监管程序。该程序旨在核实和记录客户身份，以达到打击洗钱和恐怖主义融资的目的。

具体来说，KYC 涉及收集客户的各种个人资料，这些资料因司法管辖区而异，但一般包括身份证件、照片和居住证明。然后对这些信息进行核实和保存，以备将来使用。

在大多数西方国家，所有受监管的兑换平台都必须履行这一程序。这意味着，任何希望通过这些平台用法定货币兑换比特币的人都必须遵守 KYC 要求。

这一程序对用户的保密性和安全性并非没有风险。在本章中，我们将详细研究这些风险，并分析 KYC 和身份识别程序对比特币用户隐私的具体影响。

### 促进链上跟踪

与 KYC 相关的第一个风险是，它为链分析提供了一个特权切入点。正如我们在上一部分所看到的，分析师可以利用交易模式和启发式方法对区块链上的活动进行分组和跟踪。一旦他们设法对用户的链上活动进行分组，只需在用户的所有交易和密钥中找到一个切入点，就足以完全泄露用户的隐私。

![BTC204](assets/notext/43/1.webp)

当你接受 KYC 时，你就为链分析提供了一个非常高质量的切入点，因为你将你从交易所平台提取比特币时使用的接收地址与你完整且经过验证的身份联系起来。理论上，这些信息只有你提供信息的公司知道，但正如我们稍后将看到的，数据泄露的风险是真实存在的。此外，即使公司不共享这些信息，仅仅是公司掌握这些信息这一事实也会带来问题。

因此，如果您不采取其他措施限制您在区块链上的活动分组，任何知道 KYC 这个入口的人都有可能将您在比特币上的所有活动与您的身份联系起来。因此，从这家公司的角度来看，你使用比特币就失去了所有的保密性。

![BTC204](assets/notext/43/2.webp)

为了说明这一点，我们可以做一个比较，就好像你在 X* 银行的银行职员不仅能看到你在 X* 银行的所有交易，还能看到你在 Y* 银行的交易以及你的所有现金交易。

请记住本培训第一部分的内容：中本聪设计的比特币隐私模式依赖于用户身份和密钥对之间的分离。尽管这层隐私在今天已不再足够，但尽可能限制其退化仍是明智之举。

### 接受国家监督

KYC 的第二个主要问题是，它会向国家透露你曾经拥有过比特币。当你通过受监管的行为者购买比特币时，国家就有可能知道你拥有比特币。目前，这似乎微不足道，但重要的是要记住，国家的政治和经济未来并不掌握在你的手中。

首先，国家可以迅速采取专制立场。历史上政策突然改变的例子比比皆是。今天，在欧洲，比特币爱好者可以撰写关于比特币的文章，参加会议，并自我保管他们的钱包。但谁能说得准明天会发生什么呢？如果比特币突然成了头号公敌，那么在国家记录中与之相关联就会成为问题。

接下来，面对严重的经济危机，国家可能会考虑没收公民持有的比特币。也许明天，比特币持有者就会被视为危机中的暴发户，面对法定货币贬值，他们会因为资本收益而被课以重税。

你可能认为这不是问题，因为你的比特币是混合的，因此无法追踪。然而，追踪并不是问题所在。真正的问题是国家知道你拥有比特币。这个简单的信息就足以指控你或要求你提供一个账户。你可以说你花掉了你的比特币，但这应该反映在你的纳税申报单上，你会被发现的。你也可以说你在一次划船事故中丢了钥匙，但除了在 Twitter 上闹笑话之外，你真的认为这足以为你开脱罪责吗？

因此，重要的是要考虑国家可能知道您拥有 BTC 这一事实所带来的风险，即使这种风险在今天看来可能很遥远。

在国家监控方面，KYC 带来的另一个问题是受监管平台的强制报告。虽然我不熟悉其他司法管辖区的法规，但在法国，*数字资产服务提供商*（PSAN）必须向金融监督机构报告他们认为可疑的任何资金流动。

因此，在 2023 年的法国，公共安全网报告了 1 449 起可疑行为。目前来看，这些行为大多与犯罪有关。然而，当局也要求受监管的平台报告任何仅基于其结构的可疑比特币交易。如果你进行了合作交易，甚至只是出现了某种非典型模式的交易，而这种交易又发生在你从这些平台上提取比特币的附近，你就会发现自己被报告给了当局。即使你没有不法行为，而且合法行使了你的权利，这种举报也可能导致检查和监视的增加，而如果没有 KYC，你本可以避免这些不便。

### 个人数据泄露的风险

KYC 的另一个问题在于，它要求将您的所有个人数据存储在一家私营公司的服务器上。最近发生的事件提醒我们，无论是金融还是信息技术方面的故障，没有人能够幸免。2022 年，Celsius 的客户就遭受了这样的后果。公司破产后，美国司法系统在行政程序中公布了债权人的姓名及其资产数额。

两年多前，加密货币领域一家领先的网络安全实体遭遇了客户个人数据被盗事件。虽然这一事件与购买比特币没有直接关系，但对于交易所平台来说，这样的风险同样存在。因此，这些个人数据存在一定的风险。

诚然，我们已经将很多个人数据委托给了私人公司。然而，这里的风险是双重的，因为这些数据不仅可以识别你的身份，还与比特币活动相关联。事实上，当黑客设法获取交易所平台客户的数据时，他们有理由认为这些客户拥有比特币。因此，比特币和其他任何有价值的资产一样，都会引起盗贼的兴趣，从而加剧了这种风险。

如果发生数据泄露，最好的情况是，您可能成为有针对性的网络钓鱼企图的目标。在最坏的情况下，您可能会发现自己的家庭受到物理威胁。

除了与比特币有关的具体风险外，还有必要考虑与传输身份证件有关的危险。事实上，在数据泄露的情况下，有可能成为身份盗窃的受害者。因此，其利害关系不仅限于保护交易的机密性，还关系到每个人的人身安全。

### 关于 KYC 的常见误解

我们有必要揭穿一些关于 KYC 的常见误解，这些误解经常出现在 Twitter 上或比特币玩家的讨论中。

首先，认为保护通过 KYC（了解你的客户）获取的比特币的隐私是徒劳的想法是不正确的。保护比特币隐私的工具和方法多种多样，目的也各不相同。例如，在 KYC 比特币上使用 Coinjoin 交易并不是一个坏主意。当然，使用受监管的交易所平台时必须谨慎，以避免账户被冻结或封禁，但从严格的技术角度来看，这些做法并不冲突。Coinjoin 具有打破币的历史记录的效果，可以帮助你抵御与 KYC 相关的一些链分析风险。虽然这并不能消除所有风险，但它已经带来了很大的好处。

![BTC204](assets/notext/43/3.webp)

比特币的隐私不应被二元对立地视为 "匿名 "比特币与非匿名比特币之间的区别。拥有通过 KYC 获取的比特币并不意味着一切都失去了意义；相反，使用隐私工具可能会带来更多好处。

相反，通过非 "KYC "方式获取比特币并不能保证完美的隐私，也不能免除采取其他保护措施的需要。如果你持有非 KYC 比特币，但多次重复使用接收地址，你的交易就会被追踪和分组。与比特币以外的世界的一丁点联系，都可能危及你仅有的一层隐私。因此，重要的是将所有改善比特币隐私的工具和方法视为互补。每种技术都能解决特定的风险，并能增加一层额外的保护。因此，拥有非 KYC 比特币绝对不能免除采取其他预防措施。

### KYC 可以撤销吗？

有时有人问我，在完成 KYC 之后是否还可以 "回头"，从前面的段落可以想象，答案是有细微差别的。要避免 KYC 带来的风险，最简单的方法就是在获取比特币时不要使用它。我们将在下一章深入探讨这个话题。但是，如果已经进行了 KYC 并购买了比特币，是否有办法降低所产生的风险呢？

关于交易的可追溯性风险，使用 Coinjoin 是一种解决方案。我们将在稍后的培训中详细讨论这种方法，但请注意，coinjoin 会破坏一个币的历史记录，并阻止其过去-现在和现在-过去的追踪。即使是通过受监管平台获得的 BTC，这种技术也会阻止其可追溯性。

然而，coinjoin 并不能消除与 KYC 相关的第二种风险：国家被告知你持有的比特币。事实上，即使你的比特币不再可追踪，国家（取决于司法管辖区）也有可能获得你的加密资产处置声明。由于这种风险不是技术性的，而是行政性的，因此，除了最初不把自己暴露在 KYC 的风险之外，没有专门针对比特币的解决方案来消除这种风险。降低这种风险的唯一合法方法是在受监管的平台上出售通过受监管平台获得的比特币，然后通过不需要 KYC 的方式回购。通过出售和申报处置，管理部门应注意到您已不再拥有这些比特币。

至于个人数据和身份证件泄露的风险，这是比特币的外部危险，没有技术手段可以避免。一旦你的数据被泄露，就很难逆转这一操作。你可以尝试关闭平台上的账户，但这并不能保证删除你的 KYC 数据，尤其是在身份验证外包的情况下。验证是否完全删除您的信息是不可能的。因此，没有任何解决方案可以完全防止这种风险并确保其不复存在。

### KYC 与关键识别的区别

有时，一些比特币玩家倾向于将 "KYC "一词延伸到任何涉及转账或信用卡支付的 BTC 交易所，因为这些手段也可以像 KYC 一样揭示支付的来源。然而，重要的是不要混淆 KYC 和关键识别。就我个人而言，我必须承认，随着时间的推移，我对这个问题的认识也在不断变化。

KYC 特指一些公司为验证和记录客户身份而实施的监管程序。这是个二进制问题：在获取比特币时，要么接受 KYC，要么不接受。然而，关键识别涉及将用户身份的某个方面与链上活动联系起来，并非二元对立，而是一个连续体。事实上，在获取或处置比特币的过程中，这种身份识别总是可以在不同程度上实现。

例如，如果您在瑞士受监管的平台上购买比特币，KYC（了解您的客户）就不是必须的。不过，由于是通过银行账户购买的，因此可能会对你的密钥进行识别。这时，与 KYC 相关的前两个风险--促进链上跟踪和暴露于国家监控--也会在非 KYC 交易所中体现出来。如果瑞士实体向您所在国家的当局报告可疑交易，他们只需检查用于购买的银行账户，就能发现您的身份。因此，在受监管的平台上购买而不进行 KYC，在关键识别的风险等级上是相当高的。

![BTC204](assets/notext/43/4.webp)

但是，避开受监管的平台，选择 P2P（点对点）收购方式并不能完全消除密钥识别的风险，而只能降低风险。以在 Bisq 或其他 P2P 平台上购买为例。与交易对手结算时，您可能会使用银行账户。如果当局询问与您交易的人并询问您的姓名，我们就会遇到前面提到的风险 1 和 2。当然，这些风险比在平台上进行非 KYC 购买时要低得多，甚至比进行 KYC 购买时要低得多，但在一定程度上仍然存在。

![BTC204](assets/notext/43/5.webp)

最后，即使你通过现金实物交换获得比特币，你也不是完全匿名的。与你交易的人看到了你的脸，这是你身份的一部分。虽然在这个例子中，这种可能性微乎其微，但仍然存在关键识别的可能性。

![BTC204](assets/notext/43/6.webp)

总之，在用比特币兑换其他资产的过程中，无论是购买法定货币还是出售实物，总会有某种形式的密钥识别。根据所选择的兑换方式，这种识别的强度会有所不同。重要的是，不要将这种识别与 KYC 混为一谈，后者是一种定义明确的监管流程。不过，KYC 和识别范围之间有联系，因为 KYC 是识别范围的高端，因为它系统地促进了当局对用户密钥的识别。

## 销售和采购方法

<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>

读完上一章后，你可能会想知道有什么方法可以在不进行身份验证的情况下买卖比特币，以规避与 "KYC "相关的风险。有几种方法可以进行交换。

### P2P 现金交易所

正如我们所看到的，就隐私而言，最好的方法仍然是采用现金结算的点对点（P2P）交换。这种方法可以最大限度地减少留下的痕迹，并大大降低关键识别的可能性，无论你是买方还是卖方。

![BTC204](assets/notext/44/01.webp)

然而，这种做法存在人身安全风险。主要的危险在于，在交换过程中，对方会知道你持有大量现金或比特币。这些信息可能会引起坏人的注意。因此，一般建议对持有的比特币保持谨慎。这一建议也适用于现金。不过，在当面交换的过程中，不可避免地会暴露自己拥有比特币，这可能会引起他人的觊觎。

![BTC204](assets/notext/44/02.webp)

为了限制这种风险，我建议你优先与可信赖的人进行现金交易，比如家庭成员或亲密朋友。或者，你也可以考虑在[本地比特币聚会](https://btcmap.org/communities/map)上进行交换，在参加过几次之后。这样，你就可以更好地了解其他参与者，在实物交换时也不会感到孤单。然而，重要的是要认识到，P2P 现金交易所固有的人身安全风险是通过受监管的平台和银行账户进行购买所不存在的。

此外，根据你居住的地方，无论是比特币还是现金，携带和存储大笔资金都可能带来风险。

现金兑换也会在警方检查或其他情况下带来法律风险。虽然大多数国家对随身携带的现金数额没有限制，但数额过大可能会引起怀疑。因此，一定要小心谨慎，尤其是在必须长途旅行的情况下，避免一次性进行过大的交易，以免为持有大额现金进行辩解。

最后，P2P 购买的另一个缺点是价格往往高于受监管平台的价格。卖家通常会加价 1%，有时甚至超过 10%。造成这种价格差异的原因有几个。首先，这是 P2P 卖家长期以来形成的普遍做法。其次，卖方向买方发送资金需要支付交易费用。与平台上的交易相比，P2P 销售中的盗窃风险也会增加，因此有理由对所承担的风险进行补偿。最后，附加费可能与交易所在隐私方面的需求和质量有关。作为买方，隐私权的获得是有代价的，这体现在卖方的加价上。一些比特币玩家还认为，在 P2P 上购买的 BTC 价格上涨反映了其真实价值，并认为监管平台上较低的价格是对个人数据隐私妥协的结果。

![BTC204](assets/notext/44/03.webp)

### 通过匹配平台进行 P2P 交流

就个人安全而言，风险较低的另一种选择是通过 PayPal、银行转账或 Revolut 等电子支付方式，完全在网上进行 P2P 交换。

![BTC204](assets/notext/44/04.webp)

这种方法有助于避免与现金交易相关的许多风险。不过，在网上交易中，交易方不履行承诺的风险更大。事实上，在实物交换中，如果你把钱交给卖方，而卖方没有把比特币还给你，你可以立即追究他们的责任，因为他们就在你面前。而在网上，往往不可能找到偷你钱的人。

![BTC204](assets/notext/44/05.webp)

为了降低这种风险，可以使用专门为 P2P 交换进行匹配的平台。这些平台使用冲突解决机制来保护受害用户。一般来说，它们提供一个托管系统，在卖方确认法定货币支付之前，比特币将被托管在该系统中。

![BTC204](assets/notext/44/06.webp)

就个人安全而言，这种购买方式要比实物现金交易安全得多。然而，如前所述，在线 P2P 交易所比实体交易所留下更多痕迹，这可能会损害比特币的隐私。通过使用像银行这样的在线法币支付方式，你会暴露出更多的信息，这些信息可能有助于识别密钥。

![BTC204](assets/notext/44/07.webp)

我再次建议不要在这些平台上进行单笔大额交易。通过拆分交易，您可以分散与交易对手潜在盗窃相关的风险。

再次，P2P 购买的另一个弊端是价格往往高于受监管平台的价格。卖家通常会加价 1%，有时甚至超过 10%。造成这种价格差异的原因有几个。首先，这是 P2P 卖家长期以来形成的普遍做法。其次，卖方向买方发送资金需要支付交易费用。与平台上的交易相比，P2P 销售中的盗窃风险也会增加，因此有理由对所承担的风险进行补偿。最后，附加费可能与交易所在隐私方面的需求和质量有关。作为买方，隐私权的获得是有代价的，这体现在卖方的加价上。一些比特币玩家也认为，通过 P2P 购买的 BTC 价格上涨反映了其真实价值，并认为监管平台上较低的价格是对个人数据隐私妥协的结果。

![BTC204](assets/notext/44/03.webp)

关于解决方案，我个人一直使用 [Bisq](https://bisq.network/)，并对其非常满意。他们的系统很完善，看起来也很可靠。不过，Bisq 只能在个人电脑上使用，其界面对于初学者来说可能过于复杂。另一个缺点是，Bisq 只使用链上交易，在比特币交易费用高昂的时期，这可能会变得很昂贵。

-> 了解我们的 Bisq 教程。

https://planb.network/tutorials/exchange/peer-to-peer/bisq-fe244bfa-dcc4-4522-8ec7-92223373ed04
如果想选择更简单的方法，您可以试试 [Peach](https://peachbitcoin.com/)，这是一款移动应用程序，通过集成的争议解决系统促进买卖双方之间的联系。该程序比 Bisq 更直观。

-> 探索我们的桃子教程。

另一个在线选择是 [HodlHodl](https://hodlhodl.com/)，这是一个成熟的平台，提供良好的流动性，不过我没有亲自测试过。

-> 了解我们的 HodlHodl 教程。

https://planb.network/tutorials/exchange/peer-to-peer/peach-wallet-db64fe42-17ca-4b24-abb8-e7d4c03b2028
https://planb.network/tutorials/exchange/peer-to-peer/hodlhodl-d7344cd5-6b18-40f5-8e78-2574a93a3879
关于基于闪电网络的解决方案，您可以试试 [RoboSats](https://learn.robosats.com/) 和 [LNP2PBot](https://lnp2pbot.com/)。RoboSats 可通过网站访问，使用相对简单。LNP2PBot 则比较非典型，因为它是通过 Telegram 消息应用程序上的交换系统运行的。

-> 了解我们的机器人卫星教程。

-> 了解我们的 LNP2PBot 教程。

https://planb.network/tutorials/exchange/peer-to-peer/robosats-b60e4f7c-533a-4295-9f6d-5368152e8c06
https://planb.network/tutorials/exchange/peer-to-peer/lnp2pbot-v2-e6bcb210-610b-487d-970c-7cce85273e3c
![BTC204](assets/notext/44/08.webp)

### 无 KYC 的受监管平台

根据你所居住的国家，你可能可以使用不需要 KYC 程序的受监管平台来购买或出售比特币。例如，在瑞士，您可以使用 [Relai](https://relai.app/) 和 [MtPelerin](https://www.mtpelerin.com/) 等平台。

-> 了解我们的 Relai 教程。

https://planb.network/tutorials/exchange/centralized/relai-v2-30a9671d-e407-459d-9203-4c3eae15b30e
正如我们在上一章所看到的，这类平台可以避免与 KYC 程序相关的风险，但它们的密钥识别风险较高。因此，在比特币的隐私保护方面，这些平台提供的保护要好于 KYC 购买方式，但不如 P2P 交易所有趣。

不过，就个人安全而言，使用这些平台的风险要比 P2P 交易所小得多。这些平台的使用通常也比促进 P2P 交易所的平台简单。

### 自动取款机

另一种无需 KYC 就能买卖比特币的方法是加密货币自动取款机（ATM）。就我个人而言，我还从来没有机会测试过这种解决方案，因为在我的国家还没有。但这种方法可能非常有趣，这取决于你住在哪里。

![BTC204](assets/notext/44/09.webp)

自动取款机的问题在于，有些国家禁止使用自动取款机，有些国家则对其进行严格监管。如果自动取款机要求进行身份验证，那么它就会面临与受监管的 KYC 平台相同的固有风险。但是，如果自动取款机允许小额交易而无需身份验证，那么使用自动取款机可以提供与基于现金的 P2P 交易所相当的隐私水平，同时避免与这类交易所相关的大部分风险。

自动取款机的主要缺点是兑换手续费通常很高，从兑换金额的几个百分点到 15%不等。

### 礼品卡

最后，我还想介绍一种解决方案，对于那些希望日常使用比特币购物而不是将比特币出售换取法定货币的人来说，这种方案非常适用。

使用比特币的最佳方式显然是直接使用比特币或闪电网络购买商品或服务。然而，在许多国家，接受比特币的商家数量仍然有限。因此，使用礼品卡是一种实用的替代方法。

一些不需要 KYC 程序的平台提供将比特币兑换成礼品卡的可能性，这些礼品卡可以在各大商店使用。在这些平台中，我们可以找到[CoinsBee](https://www.coinsbee.com/)、[The Bitcoin Company](https://thebitcoincompany.com/)和[Bitrefill](https://www.bitrefill.com/)。这些平台极大地方便了比特币的日常使用，让你无需兑换成法定货币，就能获得各种产品和服务。

https://planb.network/tutorials/exchange/centralized/bitrefill-8c588412-1bfc-465b-9bca-e647a647fbc1
![BTC204](assets/notext/44/10.webp)

### 其他获取方法

在保护个人隐私的同时获取比特币的其他方法中，显然还有挖矿。要开始开采比特币，无需暴露身份；只需找到有效的工作证明并提交给网络即可。如果你选择矿池挖矿，有些矿池需要某种形式的身份证明，如 KYC，而有些则不需要。

另一种方法是以工作换取比特币。这种获取方法可能很有趣，但所需的识别程度因情况不同而有很大差异。

*为了撰写本章，我使用了 [@pivi___](https://x.com/pivi___) 在 Plan ₿ Network 上创建的 BTC205 课程（目前只有法语版本）。*

## 合并、UTXO 管理和 CIOH

<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>

当你拥有自己保管的钱包时，最复杂的管理问题之一无疑是合并。要不要合并？目的是什么？UTXO的规模是多少？在隐私方面如何取舍？这就是我们本节要探讨的问题。

### 什么是合并？

比特币的运作类似于拍卖市场，矿工们会优先考虑提供最优惠费用的交易。不过，每个区块都有一个最大权重，限制了可包含的交易数量。由于平均每 10 分钟产生一个区块，因此每个区块中的可用空间都是稀缺资源。

矿工的活动会产生大量的电力、资本和维护成本，自然会寻求利润最大化。他们倾向于选择能给他们带来相对于其权重最多费用的交易。

事实上，并非所有比特币交易的重量都一样。那些有更多输入和输出的交易会更重。例如，考虑 2 笔交易：


- 交易 A 包括 1 个输入和 1 个输出。它分配了 1 994 sats 的费用，权重为 141 vB；
- 交易 B 更为复杂，有 2 个输入和 2 个输出，分配 2 640 sats 的费用，权重为 220 vB。

![BTC204](assets/notext/45/01.webp)

在这个例子中，虽然交易 B 提出的总费用更高，但矿工们会倾向于交易 A，因为它在费用和权重之间提供了更好的比率。以下是每笔交易的计算结果，以每个虚拟字节（sat/vB）表示：

```text
TXA: 1994 / 141 = 14 sats/vB
TXB: 2640 / 220 = 12 sats / vB
```

这意味着，对于每个权重单位，交易 A 提供的费用比交易 B 多，尽管后者提供的费用绝对值更大。

![BTC204](assets/notext/45/02.webp)

因此，对用户来说，在交易中尽可能消耗最少的投入总是更有意义的。但是，必须消耗足够的数量才能满足输出支付。因此，在管理钱包时，必须有足够大的 UTXO。

合并的原则正是利用比特币手续费较低的时期，将自己的小型UTXO合并成一个较大的UTXO。这样，当比特币手续费上涨时，就可以用最少的投入进行交易，从而减少绝对手续费的支出。这样做的目的是为了在高费用时期进行必须的交易。

![BTC204](assets/en/45/03.webp)

除了节省交易费用外，合并UTXOs 还有助于避免产生 "灰尘"。灰尘 "指的是UTXO，其在萨特中的价值非常低，不足以支付使用这些UTXO所需的交易费用。因此，只要交易费居高不下，使用这些UTXO在经济上就是不合理的。通过主动将UTXO分组，可以防止它们变成灰尘，确保所有资金仍然可用。

### UTXO的最小尺寸是多少？

有时，有人会问我，UTXO 的建议最低值是多少。遗憾的是，这并没有一个通用的答案，因为这取决于您的偏好和市场条件。不过，这里有一个公式，可以帮助您确定一个适合您需要的阈值：

$$
\frac {P \times F}T = M
$$

在哪里？


- P$ 是交易的权重；
- $F$ 代表您要支付的最高费率，单位为每 vbyte（sats/vB）；
- $T$ 是您愿意支付的交易费占 UTXO 总价值的百分比；
- $M$ 是每个UTXO 的最小值，单位为 satoshis。

假定您计划为 1 进 2 出的标准 SegWit 交易支付 141 vB 的费用。如果您最多支付 800 个 sats/vB，并且您最多愿意花费 UTXO 价值的 12% 作为费用，那么计算结果将是：

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

在这个例子中，明智的做法是将钱包中的UTXO最小值保持在940,000 sats。

### 合并与 COIH

链分析中最常用的启发式之一是 COIH（*共同输入所有权启发式*），它允许假设比特币交易的所有输入都属于同一个实体。准确地说，合并的原则是消耗多个UTXO作为输入，创建一个UTXO作为输出。因此，合并可以应用 COIH。

![BTC204](assets/notext/45/04.webp)

实际上，这意味着外部观察者可以推断出所有合并的 UTXO 很可能属于同一个人，并且生成的单一输出也属于他们。这种情况会将不同的交易历史记录联系起来，从而损害您的隐私。例如，假设我合并了通过 P2P 获取的 3 个 UTXO 和通过需要 KYC 的平台获取的一个 UTXO：

![BTC204](assets/notext/45/05.webp)

通过这种方式，任何可以访问交易所平台数据的实体，包括潜在的政府机构，都可以识别出我拥有其他数量的 BTC。以前，这些 UTXOs 与我的身份没有直接联系；现在，它们有了。此外，这也向所有消息来源透露了我拥有一定数量的比特币。

在管理 UTXOs 时，经济方面的考虑会推动合并以降低费用，因此会与良好的隐私保护做法相冲突，后者建议永远不要合并 UTXOs。因此，在经济性和隐私性之间做出选择取决于每个用户的优先级。

如果既能避免合并，又能保持相当大的 UTXO 规模，那就再好不过了。要做到这一点，就要优化你的购买方法。如果你在 DCA 中购买比特币，请尽量拉开一次性购买的距离，将价值集中到更少的 UTXO 中。每两个月一次性购买 1000 欧元比每周购买 120 欧元更容易管理。这样可以最大限度地减少产生的 UTXOs 数量，简化钱包管理，同时保护您的隐私。

如果您发现自己需要合并比特币，首先应优先合并同一来源的UTXO。例如，合并来自单一平台的 10 个UTXO 对个人隐私的影响要小于合并来自 A 平台的 5 个UTXO 和来自 B 平台的 5 个UTXO 对个人隐私的影响。例如，将通过 KYC 获取的 UTXOs 合并到一个交易中，将通过 P2P 获取的 UTXOs 合并到另一个交易中。

无论如何，请记住，任何合并都不可避免地会导致隐私权的丧失。因此，在考虑到风险的情况下，请仔细评估这一操作的必要性以及对您隐私的潜在影响。

## 其他良好做法

<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

让我们一起来探讨其他一些可以帮助你优化比特币隐私的好方法。

### 完整节点

拥有自我保管的比特币固然好，但使用自己的完整节点更好！以下是为什么拥有自己的节点对完全主权使用比特币至关重要：


- 抵制审查**：任何人都无法阻止您的交易；
- 独立于第三方**：您不再依赖任何外部服务来验证区块链数据；
- 积极参与**：您可以设置自己的验证规则，并直接参与达成共识；
- 对网络的贡献**：通过运行一个节点，你可以帮助加强和传播比特币网络；
- 技术教育**：管理一个完整的节点是加深你对比特币技术知识了解的绝佳途径。

除了这些好处，使用全节点还能提高您在发布交易时的隐私性。当你发布一笔交易时，它首先是通过你的钱包创建和签名的。要在比特币网络上广播它，必须至少有一个节点知道它。通过使用自己的节点，您可以直接控制这一广播，从而提高您的隐私性并限制数据泄漏的风险。

![BTC204](assets/notext/46/01.webp)

如果您没有自己的比特币节点，就不得不使用第三方的节点，如钱包软件供应商提供的节点。除了交易广播，您的钱包还需要访问各种信息，如待处理交易、与您的地址相关的余额或交易确认的数量。要访问所有这些数据，您需要查询一个节点。

![BTC204](assets/notext/46/02.webp)

当您不使用自己的比特币节点时，主要风险在于第三方节点的操作者可能会观察到您在区块链上的活动，甚至与其他实体共享这些信息。为了限制这种风险，一个中间解决方案是使用允许您通过 Tor 隐藏连接的钱包软件。这可以减少数据的暴露。然而，最佳的解决方案仍然是拥有自己的比特币节点，并用它来广播您的交易。显然，你还需要确保没有信息从你的节点泄露出去，但这是我们将在下文中探讨的另一个话题。

除了隐私方面的明显优势外，拥有自己的完整节点还能确保区块链上数据的真实性，防止审查，并让您积极参与比特币的治理。通过使用自己的节点，您可以为自己选择的链贡献自己的经济权重，这在社区内部发生冲突时非常重要，例如在 2015 年至 2017 年的 "区块链战争 "期间。在分叉的情况下，使用第三方的节点可能会导致您支持您不希望支持的链，因为节点运营商会替您做出选择。

正如您所理解的，出于对隐私和更广泛的个人主权的考虑，运行和使用自己的完整节点至关重要！

### 傻瓜式分析启发法

更广义地说，了解我们在上一部分中提到的启发式方法非常重要，这样才能更好地避免或骗过它们。采用一系列良好的做法，即使并非不可或缺，也会证明是有益的。它们提供了一个额外的保护层，对于在使用比特币时保持良好的隐私非常重要。

我可以给出的第一个建议是融入最密集的人群。在比特币上，这意味着使用最常用的脚本模式。例如，通常用于 SegWit V0 多重签名配置的 P2WSH 脚本就非常罕见。它们无法让你隐藏在大型匿名集中。P2PKH 或 P2SH 等旧模式也是如此。虽然它们广泛存在于 UTXO 中，但在新交易中使用得越来越少。

一般来说，采用最新的脚本标准会更安全，前提是它已被充分采用。因此，如果说在 2022 年，我会建议不要使用 P2TR（Taproot），因为它的采用率很低，那么到了 2024 年，我会建议选择这种脚本，如果不行，也可以选择 SegWit V0 脚本，因为使用 P2TR 的交易数量已经开始占到相当大的比例。

![BTC204](assets/notext/46/03.webp)

来源：[txstats.com]()[txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)

另一个保护隐私的小窍门是尽量规避交易的内部启发式。例如，在付款时，您可以尽量避免创建一个四舍五入的输出，因为这可能意味着其他输出代表了变化。如果您需要向朋友发送 10 万萨特，可以考虑转账一个稍高的金额，以避免这种启发式。同样，尽量不要创建与支付金额相比高得不成比例的变更输出，因为这也会暴露哪个输出代表了变更。

![BTC204](assets/notext/46/04.webp)

最后，如果你经常进行比特币交易，请确保不要总是在相同的时间进行广播。通过在一天和一周内分散播放交易，可以避免让外部观察者发现基于时区的时间模式，从而加强他们的分析。

除了这些日常采用的好方法外，还有一些更有效的方法可以彻底破坏比特币的可追溯性。在这些方法中，显然有我们将在下文中深入研究的 Coinjoin 交易。

# 了解 Coinjoin 交易

<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## 什么是 Coinjoin 交易？

<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

在学习了隐私保护的基础知识后，我们现在将讨论更复杂的技术，旨在积极保护你的隐私，特别是通过分离你的比特币历史。在下文中，我们将探讨许多小技巧，但首先，我想和大家谈谈 coinjoin。

Coinjoin 通常被认为是保护比特币用户隐私的最有效方法。但究竟什么是 Coinjoin 交易呢？让我们一起来了解一下。

### Coinjoin 的基本原则

Coinjoin 是一种打破区块链上比特币可追溯性的技术。它依赖于具有同名特定结构的协作交易：Coinjoin 交易。

正如我们在本培训前几部分所看到的，比特币上的交易通过节点为所有用户所知。因此，很容易验证每个币的电子签名链并观察其历史。这意味着所有用户都可以尝试分析其他用户的交易。因此，交易层面的匿名是不可能的。但在个人身份识别层面，匿名性却得以保留。在传统银行系统中，每个账户都与个人身份相关联，而在比特币中，资金与加密密钥对（或脚本）相关联，从而在加密标识符背后为用户提供了一种假名形式。

![BTC204](assets/en/51/01.webp)

因此，当外部观察者设法将特定的UTXO与已识别的用户联系起来时，比特币的保密性就会受到损害。一旦这种关联建立起来，就有可能追踪他们的交易并分析他们的比特币历史。Coinjoin 正是为了破解UTXOs 的可追溯性而开发的一种技术，目的是在交易层面为比特币用户提供一定的保密性。

Coinjoins 使外部观察者的链分析复杂化，从而提高了比特币用户的保密性。它们的结构允许将来自不同用户的多个硬币合并成一笔交易，从而模糊了交易轨迹，难以确定输入和输出地址之间的联系。

重要的是要明白，"接币 "交易的目的是破坏比特币的历史。这种技术不会赋予比特币永久的匿名性，也不会完全阻止比特币的追踪，这与人们可能的想法恰恰相反。接币的目的只是在进行接币交易时破坏历史记录。然而，在这一操作之前和之后，比特币仍然面临同样的隐私风险。

![BTC204](assets/notext/51/02.webp)

### 共同连接是如何工作的？

Coinjoin 的原理依赖于一种协作方法：几个希望混合比特币的用户将相同金额的比特币存入同一交易的输入端。然后，这些金额会以等值输出的方式重新分配给每个用户。

![BTC204](assets/notext/51/03.webp)

在交易结束时，无法将特定的输出与输入中的已知用户联系起来。输入和输出之间不存在直接联系，这就打破了用户和他们的UTXO之间的联系，也打破了每枚硬币的历史记录。

![BTC204](assets/notext/51/04.webp)

让我们以爱丽丝为例。她想给妹妹伊芙寄 10 万枚比特币作为生日礼物。然而，爱丽丝不希望伊芙能够追踪到她的交易历史，因为她不想暴露自己持有多少比特币或如何获得这些比特币。为此，Alice 决定用一次币合交易来打破她的 UTXO 历史记录。她组织鲍勃、查尔斯、大卫和弗兰克进行一次合作交易：


- 爱丽丝、鲍勃、查尔斯、大卫和弗兰克各自投入 105,000 萨特的UTXO（其中 5,000 萨特为挖矿费用）作为交易输入：

![BTC204](assets/notext/51/05.webp)


- 作为消耗这些输入的回报，每个输入都会生成一个新地址，以创建五个相同的输出，每个输出都有 100 000 个 sats。每台机器都会检索一个输出：

![BTC204](assets/notext/51/06.webp)


- 爱丽丝最终得到了一个由 100 000 个卫星组成的UTXO，它的历史是混合的。她在新的交易中使用这个UTXO，将这笔钱寄给夏娃作为生日礼物：

![BTC204](assets/notext/51/07.webp)


- 如果夏娃试图分析这笔交易以提取信息，她将面对的是涉及爱丽丝、鲍勃、查尔斯、大卫和弗兰克的 Coinjoin 交易。由于金额的统一性，夏娃无法区分哪些输入属于谁，因此无法追踪爱丽丝的UTXO历史，也无法确定她的妹妹拥有多少比特币或她是如何获得这些比特币的：

![BTC204](assets/notext/51/08.webp)

在这种情况下，爱丽丝使用了硬币连接技术来提高其隐私性，以防止追溯分析。事实上，爱丽丝可以保护自己免受夏娃从特定交易开始追溯UTXO 历史的可能分析。这种防止从现在到过去的分析的保护措施就是我们所说的 "追溯性不可见性"（retrospective anonset）。我们将在本部分的最后几章更详细地探讨这一概念。

然而，coinjoin 也提供了从过去到现在加强隐私分析的可能性，这就是所谓的前瞻性匿名。让我们回到爱丽丝为夏娃的生日发送了 98,000 条信息的例子，但将角色颠倒一下。现在想象一下，关心自己隐私的是夏娃。事实上，爱丽丝可能会受到诱惑，跟踪她发送给夏娃的硬币来收集信息。夏娃可能会将她刚刚收到的这个 UTXO 与她所有其他的 UTXO 合并，这样就会向爱丽丝透露她钱包中持有的比特币数量。为了避免这种情况，Eve 也可以打破她刚刚收到的硬币的历史记录。


- 夏娃、格蕾丝、马洛里、奥斯卡和维克多各自将 98,000 sats 的UTXO 作为比特币交易的输入：

![BTC204](assets/notext/51/09.webp)


- 作为消耗这些输入的交换，每个用户都提供了一个新地址，以创建 5 个输出，每个输出有 97 500 个 sats，完全相等。每个用户获取一个输出：

![BTC204](assets/notext/51/10.webp)


- 伊芙现在拥有 97 500 sats 的UTXO，且历史记录已损坏。她可以放心地将其用于未来的交易。事实上，如果 Alice 试图追踪她发送给 Eve 的比特币，她就会遇到 Coinjoin 交易。她将无法确定哪个输出 UTXO 属于 Eve。这样，分析就变得不可能了：

![BTC204](assets/notext/51/11.webp)

在第一个例子中，我们看到了 coinjoin 如何保护硬币过去的隐私，而在第二个例子中，我们看到了 coinjoin 如何保护硬币未来的历史。这就是为什么我提到，coinjoin 应被视为一个一次性事件，它在两个方向上分割硬币的历史：

![BTC204](assets/notext/51/02.webp)

### 混合、共同连接、混合器......有什么区别？

有时，"混合 "一词被用来描述币合，一些比特币爱好者拒绝接受这个词，因为他们担心与托管混合器相混淆。然而，我认为这种担心是没有根据的，因为在数学语境中，币合恰恰体现了混合的概念。

在一般数学领域，混合指的是动态系统的一种特性，即经过一段时间后，初始空间的所有部分理论上都可以与任何其他部分混合。混合意味着粒子的位置或系统的状态以这样一种方式演变，即粒子的未来分布与其初始分布无关，从而达到初始状态的特征在整个系统空间均匀分布的状态。这正是比特币的投币过程。因此，在我看来，"币合 "是一种真正的混合币方法。

![BTC204](assets/notext/51/12.webp)

不过，必须将 coinjoin 与混合器区分开来。混合器是一种用户发送比特币进行混合的服务。这些服务在 2010 年代很流行，但由于与 Coinjoin 相比存在两大缺点，其使用率已经下降：


- 它们要求用户在混合过程中放弃对其资金的保管，从而使其面临被盗风险；
- 不能保证混合器不会记录交易细节，甚至不会将这些信息出售给连锁分析公司。

![BTC204](assets/notext/51/13.webp)

因此，现在的用户更喜欢 Coinjoin，因为它允许他们在整个过程中保持对资金的完全控制。Coinjoin 的参与者不会冒比特币被其他参与者盗取的风险。让我们在下一章一起探讨这一切是如何实现的。

## Zerolink 和 Chaumian Coinjoins

<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

投币式连接的隐私性取决于我们的棋子所隐藏的小组的规模。因此，有必要找到尽可能多的参与者。完全可以通过手动方式与自己找到的用户进行拼接，但这种方法比较复杂，而且无法实现大的匿名集。

这就是为什么在比特币上发展出了 Coojoin 协调员。他们的作用是连接不同的用户，并传输成功完成合作交易所需的信息。

![BTC204](assets/notext/52/01.webp)

但是，我们如何确保协调人永远不会控制用户的比特币，尽管他们是构建 Coinjoin 交易的人，但我们如何确保他们不能将用户的输入和输出联系起来，从而构成隐私泄露？

### 乔姆的盲人签名

硬币拼接的现代实现使用了戴维-乔姆的盲签名来避免信息泄露。让我们一起快速了解一下这些盲签名是如何工作的。

Chaum 的盲签名是一种数字签名形式，签名者不知道所签名的信息内容。然而，该签名随后可以与原始信息进行验证。这项技术由密码学家戴维-查姆于 1983 年开发。

![BTC204](assets/notext/52/02.webp)

例如，一家公司希望在不泄露合同等机密文件内容的情况下对其进行验证。该公司采用一种掩蔽程序，以可逆方式对原始文件进行加密转换。修改后的文件被发送给认证机构，认证机构在不知道基本内容的情况下进行盲签名。收到签名文件后，公司会取消签名屏蔽。这样，一份原始文件就通过了权威机构的签名认证，而权威机构却从未见过原始内容。

因此，Chaum 的盲签名可以在不知道文件内容的情况下认证文件的真实性，既保证了用户数据的保密性，又保证了签名文件的完整性。

### Chaumian Coinjoins

在 "Chaumian CoinJoins "中，Tor 的使用和 David Chaum 的盲签名相结合，确保协调者无法知道哪个输出属于哪个用户。构建 Coinjoin 交易的过程主要围绕三个步骤：注册输入、注册输出和签署交易。让我们以币合参与者之一爱丽丝为例，来看看这个过程。所有其他参与者的步骤与爱丽丝相同，各自独立完成。

**第 1 步：注册输入**。


- 爱丽丝向协调者发送她希望作为交易输入的UTXO，以及她希望作为输出接收比特币的屏蔽接收地址。因此，协调者无法知道爱丽丝的地址。他只能看到地址的屏蔽版本：

![BTC204](assets/notext/52/03.webp)


- 协调人验证输入的有效性，然后用自己的私钥对 Alice 的屏蔽地址进行签名。他将盲签名发回给 Alice：

![BTC204](assets/notext/52/04.webp)

**第 2 步：注册输出**。


- 现在，爱丽丝可以解除由协调人私钥签名的地址。她会以不同的 Tor 身份建立新的连接。协调者无法识别是爱丽丝在用这个新身份连接：

![BTC204](assets/notext/52/05.webp)


- 爱丽丝向协调者（协调者仍不知道是爱丽丝）发送未屏蔽的地址和签名：

![BTC204](assets/notext/52/06.webp)

**第 3 步：签署交易**。


- 协调人同样会从所有参与者那里获取未掩盖的输出结果。通过相关的签名，他可以验证匿名提交的每个输出确实是由他的私钥签名的，从而确保了它们的合法性。然后，他就可以构建 Coinjoin 交易，并将其发送给参与者签署：

![BTC204](assets/notext/52/07.webp)


- 爱丽丝和其他参与者一样，要验证自己的输入和输出是否正确地包含在协调者构建的交易中。如果一切顺利，爱丽丝就会向协调者发送解锁其输入脚本的签名：

![BTC204](assets/notext/52/08.webp)


- 在收集了所有参币者的签名后，协调人就可以在比特币网络上广播交易，以便将其添加到一个区块中。

在这个系统中，协调人无法将输入与特定输出联系起来。此外，他们也无法占有参与者的资金，因为他们永远无法获得解锁 UTXOs 所需的私人密钥。在整个过程中，直到步骤 3 结束，他们也无法获得签名。当爱丽丝和其他参与者在确保一切无误后签署了全局交易后，协调人就不能再修改该交易，包括输出，否则交易就会失效。因此，这可以防止协调者窃取比特币。

最终，在记录交易产出时，币合用户希望得到类似于公民投票的保证。这些行为的公开性和私密性具有双重性。一方面，人们希望保持私密性：对于投票者来说，他们不希望自己的选票与自己的身份联系在一起；对于拼接用户来说，他们不希望自己的输出与输入联系在一起。事实上，如果协调人或任何其他方设法在输入和输出之间建立联系，那么投币连接就失去了所有意义。如前所述，硬币接合必须作为硬币历史的一个中断。之所以会出现这种中断，正是因为在联币交易中不可能将特定的输入与特定的输出联系起来（前瞻性中断），反之亦然（追溯性中断）。

另一方面，还有公共方面：选民希望确保他们的选票包含在投票箱中；同样，币仓用户希望确保他们的输出包含在币仓交易中。事实上，在签署交易之前，币仓参与者绝对有必要验证其输出是否存在，否则协调人可能会窃取资金。

正是由于使用了戴维-乔姆的盲签名，这2个公共和私人方面才得以实现，从而保证了乔姆联合硬币的参与者的比特币不会被盗，他们的资金也不会被追踪。

### 谁发明了联接的概念？

很难确定是谁最先在比特币上提出了 "币合"（coinjoin）的概念，又是谁提出了在这种情况下使用大卫-乔姆（David Chaum）盲签名的想法。人们通常认为是格雷戈里-麦克斯韦尔（Gregory Maxwell）在[2013 年 BitcoinTalk 上的一条信息](https://bitcointalk.org/index.php?topic=279249.0)中首次谈到了这一点：

使用Chaum盲签名：用户登录并提供输入（和更改地址），以及他们希望发送私人硬币的加密盲版地址；服务器签署代币并将其返回给用户。用户以匿名方式重新连接，解除对其输出地址的屏蔽，并将其发送回服务器。服务器可以看到所有输出都已由其签名，因此所有输出都来自有效的参与者。之后，人们重新连接并签名。

Maxwell, G. (2013, August 22). *CoinJoin：现实世界的比特币隐私*.BitcoinTalk Forum. https://bitcointalk.org/index.php?topic=279249.0

![BTC204](assets/notext/52/09.webp)

不过，早先也有人提到过Chaum签名在混合和硬币连接中的应用。[2011年6月，邓肯-汤森（Duncan Townsend）在BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0)上介绍了一种混合器，它使用Chaum签名的方式与现代的Chaumian币币接合十分相似。

在同一主题中，还有[哈希币回复邓肯-汤森的信息](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793)，以改进他的混合器。这条信息中描述的过程恰恰是最接近币合的过程。亚历克斯-米兹拉希（Alex Mizrahi）在 2012 年的一条信息](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry) 中也提到了类似的系统，当时他正在为 Tenebrix 的创建者提供建议，Tenebrix 是最早的另类币之一，也是后来创建莱特币的基础。就连 "coinjoin "一词本身也不是格雷格-麦克斯韦发明的，而是来自彼得-托德的一个想法。

![BTC204](assets/notext/52/10.webp)

### Zerolink

Zerolink 是一种全面的混合协议，它整合了Chaumian coinjoins和各种策略，以保护用户的匿名性免受几种形式的链分析的影响，特别是最大限度地减少与钱包管理相关的错误。该协议[由 nopara73 和 TDevD 于 2017 年推出](https://github.com/nopara73/ZeroLink/blob/master/README.md)。

![BTC204](assets/notext/52/11.webp)

顾名思义，"零链接 "的原理是进行硬币连接交易，确保无法追踪输入和输出之间的联系。这一特点是通过确保所有输出呈现完全相同的金额来实现的。

![BTC204](assets/notext/52/12.webp)

Zerolink 的一项重要预防措施是通过使用不同的加密密钥集，甚至是不同的钱包，将未混合的 UTXO 与混合的 UTXO 完全分开。这样，用于混合前硬币的 "混合前 "钱包与用于混合后硬币的 "混合后 "钱包就区分开了。

![BTC204](assets/notext/52/13.webp)

严格分离UTXO主要是为了防止混合UTXO和未混合UTXO之间的意外关联。事实上，如果出现这种关联，混合 UTXO 上的硬币连接效果就会在用户不知情的情况下失效，从而损害UTXO 的保密性，而用户却认为UTXO 的历史记录已被切断。如果用户将混合UTXO和未混合UTXO作为同一交易的输入，那么这些联系可能是通过地址重用来确保混合UTXO和未混合UTXO的安全，或者是通过应用 "共同输入-所有权启发式"（CIOH）而产生的。通过分离混合前和混合后的钱包，可以避免这些意外关联，并保护用户免受非自愿错误的影响。

![BTC204](assets/notext/52/14.webp)

这种分离还提供了在钱包软件层面对预混合钱包和后混合钱包应用不同规则的可能性。例如，在混合后钱包中，软件可以禁止将UTXO合并到输入中，以防止应用 CIOH，从而损害用户的安全。此外，还可以对脚本和交易选项（例如 RBF 信号）的使用进行标准化，以防止钱包指纹识别。

目前，Whirlpool 是唯一严格应用 Zerolink 协议的 Coinjoin 实现。在下一章中，我们将探讨现有的各种 Coinjoin 实现，以及它们各自的优缺点。

## Coinjoin 实现

<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>

*2024 年，我们将目睹比特币用户可用工具的重大变化。我们目前正处于一个关键时期，币合市场正在经历重大调整。因此，本章可能会随着时间的推移而更新。

目前，比特币上主要有三种不同的 Coojoin 实现方式：


- 惠而浦；
- Wabisabi；
- JoinMarket.

这些实现方式都旨在通过联合交易打破UTXO 的历史。但是，它们的机制差异很大。因此，有必要了解每种机制的工作原理，以选择最适合您需求的方案。

### 加入市场

JoinMarket于2015年由亚当-吉布森（Adam Gibson）和克里斯-贝尔彻（Chris Belcher）创建，由于其独特的用户匹配模式，它从其他币合实现方式中脱颖而出。该系统基于一个 P2P 交换市场，其中一些用户（即 "制造者"）将其比特币用于混合，而另一些用户（即 "接受者"）则使用这些资金进行币币接合，以换取一定的费用。

![BTC204](assets/notext/53/01.webp)

在这种模式下，"制造者 "将自己的比特币提供给 "接受者"，并收取服务费。而 "入币者 "则付费使用 "制造者 "的比特币进行自己的入币交易。服务费因角色而异："制造者 "为其提供的流动性积累费用，而 "接受者 "则支付费用。这个市场自由运作，没有使用条件。

JoinMarket 的主要缺点之一是使用复杂，需要对终端有一定的熟悉程度才能有效利用。虽然这种复杂性对有经验的用户来说不是障碍，但会限制一般公众的使用。不过，最近推出的名为 JAM 的网络界面在一定程度上方便了使用。

![BTC204](assets/notext/53/02.webp)

来源：[JAM]()[JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

然而，技术壁垒仍然是一个主要障碍。在币币兑换生态系统中，参与人数越多，保密性就越高，任何降低可访问性的限制都会直接影响可用的流动性，而流动性是混合效率的关键因素。比特币已经是金融交易中的一个小众领域，它将其使用的 Coinjoins 视为一个小众领域，而 JoinMarket 则是一个更加专业的小众领域，因此限制了其增加用户匿名性的潜力。

尽管 JoinMarket 创新性地采用了 P2P 配对模式，但它也有一些明显的缺点，特别是在交易结构方面。与 Whirlpool 等其他实现方式不同，JoinMarket 无法保证输出之间的完全平等，而且有可能追踪输入和输出之间的确定性链接。此外，它缺乏防止已经混合在一起的硬币再次混合的工具，这可能会损害用户寻求的保密性。

最后，虽然 JoinMarket 的概念很有趣，特别是对那些对动态流动性市场感兴趣的人来说，但在我看来，它结构上的弱点和技术上的复杂性使它对新手和寻求 Coinjoin 实现的专家都不那么有吸引力。

### Wabisabi

Wabisabi 是 Coinjoin 的另一种实现方式，采用的是集中协调交易的方法。该模式由 Ádám Ficsór (nopara73)、Yuval Kogman、Lucas Ontivero 和 István András Seres 于 2021 年设计，并于次年集成到 Wasabi 2.0 软件中。Wabisabi正是2018年推出的Wasabi软件的coinjoin模式的进化版。

![BTC204](assets/notext/53/03.webp)

2010 年代末，Wasabi 采用了一种与 Whirlpool 截然不同的币圈交易结构。为了增加参与者的匿名性，Wasabi 采用了将数十名参与者组合在一起的超大型硬币连接交易。与此相反，Whirlpool 则选择了多个小型交易，使得每个周期的不可见性呈指数增长。

管理变化的方法也是两种实现方法的不同之处。在惠而浦，由于 TX0 的存在，变化在联接循环之前就被排除和隔离在UTXO 之外，我将在下一章进一步解释这一概念。另一方面，在 Wasabi，变化是联接事务的输出之一，它在某些输入和输出之间保持着确定性联系。

![BTC204](assets/notext/53/04.webp)

随着 Wabisabi 的推出，Wasabi 2.0 版本调整了其硬币连接方法，使其更接近 Whirlpool。尽管联接事务仍然非常大，但现在可以连续进行几个循环，从而与 Whirlpool 的模式保持一致。此外，Wabisabi 还在零钱管理方面做出了特别努力：Wasabi 1.0 版本将零钱与用户的投入直接挂钩，而 Wabisabi 则不同，它试图将零钱细分为若干小额，以等额面值分配给所有参与者。

让我们用一个简化的例子来说明这一点，例子中只有两个用户：爱丽丝想混合 115,000 萨特，鲍勃想混合 210,000 萨特。如果忽略手续费，在 Wasabi 1.0 版本中，币合交易将产生 3 个 100,000 萨特的输出，加上爱丽丝的 1 个 15,000 萨特的变化和鲍勃的 1 个 10,000 萨特的变化。变化输出将始终与输入相关联：

![BTC204](assets/notext/53/05.webp)

在 Wabisabi 模式下，同样的交易会产生 3 个 100,000 sats 的输出和 5 个 5,000 sats 的输出，从而分散了变化，使其无法直接追溯到特定的输入：

![BTC204](assets/notext/53/06.webp)

我个人认为，Wabisabi 的变革管理存在一些风险，可能会损害其在隐私方面的有效性：


- 当用户的UTXO明显大于其他参与者的UTXO时，他们不可避免地会产生与其输入相关的变化量。这就违背了协议的最初目标，即消除任何可识别的变化；
- 为了分散变化而增加面额，可能会损害混合的效率。由于某些产出更容易识别，这一过程可能会导致这些产出的自动结算减少；
- 这种方法还会产生低价值的 UTXO，给用户带来管理问题。这些小的 UTXO，如果相对于其价值而言花费过高，就会变成 "灰尘"。这种现象促使用户在今后的交易中将几个 UTXO 合并为投入，或将其合并。在这两种情况下，由于 COH 的存在，要么会减少所获得的匿名性，要么会完全抵消最初合并硬币所获得的隐私利益。

惠而浦实施的 ZeroLink 协议确保了混合前UTXO 和混合后UTXO 之间的严格隔离，而 Wabisabi 则不同。一些 Wasabi 客户端还存在地址重复使用的问题，这显然对用户非常不利。

在 Wasabi 2.0 版本中，实施了新的接币费用政策。现在，对于大于 0.01 个比特币的UTXO，协调费定为 0.3%，而对于较小的UTXO，则完全免收协调费。此外，这些小型 UTXO 的重混合也是免费的，但用户仍需为所有交易（包括重混合）承担挖矿费用。

这一政策与 Whirlpool 的政策形成鲜明对比，后者无论获得多少蚂蚁矿石，费用都是固定的。在 Wasabi 2.0 中，虽然小规模的 UTXO 可以免去协调人费用，但用户仍必须为所有交易（包括混矿）支付挖矿费用。

截至本文撰写之时，随着近期事件的发生，Wabisabi 的使用明显变得更加复杂。事实上，在 Samourai 钱包的创始人被捕后，Wasabi 的开发资金和管理公司 zkSNACKs 宣布将于 2024 年 6 月 1 日停止其 Coinjoin 协调服务。该协调器在 Wasabi 上默认设置，拥有绝大多数的流动性。

随着主协调人的关闭，用户现在必须连接到新的独立协调人。这一变化引起了人们的担忧：一方面，新的协调者可能没有足够的流动性，从而降低了硬币接合在隐私方面的有效性。另一方面，还存在遭遇恶意协调人的风险。这种情况给那些希望使用 Wabisabi 的人增加了新的重大风险。

除了技术问题之外，Wasabi 背后的公司 zkSNACKs 决定使用链分析公司的服务来筛选币圈参与者，也带来了严重的道德和战略问题。最初的想法是防止犯罪分子在 Wasabi 上使用币圈，此举看似合法。然而，这就产生了一个悖论：向一个以提高用户隐私为主要任务的协调者支付费用，而协调者却要资助一个以破坏用户隐私为目标的公司。

更令人担忧的是过滤原则，这与比特币旨在提供一个开放和不可检查的金融系统的理念形成鲜明对比。虽然排除犯罪活动似乎是合理的，但这种过滤也可能影响到一些人，他们的行为虽然在某些情况下被归类为非法，但在道德上是合理的或对社会有益的。爱德华-斯诺登（Edward Snowden）的例子完美地诠释了这种对立：一些政府认为他的揭露行为是犯罪，而另一些政府则认为他是为公众利益而行动的举报人。这种复杂性凸显了过滤的潜在危险，虽然出发点是好的，但最终可能会侵犯合法用户的权利和安全。我还可以提到在某些专制政权下受到迫害的活动家和记者。

正如你所了解的，我无疑更倾向于使用 Whirlpool 模式在比特币上进行接币。这一系统因其严谨性而脱颖而出，并在隐私方面提供了卓越的保证。它也是唯一一个从数学角度提出完美混合的系统。在我看来，这种模式代表了比特币上币的未来。因此，我邀请大家在下一章更深入地探讨这一模式。

## 惠而浦的功能

<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

漩涡有别于其他币合方法，它使用"_ZeroLink_"交易，确保所有输入和所有输出之间不存在任何技术联系。这种完美的混合是通过这样一种结构实现的，即每个参与者的投入（挖矿费用除外）完全相同，从而产生完全等量的产出。

这种对输入的限制性方法使惠而浦联合交易具有一个独特的特点：输入和输出之间完全没有确定的联系。换句话说，相对于交易的所有其他输出，每个输出归属于任何参与者的概率都是相等的。

![BTC204](assets/notext/54/01.webp)

### 惠而浦的一般功能

最初，每次漩涡币合并的参与者人数限制为 5 人，其中包括 2 名新加入者和 3 名混币者（我们将进一步解释这些概念）。然而，2023 年观察到的链上交易费用的增加促使 Samourai 团队重新思考他们的模式，以提高隐私性，同时降低成本。因此，考虑到费用和参与者数量的市场情况，协调人现在可以组织包括 6、7 或 8 名参与者在内的币会。这些增强型会议被命名为"_Surge Cycles_"。值得注意的是，无论采用何种配置，漩涡式投币活动中始终只有两名新参与者。

因此，惠而浦交易的特点是输入和输出的数量相同，可以是


- 5 个输入和 5 个输出；

![BTC204](assets/notext/54/02.webp)


- 6 个输入和 6 个输出；

![BTC204](assets/notext/54/03.webp)


- 7 个输入和 7 个输出；

![BTC204](assets/notext/54/04.webp)


- 8 个输入和 8 个输出。

![BTC204](assets/notext/54/05.webp)

因此，惠而浦提出的模式是基于小规模的硬币连接交易。与 Wabisabi 和 JoinMarket 不同，Whirlpool 将赌注押在多个小规模循环的链条上。在这种模式下，用户只需在首次进入池时支付费用，就可以参与多次混音而无需支付额外费用。而新加入者则需支付混矿者的采矿费。

每当一枚硬币与过去遇到的同类硬币一起参与额外的硬币合并时，匿名集都会呈指数级增长。因此，我们的目标是利用这些免费的混搭，每次混搭都有助于加强与每个混合硬币相关的匿名集的密度。

![BTC204](assets/notext/54/06.webp)

惠而浦在设计时考虑到了两个重要要求：


- 鉴于 Samourai 钱包主要是一款智能手机应用软件，因此在移动设备上的实施非常方便；
- 加快混音循环的速度，以鼓励大幅提高不对称率。

Samourai 钱包的开发人员在设计 Whirlpool 时，以这些必要条件为指导，限制了每个周期的参与者人数。参与人数太少会影响接币的效果，大大减少每个循环中产生的硬币，而参与人数太多又会给移动应用程序带来管理问题，阻碍循环的流动。

归根结底，漩涡上的每次联合无需大量参与者，因为取消设置是在数次联合循环的累积过程中完成的。这里最重要的原则是所有参与者的UTXO的同质性，因为这可以实现完美的混合，从而充分受益于混合和再混合循环。

### 游泳池和投币收费

为使这些多重循环能有效提高混合硬币的安设率，必须建立一定的框架来限制所使用的 UTXO 数量。漩涡因此定义了不同的池。

一个币池代表一组希望混合在一起的用户，他们就使用的UTXO数量达成一致，以便在保持币的完美同质性的同时优化加入币的过程。每个币池都规定了UTXO的固定数量，用户必须遵守这一规定才能参与。因此，要使用 Whirlpool 进行币合，您需要选择一个池。目前可用的币池如下：


- 0.5 个比特币
- 0.05 比特币
- 0.01 比特币
- 0.001 比特币（= 100,000 萨特）。

加入比特币池后，您的比特币将被分割，生成与池中其他参与者完全一致的UTXO。每个比特币池都有最高限额；因此，如果金额超过该限额，您将被迫在同一比特币池中进行两次单独输入，或者转入另一个金额更高的比特币池：

| 币池（比特币） | 每个条目的最高金额（比特币） | | 每个条目的最高金额（比特币） | | 每个条目的最高金额（比特币

|----------------|------------------------------------|

| 0.5 | 35 |

| 0.05 | 3.5 |

| 0.01 | 0.7 |

| 0.001 | 0.025 |

当一个UTXO准备好并入一个币池时，它就被视为属于该币池。但这并不意味着用户失去了对它的所有权。正如我们在本部分前几章中看到的，在不同的混合周期中，用户仍可保留对密钥的完全控制权，因此也可保留对比特币的完全控制权。这就是币合技术与其他集中式混合技术的不同之处。

要进入 Coinjoin 池，您必须支付服务费和采矿费。每个矿池的服务费都是固定的，旨在补偿负责开发和维护 Whirlpool 的团队。

使用 Whirlpool 的服务费须在进入泳池时一次性支付。完成此步骤后，您可以无限次参加混音，无需支付额外费用。以下是当前每个池的固定费用：

| 奖池（比特币） | 报名费（比特币） | 奖金（比特币

|----------------|-----------------------------|

| 0.5 | 0.0175 |

| 0.05 | 0.00175 |

0.01 | 0.0005 (50,000 sats) | 0.01 | 0.0005 (50,000 sats) | 0.0005 (50,000 sats)

| 0.001 | 0.00005 (5,000 sats) | | 0.001 | 0.00005 (5,000 sats)

无论您在 coinjoin 中投入多少资金，这些费用本质上都是所选池的入场券。因此，无论您是以 0.01 BTC 加入 0.01 币池，还是以 0.5 BTC 加入，费用的绝对值都是一样的。

因此，在进行惠而浦硬币连接之前，用户可以选择两种策略：


- 选择规模较小的资金池，以尽量减少服务费，因为他们知道自己将获得几个较小的 UTXO；
- 或者更喜欢更大的资金池，同意支付更高的费用，最终获得数量更少、价值更大的 UTXO。

一般不建议在硬币连接循环后合并多个混合 UTXO，因为这可能会损害所获得的隐私，特别是由于共同输入所有权启发式（CIOH：*共同输入所有权启发式*）。因此，明智的做法是选择更大的资源池，即使这意味着要支付更多的费用，以避免有太多小价值的UTXO作为输出。用户必须权衡这些利弊，选择自己喜欢的池。

除了服务费，还必须考虑任何比特币交易固有的采矿费。作为 Whirlpool 用户，您需要支付准备交易 (`Tx0`)的挖矿费以及首次加入比特币的挖矿费。由于 Whirlpool 的模式依赖于新加入者的付费，所有后续的混币都将是免费的。

事实上，在每一次惠而浦拼接中，都有两个用户是新加入者。其他输入用户来自再混合者。因此，交易中所有参与者的挖矿费用都由这两个新参与者承担，他们也将从免费的混音中获益：

![BTC204](assets/en/54/07.webp)

由于UTXOs 的匿名性与用户支付的价格不成正比，因此 Whirlpool 真正区别于其他 Coinjoin 实现。因此，只需支付入池费和 2 笔交易（"Tx0 "和初始混合）的挖矿费，就可以实现相当高的匿名性。

值得注意的是，用户在进行多币合并后，还需要支付从池中提取UTXO的挖矿费用，除非他们选择了 "混合到 "选项，该选项允许提供一个外部地址，该地址将直接接收作为币合并输出的资金，而无需任何额外交易。

### 高清钱包账户

要通过 Whirlpool 进行币合，钱包必须生成多个不同的账户。这就是 ZeroLink 协议的原理。在 HD（*分层确定性*）钱包中，一个账户构成一个与其他账户完全隔离的部分，这种隔离发生在钱包层次结构的第三层，即 "xpub "层。

![BTC204](assets/en/54/08.webp)

一个 HD 钱包理论上最多可以衍生出 `2^(32/2)` 个不同的账户。所有比特币钱包默认使用的初始账户都对应索引 "0"。

对于适用于惠而浦的钱包，使用 4 个账户来满足 ZeroLink 流程的需要：


- 存款账户**，由索引 "0 "标识；
- 坏银行**账户（或 "有毒变化"），由索引 "2 147 483 644 "标识；
- 以 "2 147 483 645 "为索引的**预混**账户；
- 以 "2 147 483 646 "为索引的**postmix**账户。

这些账户在联接过程中各司其职，我们将在下文中探讨。

所有这些账户都与一个种子相关联，用户可以使用恢复短语，必要时还可以使用密码，恢复对所有比特币的访问。不过，在恢复操作过程中，有必要向软件指定所使用的不同账户索引。

现在，让我们来看看惠而浦在这些账户中进行硬币合并的不同阶段。

### TX0

任何惠而浦币合的起点都是**存款账户**。该账户是您创建新比特币钱包时自动使用的账户。该账户必须存入您想要混合的比特币。

Tx0 "是漩涡混合过程的第一步。它的目的是准备和均衡UTXOs，将其分成与所选池数量相对应的单位，以确保混合的均匀性。然后将均衡后的UTXOs 送入**预混**账户。至于不能进入币池的差额，则会被分离到一个特定的账户：**坏银行**（或 "有毒变化"）。

这笔初始交易 "Tx0 "还用于结算应支付给 Coinjoin 协调员的服务费。与下面的步骤不同，这笔交易不是合作交易；因此用户必须承担全部挖矿费用：

![BTC204](assets/en/54/09.webp)

在这个 "Tx0 "交易示例中，从我们的**存款**账户输入的 "372 000 萨特 "被分成几个输出的 UTXO，它们的分布情况如下：


- 为协调员提供 5 000 萨特的服务费，相当于进入 100 000 萨特的资金池；
- 3 个准备混合的UTXO，转入我们的**预混合**账户，并在协调员处登记。这些UTXO的均价为每个108 000萨特，以支付其未来初始混合的采矿费；
- 因数额太小而无法进入资金池的盈余被视为有毒变化。它被发送到特定的账户。在这里，这一变化相当于`40 000 萨特`；
- 最后，还有 "3 000 个卫星 "不构成产出，但却是确认 "Tx0 "所需的采矿费。

例如，这里有一个真实的 Tx0 惠而浦（不是我提供的）：[edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/notext/54/10.webp)

### 有毒的变化

无法纳入池中的多余部分（此处相当于 "40,000 萨特"）被转入**坏银行**账户，也称为 "有毒变化"，以确保与钱包中的其他UTXO 严格分离。

这种UTXO 对用户的隐私来说是危险的，因为它不仅仍附着在其过去，从而可能附着在其所有者的身份上，而且还被标记为属于一个参与了硬币合并的用户。

![BTC204](assets/notext/54/11.webp)

如果将该UTXO 与混合输出合并，用户将失去在硬币连接周期中获得的所有隐私，这主要是由于 CIOH（*通用输入-所有权-指令*）的作用。如果将其与其他有毒变化合并，用户将面临失去隐私的风险，因为这将把从联合拼接循环中获得的不同条目联系起来。因此，必须谨慎处理。我们将在本章最后一节详细讨论如何管理这些有毒的 UTXO。

### 初始混合

完成 "Tx0 "后，均衡后的UTXO会被发送到我们钱包的**预混合**账户，准备进入第一个币合周期，也称为 "初始混合"。如果在我们的示例中，"Tx0 "产生了多个用于混合的UTXO，那么每个UTXO都将被整合到一个单独的初始混合中。

在这些首次混合结束后，**premix**账户将清空，而我们的币在支付了首次加入币池的挖矿费用后，将被精确调整到所选币池定义的数量。在我们的例子中，我们最初的 `108,000 sats` UTXOs 将正好减少到 `100,000 sats`。

![BTC204](assets/notext/54/12.webp)

### 混音版

初始混音后，UTXO 被转移到 **postmix** 账户。该账户汇集了已混合的UTXO和等待重新混合的UTXO。当 Whirlpool 客户端激活时，**postmix** 账户中的UTXO 将自动用于重新混合，并被随机选中参与这些新的循环。

需要提醒的是，重新混合是 100% 免费的：不需要额外的服务费或挖矿费。因此，将UTXOs保留在**混币后**账户中，可以保持其完整价值，同时提高其匿名性。这就是为什么允许这些币参与多个加入币周期的重要性。这完全不需要任何成本，而且还能提高它们的匿名性。

当您决定使用混合UTXO时，您可以直接从这个**postmix**账户中使用。建议将混合UTXO保留在此账户中，以享受免费混音，并防止其离开漩涡回路，从而降低其私密性。

### 如何正确管理混合后产品？

进行币合循环后，最好的策略是将UTXO保存在**后混合**账户中，以备将来使用。甚至最好让它们无限期地重新混合，直到你需要使用它们为止。

一些用户可能会考虑将混合比特币转移到一个由硬件钱包保护的钱包中。这是有可能的，但重要的是要严格遵守 Samourai 钱包的建议，以免泄露获得的机密。

合并UTXO 是最常犯的错误。有必要避免在同一笔交易中将混合UTXO与非混合UTXO合并，以避免共同输入-所有权-激励（CIOH）。这就需要在钱包中仔细管理UTXO，特别是标签方面。

![BTC204](assets/notext/54/13.webp)

同样重要的是，要谨慎对待混合 UTXO 之间的合并。如果您的混合 UTXOs 有显著的不对称，可以进行适度的合并，但这将不可避免地降低硬币的保密性。请确保合并既不要过于明显，也不要在混币次数不足后进行，否则会在混币周期前后在UTXO之间建立可推断的联系。如果对这些操作有疑问，最好的做法是不要合并混合后的UTXOs，而是将它们逐个转移到硬件钱包中，每次都生成一个新的空白地址。同样，请记住正确标注每个收到的 UTXO。

我们还建议您不要使用不常用的脚本将您的混合后UTXOs 转移到钱包中。例如，如果您使用 `P2WSH` 脚本从多位数钱包进入 Whirlpool，您很有可能会与其他拥有相同类型钱包的用户混在一起。如果你把你的后混合提取到这个相同的多字符钱包，你的混合比特币的隐私级别将大大降低。除了脚本之外，还有许多其他钱包指纹可以欺骗你。

与任何比特币交易一样，重要的是不要重复使用接收地址。每笔新交易都应该用一个新的空白地址接收。

最简单、最安全的解决方案是将混合后的UTXO放在**后混合**账户中，让它们重新混合，只在消费时才接触它们。Samourai 和 Sparrow 钱包对所有这些链分析相关的风险都有额外的保护措施。这些保护措施可以帮助您避免犯错。

### 如何正确管理有毒变化？

其次，您必须小心管理您的有毒零钱，即无法进入 coinjoin 池的零钱。这些因使用惠而浦而产生的有毒UTXO会对您的隐私构成威胁，因为它们会在您和使用代币兑换之间建立联系。因此，必须谨慎处理它们，不要将它们与其他 UTXOs（尤其是混合 UTXOs）结合在一起。

以下是使用它们时需要考虑的不同策略：


- 在较小的水池中混合使用：** 如果有毒的 UTXO 大到足以单独进入一个较小的水池，则应考虑混合使用。这通常是最好的选择。然而，我们不鼓励将多个有毒UTXO合并到一个池中，因为这可能会将不同的条目联系起来；
- 将它们标记为 "不可用"：** 另一种方法是不再使用它们，在它们的专用账户中将它们标记为 "不可用"，然后直接删除。这样可以确保你不会不小心花掉它们。如果比特币价值上升，可能会出现更适合你的有毒 UTXOs 的新池；
- 捐款：** 考虑向开发比特币及其相关软件的开发者捐款，哪怕是微薄的捐款。您也可以向接受 BTC 的组织捐款。如果管理有毒的 UTXOs 显得过于复杂，您可以通过捐款将其清除。
- 购买礼品卡：** [Bitrefill](https://www.bitrefill.com/)等平台允许你用比特币兑换礼品卡，这些礼品卡可以在各种商家使用。这也是一种处理有毒 UTXOs 而不损失相关价值的方法。
- 将它们整合到 Monero 上：** Samourai 钱包提供 BTC 和 XMR 之间的原子交换服务。这非常适合管理有毒的UTXO，在将其发送回比特币之前，将它们整合到莫奈罗上，而不会通过KYC泄露您的隐私。不过，由于流动性的限制，这一方案在采矿费和溢价方面可能成本较高。
- 将它们发送到闪电网络：** 将这些UTXO传输到闪电网络，以享受交易费用的降低，是一个有趣的选择。不过，这种方法可能会泄露某些信息，具体取决于您对闪电的使用情况，因此应谨慎使用。

### 如何使用惠而浦？

2024 年 4 月 24 日，Samourai 钱包的创始人被捕，其服务器也被查封，此后，漩涡工具已无法使用，即使拥有自己 Dojo 的用户也无法使用。在此之前，Samourai 钱包和 Sparrow 钱包上可以使用该工具。

![BTC204](assets/notext/54/14.webp)

不过，根据试验结果，该工具仍有可能在未来几周内重新投入使用，或以其他方式重新推出。无论如何，我相信比特币上的 Coinjoin 市场不会长期没有报价，因为需求是显而易见的。此外，惠而浦模式在隐私保护方面是最先进的，将来肯定会被用于其他实施方式。

我们正密切关注此案的进展以及相关工具的发展情况。请放心，一旦有新的信息，我们将及时更新培训内容。

在下一章中，我们将了解什么是 "anonsets"，这些指标是如何计算的，以及它们如何帮助我们估算联接循环的有效性。

https://planb.network/tutorials/privacy/on-chain/coinjoin-sparrow-wallet-84def86d-faf5-4589-807a-83be60720c8b
https://planb.network/tutorials/privacy/on-chain/coinjoin-samourai-wallet-e566803d-ab3f-4d98-9136-5462009262ef
https://planb.network/tutorials/privacy/on-chain/coinjoin-dojo-c4b20263-5b30-4c74-ae59-dc8d0f8715c2
## 匿名套装

<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

在研究了硬币接合如何运作以及与有效混合相关的挑战之后，我们现在将学习如何衡量这种有效性。如何确定硬币拼接过程是否有效，以及硬币的匿名程度如何？这就是我们在本章中要探讨的匿名集或英文中的 "anonsets"。

### 关于 Coinjoin 用途的提示

CoinJoin 的效用在于它能够通过将你的硬币沉浸在一组无法区分的硬币中来产生似是而非的可抵赖性。此举的目的是打破从过去到现在以及从现在到过去的可追溯性联系。

换句话说，如果分析师知道您在 CoinJoin 周期进入时的初始交易（"Tx0"），那么他就无法确定您在 remix 周期退出时的UTXO（从周期进入到周期退出的分析）。

![BTC204](assets/en/55/01.webp)

相反，如果分析师知道您在 CoinJoin 循环退出时的 UTXO，他就无法确定循环进入时的原始交易（从循环退出到循环进入的分析）。

![BTC204](assets/en/55/02.webp)

为了评估分析师将过去和现在联系起来的难度，有必要量化您的硬币所隐藏的同质硬币群的规模。这种方法可以告诉我们具有相同概率的分析的数量。因此，如果正确的分析被淹没在其他 3 个概率相同的分析中，那么您的隐藏程度就很低。然而，如果正确的分析是在一组 20000 个相同概率的分析中，那么你的硬币就隐藏得很好。准确地说，这些分析组的大小代表了一种叫做 "anonsets "的指标。

### 了解 Anonsets

匿名集是评估特定UTXO隐私程度的指标。更具体地说，它们衡量的是包括所研究硬币在内的UTXO集合中无法区分的UTXO数量。同质 UTXO 集的要求意味着匿名集通常是通过 CoinJoin 循环来计算的。由于漩涡式 CoinJoin 的均匀性，这些指标的使用与漩涡式 CoinJoin 尤其相关。

在适当的情况下，匿名集可以用来判断 CoinJoins 的质量。匿名集规模越大，表示匿名程度越高，因为在同质集合中很难分辨出特定的UTXO。

有 2 种类型的不适用情况：


- 潜在的不发病者；**
- 追溯性的ONSET.**

### 前瞻性的不确定性

前瞻性湮没表示的是，在知道进入时的UTXO的情况下，所研究的UTXO在周期退出时被隐藏在其中的群体的大小，也就是在这个群体中存在的无法区分的硬币的数量。该指标的英文名称为 "forward anonset"，或 "前瞻性指标"。

该指标可测量硬币对过去到现在分析（输入到输出）的隐私电阻。

![BTC204](assets/en/55/03.webp)

该指标可估算出您的UTXO 在多大程度上受到保护，以防止有人试图重建其从进入点到退出点的历史数据。

例如，如果您的交易参与了第一个硬币连接周期，并完成了另外两个后代周期，那么您的硬币的预期取消时间将是 `13`：

![BTC204](assets/notext/55/04.webp)

例如，让我们想象一下，我们的硬币在硬币连接周期的入口处受益于`86,871`的预期不确定性。实际上，这意味着它隐藏在 `86,871` 枚无法区分的硬币中。对于外部观察者来说，在硬币连接周期开始时意识到这枚硬币，并试图追踪它的出口，他们将面临`86,871`个可能的UTXO，每个都有相同的概率成为所寻找的硬币。

![BTC204](assets/en/55/05.webp)

### 溯及既往

回溯性不可见性表明，在知道周期退出时的UTXO 的情况下，特定硬币可能的来源数量。该指标衡量硬币在从现在到过去的分析（出口到输入）中的隐私阻力，即在硬币连接周期之前，分析师追溯硬币来源的难度。该指标的英文名称为 "backward anonset"，或 "backward-looking metrics"。

![BTC204](assets/en/55/06.webp)

通过了解您在周期退出时的UTXO，追溯反向确定了可能构成您进入币合周期的潜在Tx0交易的数量。在下图中，这相当于所有橙色气泡的总和。

![BTC204](assets/notext/55/07.webp)

例如，让我们想象一下，我们的硬币在硬币连接周期的出口处受益于`42,185`的追溯反集。实际上，这意味着这枚 UTXO 有`42,185`个潜在来源。如果外部观察者在周期结束时识别出这枚硬币并试图追踪其来源，他们将面临`42,185`个可能的来源，所有来源都有相同的概率成为所寻求的来源。

![BTC204](assets/en/55/08.webp)

### 如何具体计算蚁集？

对于较小的集合，可以使用区块资源管理器手动计算出一个集合。然而，对于较大的 anonsets，就必须使用专门的工具了。据我所知，唯一能完成这项任务的软件是*Whirlpool Stats Tool*，这是一款由 Samourai 和 OXT 团队开发的 Python 工具。不幸的是，在 Samourai 创始人被捕和用于从区块链中提取数据的 OXT 停止使用后，该工具目前已停止使用。

![BTC204](assets/notext/55/09.webp)

正如我们在本章中所看到的，只有当币圈结构存在一定的同质性时，才能计算出anonsets。在下一章中，我们将发现如何量化比特币交易中的这种同质性，无论是币合还是更传统的交易。

https://planb.network/tutorials/privacy/analysis/wst-anonsets-0354b793-c301-48af-af75-f87569756375
## 熵

<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

正如我们在 "币链 "部分所看到的，UTXOs 在输入和输出中的同质性对提高比特币交易的保密性起着重要作用。通过这一参数，可以对链分析进行似是而非的推诿。有几种方法可以测量这种同质性，但在我看来，最有效的方法之一是使用 OXT 和 Samourai Wallet 团队开发的*Boltzmann*工具提供的指标，尤其是交易熵。这就是我们将在本章详细研究的内容。

与对一系列交易进行计算的 anonsets 不同，我们在此介绍的指标只关注单笔交易，无论是币合还是更传统的交易。

### 解释的数量

在比特币交易中可以观察到的第一个指标是外部观察者在分析交易时可能做出的解释总数。考虑到交易中涉及的UTXO的值，该指标显示了输入与输出相关联的方式的数量。换句话说，它决定了从外部观察者分析的角度来看，一笔交易在比特币流动过程中可能产生的解释数量。

例如，一个有 1 个输入和 2 个输出的简单支付交易只有一种解释，即输入 #0 为输出 #0 和输出 #1 提供资金。没有其他可能的解释：

![BTC204](assets/notext/56/01.webp)

相比之下，按照惠而浦 5x5 模型构建的硬币连接则会产生 1 496 美元的可能组合：

![BTC204](assets/notext/56/02.webp)

一台惠而浦 Surge Cycle 8x8 硬币兑换机可以兑换 9,934,563 美元：

![BTC204](assets/notext/56/03.webp)

### 熵

根据比特币交易的解释次数，我们可以计算出它的熵。

在密码学和信息学的一般语境中，熵是对与数据源或随机过程相关的不确定性或不可预测性的量化测量。换句话说，熵是一种衡量信息预测或猜测难度的方法。

在链分析的具体语境中，熵也是一个指标的名称，由香农熵和[LaurentMT发明](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf)衍生而来，可以计算比特币交易。

当一项交易有大量可能的解释时，通常更需要参考其熵。这一指标可以衡量分析师对交易的确切配置缺乏了解的程度。换句话说，熵越高，分析师识别比特币在输入和输出之间流动的任务就越困难。

在实践中，熵揭示了从外部观察者的角度来看，交易是否仅根据输入和输出的数量，而不考虑其他外部或内部模式和启发式方法，就能呈现出多种可能的解释。因此，高熵意味着交易的保密性更好。

熵的定义是可能组合数的二进制对数。以下是使用的公式，其中 $E$ 是交易的熵，$C$ 是可能的解释数：

$$
E = \log_2(C)
$$

在数学中，二进制对数（基 2 对数）对应于 2 的指数化的逆运算。换句话说，$x$ 的二进制对数是为得到$x$ 而必须将$2$ 提升到的指数。因此，该指标用比特表示。

让我们以计算根据惠而浦 5x5 模型构建的硬币连接交易的熵为例，如上一节所述，该交易的可能解释数为 1 496$：

$$
\begin{align*}
C &= 1,496 \\
E &= \log_2(1,496) \\
E &= 10.5469 \text{ bits}
\end{align*}
$$

因此，该硬币连接交易的熵值为 10.5469$ 比特，非常令人满意。该值越高，交易可接受的不同解释就越多，从而提高了交易的私密性。

对于呈现 9,934,563 美元解释的 8x8 硬币合并交易，熵为

$$
\begin{align*}
C &= 9,934,563 \\
E &= \log_2(9,934,563) \\
E &= 23.244 \text{ bits}
\end{align*}
$$

我们再以标准支付交易为例，它有 1 个输入和 2 个输出：[1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/notext/56/04.webp)

就该事务而言，唯一可能的解释是：`(In.0) > (Out.0 ; Out.1)`。因此，其熵为 0$：

$$
\begin{align*}
C &= 1 \\
E &= \log_2(1) \\
E &= 0 \text{ bits}
\end{align*}
$$

### 效率

根据交易的熵，我们还可以计算出其在隐私方面的效率。这一指标通过将交易与相同配置下的最优交易进行比较来评估交易效率。

这就引出了最大熵的概念，即特定交易结构理论上可以达到的最高熵。然后，通过将最大熵与所分析事务的实际熵相比较，计算出事务的效率。

所用公式如下


- E_R$：交易的实际熵，以比特为单位；
- E_M$：事务结构的最大可能熵，也以比特为单位；
- Ef$：以比特为单位的交易效率：

$$
Ef = E_R - E_M
$$

例如，对于惠而浦 5x5 型共轭结构，最大熵为 10.5469 美元：

$$
\begin{align*}
E_R &= 10.5469 \\
E_M &= 10.5469 \\
Ef &= E_R - E_M \\
Ef &= 10.5469 - 10.5469 \\
Ef &= 0 \text{ bits}
\end{align*}
$$

该指标也用百分比表示。计算公式如下


- C_R$：可能的实数解释数；
- C_M$：具有相同结构的可能解释的最大数量；
- Ef$：以百分比表示的效率：

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1\,496}{1\,496} \\
E_f &= 100\%
\end{align*}
$$

因此，100%$ 的效率表明，根据交易结构，交易的隐私潜力最大。

### 熵密度

熵是衡量交易隐私的一个很好的指标，但它在一定程度上取决于交易中输入和输出的数量。要比较输入和输出数量不相同的两个不同交易的熵，可以计算熵密度。该指标提供了与交易中每个输入或输出相关的熵的视角。密度有助于评估和比较不同规模交易的效率。

要计算它，只需用交易的总熵除以交易涉及的输入和输出总数即可：


- E_D$：以比特为单位的熵密度；
- E$：以比特为单位的交易熵；
- T$：交易中输入和输出的总数：

$$
E_D = \frac{E}{T}
$$

让我们以惠而浦 5x5 硬盘为例：

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ bits}
\end{align*}
$$

我们也来计算一下惠而浦 8x8 硬连接的熵密度：

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
E_D &= 1.453 \text{ bits}
\end{align*}
$$

通过分析这两种共轭连接的熵密度，我们可以明显看出，即使按元素数量对熵进行归一化处理，"浪涌循环 8x8 "共轭连接也会产生更多的不确定性。

### 波兹曼分数

交易中分析的另一项信息是每个元素相对于另一个元素的波尔兹曼分数。这是一张输入和输出之间匹配概率的表格。该表通过波尔兹曼分数显示了特定输入与特定输出之间的条件概率。因此，它是对交易中输入和输出之间发生关联的条件概率的定量测量，其依据是在一组解释中，该事件的有利发生次数与可能发生的总次数之比。

以惠而浦硬币连接为例，条件概率表将突出显示每个输入和输出之间存在联系的几率，为交易中关联的模糊性提供了一个量化的衡量标准：

| % | 输出 0 | 输出 1 | 输出 2 | 输出 3 | 输出 4 |

| ------- | -------- | -------- | -------- | -------- | -------- |

输入 0 | | 34% | 34% | 34% | 34% | 34% | 34% |

输入 1 | 34% | 34% | 34% | 34% | 34% | 34% | 34

输入 2 | | 34% | 34% | 34% | 34% | 34% | 34% | 34

输入 3 | 34% | 34% | 34% | 34% | 34% | 34% | 34

输入 4 | 34% | 34% | 34% | 34% | 34% | 34% | 34

很明显，每个输入都有同等机会与任何输出相关联，这就提高了交易的保密性。

波尔兹曼分数的计算方法是，用某一事件出现的解释数除以可用解释总数。因此，要确定输入 #0 与输出 #3（在 512$ 种解释中出现的事件）的相关分数，过程如下：

$$
\begin{align*}
\text{Interpretations (IN.0 > OUT.3)} &= 512 \\
\text{Total Interpretations} &= 1496 \\
\text{Score} &= \frac{512}{1496} \\
\text{Score} &= 34 \%
\end{align*}
$$

如果我们重温惠而浦 8x8 浪涌循环的例子，波尔兹曼表将如下所示：

| | out.0 | out.1 | out.2 | out.3 | out.4 | out.5 | out.6 | out.7 |

|-------|-------|-------|-------|-------|-------|-------|-------|-------|

| in.0 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23



| 英寸 3 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| in.4 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23



| 英寸 6 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

| in.7 | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23% | 23

但是，如果是涉及一个输入和两个输出的简单交易，情况就不同了：

| 输出 0 输出 1

|---------|----------|----------|

| 输入 0 | 100% | 100% |

在这里，我们观察到每个输出源于输入 0 的概率是 100%。因此，较低的概率可以通过淡化输入和输出之间的直接联系来提高私密性。

### 确定性链接

还可以计算交易中确定性联系的数量。这一指标揭示了在所分析的交易中，有多少输入和输出之间的联系是无可争议的，其概率为 100%。然后，可以通过计算确定性联系的比率来补充这一指标。通过该比率可以了解这些确定性链接在所有交易链接中的权重。

例如，一个惠而浦式的投币交易显示输入和输出之间没有确定性联系，因此显示的指标为 0 个联系，比率为 0%。相反，在我们研究的第二种简单支付交易（有一个输入和两个输出）中，指标告诉我们有两个确定性链接，比率达到 100%。因此，由于输入和输出之间不存在直接的、无可争议的联系，指标为空表示隐私性极佳。

### 如何计算这些指标？

使用我提供的公式手动计算这些指标相对简单。主要困难在于确定交易的可能解释数量。对于标准交易，可以手工计算。但是，对于联合交易来说，这项工作要复杂得多。

在此之前，OXT 和 Samourai 团队开发了一个名为_Boltzmann Calculator_的 Python 工具，可以自动计算比特币交易的所有这些指标：

![BTC204](assets/notext/56/05.webp)

还可以使用 KYCP.org 网站进行这些分析：

![BTC204](assets/notext/56/06.webp)

遗憾的是，在 Samourai 创始人被捕后，这些工具目前无法使用。

既然我们已经详细讨论了 "硬币连接"，我们将在培训的最后一节探讨比特币上的其他隐私保护技术。我们将研究payjoins、特定交易类型的pseudo-coinjoins、静态地址协议，以及不在交易层面而在节点网络层面提高隐私的措施。

https://planb.network/tutorials/privacy/analysis/boltzmann-entropy-738e45af-18a6-4ce6-af1a-1bf58e15f1fe
# 了解其他先进隐私技术的利害关系

<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Payjoin 交易

<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

目前，Coinjoin 是在链分析过程中将不确定性引入硬币追踪的最有效方法。正如我们在前几章中所看到的，要实现有效的混合，输入和输出必须尽可能地一致。此外，还必须将硬币整合到尽可能大的组中，以获得最大的无集合。因此，要使硬币拼接有效，必须涉及大量统一的硬币。如此多的要求意味着币合交易有一个非常严格的结构：金额是预先确定的，所有参与者都必须遵守，以确保过程的统一性。此外，硬币接合要求所有参与者和协调者在交易构建过程中保持同步。

这些要求使得币合不适合直接支付。例如，如果您在 Coinjoin 池中拥有一枚 100 万萨特的硬币，那么直接用它来支付将非常复杂。它需要与其他参与者和协调者同步，以便在您需要付款时构建协作交易，而且购买金额必须与您的金币价值完全匹配，这实际上是无法实现的。因此，币合交易本质上是一种扫码协作交易，也就是说，一般情况下，输入的所有者都是输出的所有者。

然而，如果交易结构既能实现实际支付，又能在链分析中引入疑点，那将会很有意义。这正是我们将在本章和下一章探讨的问题。

### 什么是 payjoin 交易？

Payjoin 是一种特殊的比特币交易结构，它通过与收款人合作来增强用户在消费过程中的隐私。

根据一份可在[此处](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt)查阅的文件，LaurentMT 是在 2015 年首次以 "*steganographic transactions*"的名义提到这种方法的。后来，Samourai 钱包采用了这一技术，并于 2018 年成为第一个使用 Stowaway 工具实现这一技术的客户端。Payjoin 的概念也出现在 [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki) 和 [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki) 中。因此，有多个术语被用来指代 payjoin：


- Payjoin；
- 偷渡者
- P2EP（*支付到终点*）；
- 加密交易。

payjoin 的特别之处在于它能够产生一种乍看之下很普通的交易，但实际上是两个人之间的迷你 Coinjoin。为此，交易结构将收款人与实际发款人并列。这样，收款人就可以在交易中间向自己付款，从而获得报酬。

让我们举个例子来更好地理解这个过程。爱丽丝用 10,000 萨特的UTXO 购买了一个 4,000 萨特的法棍，并选择了付费加入。她的面包师鲍勃在输入中加入了属于他的 15000 萨特的UTXO，除了爱丽丝的 4000 萨特外，他在输出中全额取回了这些UTXO。

![BTC204](assets/notext/61/01.webp)

在这个例子中，面包师鲍勃投入 15000 沙特，产出 19000 沙特，差额正好是 4000 沙特，也就是长棍面包的价格。爱丽丝投入 10,000 沙特，最后产出 6,000 沙特，差额为-4,000 沙特，即法棍的价格。为了简化示例，我特意省略了这笔交易中的采矿费。

### payjoin 的目的是什么？

payjoin 交易实现了两个目标，使用户能够提高支付的私密性。

首先，payjoin 的目的是通过在链分析中制造诱饵来误导外部观察者。这要归功于 CIOH 启发式（*共同输入所有权启发式*）。正如我们在第 3 部分中所看到的，通常情况下，当区块链上的一笔交易有多个输入时，会假定所有这些输入都属于同一个实体或用户。

因此，当分析人员检查支付连接交易时，他们会认为所有的输入都来自同一个人。然而，这种看法是错误的，因为收款人也与实际付款人一起提供了投入。因此，对链式分析的理解就会发生偏差，而这种偏差被证明是错误的。

让我们回到支付长棍面包的 payjoin 交易示例：

![BTC204](assets/notext/61/02.webp)

看到区块链上的这笔交易，外部观察者按照链分析的通常启发式方法会将其解释如下："*Alice在交易输入中合并了2个UTXO，向Bob支付了19000萨特*"。

![BTC204](assets/en/61/03.webp)

这种解释显然是不正确的，因为大家已经知道，输入中的两个 UTXO 并不属于同一个人。一个来自买法棍的爱丽丝，另一个来自面包师鲍勃。

![BTC204](assets/notext/61/04.webp)

这样，外部观察员的分析就会指向一个错误的结论，从而确保利益相关者的保密性。

### 加密交易

支付连接的第二个目的是欺骗外部观察者，使其不知道实际支付的金额。通过研究交易结构，分析人员可能会认为支付的金额等同于其中一个输出的金额。

如果我们再来看看买法棍的例子，分析员会认为付款金额要么与 6000 萨特的UTXO 对应，要么与 19000 萨特的UTXO 对应。在这种情况下，分析师更有可能认为支付的金额是 19 000 萨特，因为输出中有 2 个UTXO，其中至少有一个大于 6 000 萨特（使用 2 个UTXO 支付 6 000 萨特在逻辑上是不合理的，因为单个UTXO 就足以支付这笔款项）。

![BTC204](assets/en/61/05.webp)

但实际上，这种分析是不正确的。付款额与任何产出都不对应。它实际上是收款人在产出中的 UTXO 与收款人在投入中的 UTXO 之间的差额。

![BTC204](assets/en/61/06.webp)

在这一点上，payjoin 交易属于隐写术的范畴。它可以将交易的真实金额隐藏在作为诱饵的虚假交易中。

隐写术是一种将信息隐藏在其他数据或物体中，使人无法察觉隐藏信息存在的技术。例如，可以将秘密信息隐藏在无关文字的圆点中，使肉眼无法察觉（这就是 [微点](https://fr.wikipedia.org/wiki/Micropoint) 的技术）。

加密使信息在没有解密密钥的情况下无法被理解，而隐写术则不同，它不会改变信息。它仍然处于众目睽睽之下。它的目的是隐藏秘密信息的存在，而加密虽然没有密钥就无法获取，但却清楚地揭示了隐藏信息的存在。这就是为什么 payjoin 最初的名称是 "*隐写交易*"。

可以将密码学与 "硬币接合 "以及隐写术与 "付费接合 "进行类比。事实上，coinjoin 具有与加密类似的属性：方法可以识别，但信息无法破译。相反，付费连接则类似于隐写术：理论上可以获取信息，但由于其隐藏方法无法识别，因此信息变得无法获取。

### 如何使用 payjoin？

支持 payjoin 的已知软件有 Sparrow Wallet、Wasabi Wallet、Mutiny、BitMask、BlueWallet 和 JoinMarket，以及支付处理器 BTCPay。

![BTC204](assets/notext/61/07.webp)

最先进的 payjoin 实现只是 Samourai 钱包上的 Stowaway。然而，自从软件创始人被捕后，这个工具现在只能部分运行。Stowaway 的优势在于它是一个完整且非常简单易用的协议，同时支持接收和发送 payjoin。部分签名交易可以通过扫描多个二维码手动交换，也可以通过 Soroban 在 Tor 上自动交换。目前停止服务的正是后一种通信方式。

![BTC204](assets/notext/61/08.webp)

使用 payjoin 的困难在于它依赖于商家的参与。作为顾客，如果商家不支持 payjoin，就无法使用。这就给购物增加了额外的困难：不仅寻找接受比特币的商家很复杂，如果还要寻找那些支持 payjoin 的商家，那就更复杂了。

解决的办法是使用交易结构，在链分析中引入模糊性，而不需要收款人的合作。这样，我们就可以在不依赖商家积极参与的情况下提高支付的私密性。这正是我们将在下一章研究的内容。

https://planb.network/tutorials/privacy/on-chain/payjoin-sparrow-wallet-087a0e49-61cd-41f5-8440-ac7b157bdd62
https://planb.network/tutorials/privacy/on-chain/payjoin-samourai-wallet-48a5c711-ee3d-44db-b812-c55913080eab
## 支付迷你金币

<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

如果想在进行支付交易的同时保留一定的隐私，payjoin 是一个不错的选择。但正如我们所看到的，payjoin 需要收款人的参与。如果收款人拒绝参与 payjoin，或者你根本不想让他们参与，该怎么办呢？另一种办法是使用石墙或石墙 x2 交易。让我们仔细看看这两种交易。

### 石墙交易

石墙 "是比特币交易的一种特殊形式，旨在通过模仿两个人之间的伪比特币连接来增加用户在消费过程中的隐私，但实际上并不是两个人。事实上，这种交易并不是协作性的。用户可以单独构建它，只将自己拥有的UTXO作为输入。因此，您可以在任何场合创建 "石墙 "交易，而无需与其他用户或收款人同步。

石墙交易的操作如下：在交易的输入端，发送方使用属于自己的 2 个UTXO。在输出端，交易产生 4 个UTXO，其中 2 个的金额完全相同。另外 2 个UTXO 将构成变化。在这 2 个金额相同的输出中，只有一个会实际支付给收款人。

石墙交易中只有两种角色：


- 付款的发件人；
- 收件人可能不知道交易的具体性质，只是在等待发件人付款。

让我们举个例子来理解这种交易结构。爱丽丝在面包师鲍勃那里买了一条 4000 萨特的法棍。她既想用比特币支付，又想保持一定的支付隐私。因此，她决定构建一个石墙交易。

![BTC204](assets/notext/62/01.webp)

分析这笔交易，我们可以看到面包师鲍勃确实收到了 4000 萨特的长棍面包付款。爱丽丝使用了 2 个UTXO 作为输入：一个是 10,000 萨特，一个是 15,000 萨特。在产出中，她收到了 3 个UTXO：一个 4000 萨特，一个 6000 萨特，一个 11000 萨特。因此，爱丽丝在这次交易中的净余额为 -4,000 沙特，正好与长棍面包的价格相符。

在这个例子中，为了便于理解，我故意忽略了挖矿费用。实际上，交易费用完全由发送者承担。

### 石墙交易的目标是什么？

石墙结构为交易增加了大量熵，模糊了链式分析的轨道。从外观上看，这种交易可以解释为两个人之间的迷你币合并。但实际上，这是一种支付。因此，这种方法会在链分析中产生不确定性，甚至导致错误追踪。

让我们回到爱丽丝在面包师鲍勃家的例子。区块链上的交易是这样的

![BTC204](assets/notext/62/02.webp)

外部观察者根据普通链分析启发式可能会得出错误的结论："*两个人进行了一次小规模的硬币合并，每个人输入一个UTXO，每个人输出两个UTXO*"。从外部对这笔交易进行分析，并不能得出共同输入所有权启发式（CIOH）的应用结论，因为两笔相同金额的输出的存在表明了一种联合模式。因此，从外部角度看，共同投入所有权启发式不适用于这一具体情况。

![BTC204](assets/notext/62/03.webp)

这种解释并不准确，因为大家都知道，一个UTXO 发送给了面包师鲍勃，输入中的 2 个UTXO 来自爱丽丝，而她检索到了 3 个变化输出。

![BTC204](assets/notext/62/04.webp)

石墙公司的交易结构尤其有趣的是，从外部观察者的角度来看，它与石墙公司的 X2 交易结构一模一样。

### 石墙 x2 交易

石墙 x2 是比特币交易的另一种特殊形式，其目的也是在消费过程中增加用户隐私，但这次是通过与不参与消费的第三方合作来实现的。这种方法的工作原理类似于两个参与者之间的伪比特币连接，同时向第三者付款。

石墙 x2 交易的操作相对简单：一个人使用自己拥有的 UTXO 进行支付，并寻求第三方的帮助，后者也使用自己拥有的 UTXO 进行支付。交易结束时会有四笔输出：其中两笔金额相等，一笔输出到收款人的地址，另一笔输出到属于合作者的地址。第三个UTXO 返回到合作者的另一个地址，使他们能够收回初始金额（对他们来说是一个中性的行为，减去了挖矿费用），最后一个UTXO 返回到属于我们的地址，这构成了付款的变更。

因此，在石墙 x2 交易中定义了三种不同的角色：


- 汇款人，实际付款人；
- 收件人可能不知道交易的具体性质，只是等待发件人付款；
- 合作者提供比特币，在交易分析中提出质疑，同时在交易结束时全额收回资金（对他们来说是中性行为，扣除挖矿费用）。

让我们回到爱丽丝的例子，她在面包师鲍勃那里买了一条长棍面包，价格是 4000 萨特。她既想用比特币支付，又想保持一定的支付隐私。于是，她找到了她的朋友查尔斯（Charles），他将在这个过程中帮助她。

![BTC204](assets/notext/62/05.webp)

分析这笔交易，我们可以看到面包师鲍勃确实收到了 4000 萨特的长棍面包货款。爱丽丝投入了 10,000 萨特，产出了 6,000 萨特，净余额为-4,000 萨特，相当于长棍面包的价格。至于查尔斯，他投入了 15 000 萨特，得到了两笔产出：一笔是 4 000 萨特，另一笔是 11 000 萨特，余额为 0。

在这个例子中，为了便于理解，我故意忽略了费用。实际上，采矿费一般由支付发行方和合作方平摊。

### 石墙 x2 交易的目标是什么？

与 "石墙 "结构一样，"石墙 x2 "结构也为交易增加了大量熵，并掩盖了链式分析的踪迹。从外部视角来看，这样的交易可以被解释为两个人之间的小额硬币兑换。但实际上，这是一种支付。因此，这种方法会在链式分析中产生不确定性，甚至导致错误追踪。

让我们重温一下爱丽丝、面包师鲍勃和查尔斯的例子。区块链上的交易是这样的

![BTC204](assets/notext/62/06.webp)

外部观察者根据共同链分析启发式可能会错误地得出结论："*艾丽丝和查尔斯进行了一次小规模的联 合交易，输入各为一个UTXO，输出各为两个UTXO*"。同样，从外部对这笔交易进行分析并不能得出共同输入所有权启发式（CIOH）的应用结论，因为两笔相同金额的输出的存在表明了一种合拼模式。因此，从外部角度看，共同投入所有权启发式不适用于这一具体情况。

![BTC204](assets/notext/62/07.webp)

这种解释是不准确的，因为大家都知道，一个UTXO被发送给了面包师鲍勃，爱丽丝只有一个变化输出，而查尔斯有两个。

![BTC204](assets/notext/62/08.webp)

同样，石墙 x2 交易结构的特别之处在于，从外部观察者的角度来看，它与石墙交易结构一模一样。

### 石墙 "和 "石墙 x2 "有什么区别？

石墙 X2 交易的操作与石墙交易完全相同，只是前者是协作式的，而后者不是。正如我们所看到的，"石墙 X2 "交易有第三方（查尔斯）的参与，他不参与支付，并提供比特币来提高交易的保密性。在典型的石墙交易中，合作者的角色由发送者承担。

![BTC204](assets/notext/62/09.webp)

因此，从外部来看，交易模式是完全一样的。

![BTC204](assets/notext/62/10.webp)

这两种交易结构具有完全相同的模式，这意味着即使外部观察者能够识别出 "石墙（x2）" 模式，他们也无法获得所有信息。他们无法确定两个相同金额的 UTXO 中哪一个与付款相对应。此外，他们也无法确定输入的两个 UTXO 是来自两个不同的人（石墙 x2），还是属于合并了它们的同一个人（石墙）。

最后一点是由于 "石墙 x2 "交易与 "石墙 "交易的模式完全相同。从外部看，如果没有关于背景的额外信息，就不可能区分石墙交易和石墙 x2 交易。然而，前者不是合作交易，而后者是合作交易。这就更增加了对其中一种交易进行分析的疑点。

### 何时使用石墙和石墙 x2 交易？

如果要在交易中使用隐私工具，逻辑应该如下：


- 可以优先选择付费加入；
- 如果商家不支持 payjoins，则可以使用石墙 x2 结构在支付之外与他人进行合作交易；
- 如果找不到人进行 "石墙 x2 "交易，可以单独进行 "石墙 x2 "交易，这将模仿 "石墙 x2 "交易的行为。

### 如何使用石墙和石墙 x2 交易？

石墙 "和 "石墙 x2 "交易可在 Samourai 钱包应用程序和 Sparrow 钱包软件上进行。

![BTC204](assets/notext/62/11.webp)

然而，与 payjoins 一样，在 Samourai 创始人被捕后，石墙 x2 交易现在只能通过相关各方之间手动交换 PSBT 来进行。遗憾的是，目前还不能通过 Soroban 进行自动交换。

也可以通过任何比特币钱包软件手动执行此类交易。

在下一章中，我们将研究另一种相对未知的隐私技术，但它对我们已经研究过的技术非常有用。

https://planb.network/tutorials/privacy/on-chain/stonewall-033daa45-d42c-40e1-9511-cea89751c3d4
https://planb.network/tutorials/privacy/on-chain/stonewall-x2-05120280-f6f9-4e14-9fb8-c9e603f73e5b
## 回弹

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

使用比特币交易结构，在链分析中增加模糊性，如coinjoin，特别有利于隐私保护。然而，正如我们在 "payjoins "一章中所讨论的，coinjoin 交易在链上是自然可识别的。请记住我们在加密和联币之间建立的类比：当一个人加密一个文件时，发现该加密文件的第三方无法访问其内容，但可以清楚地识别出该文件曾被修改以隐藏其内容。币值合并也是如此：当分析人员检查币值合并交易时，虽然他们无法在输入和输出之间建立直接联系（反之亦然），但他们可以识别出观察到的交易是币值合并。

根据您的硬币在经历接币周期后的预期用途，它经历了这一过程的事实可能会造成问题。例如，如果您计划在受监管的交易所平台上出售您的硬币，但它最近经历了一次接币，平台的链分析工具就会检测到这一事实。这时，平台可能会拒绝接受您已进行过接币的 UTXO，甚至要求您做出解释，您的账户有可能被暂停或资金被冻结。在某些情况下，平台可能还会将您的行为报告给国家机关（例如，法国 TRACFIN 要求数字资产服务提供商 (PSAN) 必须这样做）。

![BTC204](assets/notext/63/01.webp)

为了避免这种情况，我们需要一种能够模糊比特币过去痕迹的工具，以恢复某种形式的可替代性。这正是 "反弹 "的目标。

![BTC204](assets/notext/63/02.webp)

### 什么是跳弹？

Ricochet 是一种技术，涉及对自己（扫码）进行若干虚假交易，以模拟比特币所有权的转移。这种工具不同于我们讨论过的其他交易结构，因为它不允许预期匿名，而是一种追溯匿名。事实上，"反弹 "可以模糊比特币的具体细节，因为这些细节可能会影响比特币的可替代性。

为了模糊过去事件在硬币上留下的印记，例如硬币连接周期，反弹会执行四次连续交易，用户在不同地址向自己转账。

![BTC204](assets/en/63/03.webp)

经过这一系列交易后，跳转工具最终会将比特币送往最终目的地，如交易所平台。

![BTC204](assets/en/63/04.webp)

这样做的目的是拉开影响硬币可替代性的距离，例如硬币连接交易，以及可能因其过去而拒绝该硬币的最终消费行为。因此，链式分析工具可能会得出结论：在事件发生后，硬币的所有权可能发生了变更，并认为这枚硬币是可替代的。在 "接币 "的情况下，链分析工具可能会认为发送比特币和进行 "接币 "的不是同一个人，因此没有必要对发送者采取行动。

![BTC204](assets/notext/63/05.webp)

### 为什么会这样？

面对这种跳弹方法，人们可能会认为链分析软件会在四跳之后进行更深入的检查。然而，这些平台在优化检测阈值时面临两难选择。它们必须对跳转的次数设定一个限制，在这个限制之后，它们就会承认很可能发生了所有权变更，与之前事件（如硬币连接）的联系应被忽略。

![BTC204](assets/en/63/06.webp)

然而，确定这一阈值是有风险的：观察到的跳转次数每增加一次，都会以指数形式增加误报的数量，也就是说，被错误地标记为事件参与者的个人，其操作却是由其他人执行的。这种情况对这些公司构成了重大风险，因为误报会导致不满，从而将受影响的客户推向竞争对手。从长远来看，过宽的检测阈值会导致平台失去比竞争对手更多的客户，从而威胁到平台的生存。因此，对于这些平台来说，增加观察到的跳转次数很复杂，通常 4 次跳转就足以反驳它们的分析。

这里观察到的现象与六度分隔理论有些类似。

六度分隔理论认为，地球上任何一个人都是通过不超过六个中间人的熟人关系链与其他人联系在一起的。要联系世界上任何一个人，只需经过六个人，每个人都认识下一个人。

比特币交易也有类似的现象。通过追踪足够数量的比特币交易，人们最终不可避免地会遇到币合。跳转法利用了这一原理，使用的跳转次数高于交易所平台可以合理跟踪的次数。如果平台决定追踪更多的交易，那么就可以简单地增加一个跳数来规避这一措施。

### 何时以及如何使用跳弹？

当需要掩盖之前参与自己拥有的UTXO的合并币时，是最常见的跳票情况。在理想情况下，最好避免向受监管的实体转移已进行过合并上币的比特币。然而，在没有其他选择的情况下，特别是在急需将比特币变现为法定货币的情况下，"跳转 "提供了一个有效的解决方案。

这种方法不仅对钱币接合有效，而且对任何其他可能影响钱币可替代性的标记也有效。

这种跳转方法的创意最初来自 Samourai Wallet 的团队，他们将其整合到自己的应用程序中，实现了流程自动化。这项服务是通过 Samourai 支付的，因为一次跳转除了挖矿费用外，还需要支付 100,000 萨特的服务费。因此，建议大额转账时使用。

![BTC204](assets/notext/63/07.webp)

Samourai 应用程序提供两种不同的跳弹：


- 增强型跳转，即 "交错交付"，其优点是将 Samourai 服务费分摊到连续五笔交易中。这种方法还能确保每笔交易在不同的时间进行广播，并记录在不同的区块中，从而尽可能地模拟所有权变更的行为。虽然速度较慢，但对于那些不着急的人来说，这种方法更可取，因为它通过加强对链式分析的抵抗力，最大限度地提高了跳转的效率；

![BTC204](assets/notext/63/08.webp)


- 传统的跳弹，旨在通过在短时间内广播所有交易来快速执行操作。因此，与增强型方法相比，这种方法的私密性较差，抗分析能力较低。它只能用于紧急发送。

![BTC204](assets/notext/63/09.webp)

跳转只是将比特币发送给自己。完全可以在任何钱包软件上手动执行跳转，无需使用专门的工具。只需连续向自己发送相同的比特币，每次使用一个新的空白地址即可。

在下一章中，我们将探讨不同的秘密财产转移技术。这些方法在操作和结果上都与我们迄今为止研究过的方法截然不同。

https://planb.network/tutorials/privacy/on-chain/ricochet-e0bb1afe-becd-44a6-a940-88a463756589
## 秘密财产转让

<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

在比特币的隐私技术中，还有一种是秘密财产转移。这种方法旨在将比特币的所有权从一个人转移到另一个人，反之亦然，而这种交易在区块链上是不可见的。让我们一起来研究一下现有的不同技术及其优缺点。

### 硬币交换

CoinSwap 基于一个相对简单的概念：它使用智能合约促进两个用户之间比特币所有权的转移，无需信任，也不会在区块链上明确显示这种转移。

![BTC204](assets/notext/64/01.webp)

让我们举一个简单的例子：爱丽丝和鲍勃。爱丽丝拥有 1 枚 BTC，私钥为 $A$，而鲍勃也拥有 1 枚 BTC，私钥为 $B$。理论上，他们可以通过外部通信渠道交换私钥，进行秘密转账。

![BTC204](assets/notext/64/02.webp)

然而，这种天真的方法带来了很高的信任风险。没有什么能阻止爱丽丝在交换后保存一份私人密钥 $A$ 的副本，并在密钥被鲍勃掌握后用它来窃取比特币。

![BTC204](assets/notext/64/03.webp)

此外，没有任何保证能防止爱丽丝接收鲍勃的私人密钥 $B$ 却从未发送她的私人密钥 $A$ 作为回报。因此，这种交换依赖于双方之间的过度信任，在确保安全地秘密转移所有权方面效率低下。

![BTC204](assets/notext/64/04.webp)

为了解决这些问题，并允许互不信任的各方进行交换，我们可以使用智能合约系统。智能合约是一种程序，在满足预定义条件时自动执行，在我们的案例中，它可以确保所有权交换自动进行，而无需相互信任。

为此，我们可以使用 HTLC（*哈希时间锁定合约*）或 PTLC（*点时间锁定合约*）。这两种协议的功能类似，都是使用一个时间锁定系统，保证交换要么成功完成，要么完全取消，从而保护双方资金的完整性。HTLC 和 PTLC 的主要区别在于，HTLC 使用哈希值和预图像来确保交易安全，而 PTLC 使用适配器签名。

在爱丽丝和鲍勃之间使用 HTLC 或 PTLC 进行换币的情况下，交换是安全进行的：要么交换成功，双方都收到对方的 BTC；要么交换失败，双方都保留自己的 BTC。因此，一方不可能欺骗或窃取另一方的 BTC。

> *HTLC 也是用于在闪电网络双向通道上安全路由支付的机制*。
在这种情况下，适配器签名的使用尤其有趣，因为它可以绕过传统的脚本（这是一种有时被称为 "无脚本脚本 "的机制）。这一功能有助于减少与交换有关的费用。适配器签名的另一个主要优点是不要求交易双方使用共同的哈希值，从而避免在某些类型的交换中暴露双方之间的直接联系。

### 适配器签名

适配器签名是一种加密方法，它将一个有效签名与一个附加签名（称为 "适配器签名"）整合在一起，以揭示一段秘密数据。这种机制的设计方式是，只要知道以下 3 个要素中的 2 个：有效签名、适配签名和秘密，就可以推导出缺少的第三个要素。这种方法的一个有趣特性是，如果我们知道对方的适配签名以及与用于计算该适配签名的秘密相关的椭圆曲线上的特定点，我们就可以推导出自己的适配签名，该签名将与相同的秘密相兼容，而无需直接访问秘密本身。

在币币交换中，适配器签名的使用允许参与者之间同时公开两个敏感信息，从而避免了相互信任的需要。让我们以爱丽丝和鲍勃为例来说明这一过程，他们希望交换各自拥有的 1 BTC，但彼此互不信任。他们使用适配器签名来消除交换中的信任需求。下面是他们的操作过程：


- 爱丽丝通过创建一个向鲍勃发送 1 BTC 的交易 $m_A$ 来启动交换。她使用自己的私人密钥 $p_A$ ($P_A = p_A \cdot G$) 、nonce $n_A$ ($N_A = n_A \cdot G$) 和秘密 $t$ ($T = t \cdot G$) 生成一个签名 $s_A$，以验证这笔交易：

$$s_A = n_A + t + H(N_A + T \parallel P_A \parallel m_A) \cdot p_A$$


- 爱丽丝通过从其真实签名 $s_A$ 中减去秘密 $t$ 来计算适配器签名 $s_A'$：

$$s_A' = s_A - t$$


- 爱丽丝向鲍勃发送她的适配器签名 $s'_A$、她的未签名交易 $m_A$、与秘密对应的点（$T$）和与非 Cce 对应的点（$N_A$）。这些元素构成了所谓的 "*适配器*"。值得注意的是，仅凭这些信息，鲍勃无法恢复爱丽丝的 BTC。
- 然而，鲍勃有能力验证爱丽丝是否试图窃取他的信息。为此，他会检查爱丽丝的适配签名 $s_A'$ 是否与提议的交易 $m_A$ 相对应。如果下式正确，他就可以确定爱丽丝的适配器签名是有效的：

$$s_A' \cdot G = N_A + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$


- 这一验证为 Bob 信心十足地进行交易提供了充分保证。然后，他创建自己的交易 $m_B$，打算向爱丽丝发送 1 BTC，并生成自己的适配签名 $s_B'$，该签名也将与相同的秘密 $t$ 相关联。此时，只有爱丽丝知道 $t$ 的值；鲍勃只知道爱丽丝传送给他的相应点 $T$：

$$s_B' = n_B + H(N_B + T \parallel P_B \parallel m_B) \cdot p_B$$


- 鲍勃向爱丽丝传送他的适配器签名 $s_B'$、未签名的交易 $m_B$，以及与秘密相对应的点 ($T$) 和与非 Cce 相对应的点 ($N_B$)。知道秘密 $t$ 的爱丽丝现在可以将鲍勃的适配签名 $s_B'$ 与该秘密结合起来，为交易 $m_B$ 生成有效签名 $s_B$，从而将鲍勃的 BTC 转给她：

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \parallel P_B \parallel m_B) \cdot P_B$$


- 爱丽丝在比特币区块链上广播此签名交易 $m_B$，以收回鲍勃承诺的 BTC。当鲍勃在区块链上看到这笔交易时，他可以提取签名 $s_B = s_B' + t$。有了这些信息，鲍勃就能分离出他需要的著名秘密 $t$：

$$t = (s_B' + t) - s_B' = s_B - s_B'$$


- 事实上，鲍勃从爱丽丝的适配器签名 $s_A'$ 生成有效签名 $s_A$ 时，唯一缺少的就是这个秘密 $t$。这个签名可以验证从 Alice 发送 BTC 到 Bob 的交易 $m_A$。然后，Bob 计算出 $s_A$，进而在区块链上广播交易 $m_A$：

$$s_A = s_A' + t$$

$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$

让我们来总结一下适配器签名在换币交易中是如何工作的。一开始，爱丽丝会给鲍勃发送一个未签名的交易和一个适配器，这样鲍勃就可以验证稍后透露的秘密是否能让他获得比特币。作为回报，鲍勃向爱丽丝发送他自己的未签名交易和适配器。然后，爱丽丝就可以通过广播一个使用该秘密的有效交易来完成鲍勃的交易并收回比特币。当该交易在区块链上发布时，鲍勃就有能力提取该秘密，从而解锁爱丽丝的交易。因此，如果爱丽丝对鲍勃的比特币发起转账，鲍勃反过来也可以访问爱丽丝的比特币，而无需相互信任。

值得注意的是，换币最早是由 [Gregory Maxwell 于 2013 年 10 月在 BitcoinTalk](https://bitcointalk.org/index.php?topic=321228.0) 上提出的。

### 原子交换

与币币交换类似，使用相同类型的智能合约，也可以进行原子交换。原子交换允许两个用户直接交换不同的加密货币，如 BTC 和 XMR，而无需信任或中介的干预。这些交换之所以被称为 "原子交换"，是因为它们只有两种可能的结果：要么交换成功，双方都满意；要么交换失败，双方都保留各自原有的加密货币，从而无需信任对方。

![BTC204](assets/notext/64/05.webp)

原子交换和硬币交换有着相似的操作方法，在隐私方面也有着相同的优缺点。事实上，从比特币的角度来看，原子交换相当于分两步进行的换币。首先，我们将自己的 BTC 兑换成另一种加密货币，然后再用这种加密货币兑换其他 BTC。最终，我们收回另一个用户的 BTC。这就是为什么在分析隐私问题时，我将这两个协议归为所有权秘密交换类别的原因。

![BTC204](assets/notext/64/06.webp)

然而，与硬币交换不同，原子交换在可用流动性方面可能存在不平衡，特别是在 BTC/XMR 交易所。一般来说，将比特币兑换成替代币比较容易，因为比特币的需求量大，这使得这种兑换方向的溢价较低。然而，由于需求量较低，用替代币兑换 BTC 可能会更加复杂，往往会导致很高的溢价。

最后，当原子交换涉及链上比特币和闪电网络上的比特币时，我们称之为 "*潜艇交换*"。

### 它真的有用吗？

秘密财产转移，如硬币交换和原子交换，具有欺骗链分析启发法的优势。这些方法会给人一种交易涉及同一用户的印象，即使实际所有权已经易手。然而，这些方法的主要缺点是，如果不使用额外的技术来破坏硬币的历史记录，风险就会非常大。

事实上，当爱丽丝与鲍勃进行换币或原子交换时，她将自己的比特币所有权与鲍勃的进行交换。在原子交换的情况下，交换包括一个替代币，但原理是一样的。因此，爱丽丝最终得到的是 B$ 币，而鲍勃得到的是 A$ 币。这增加了链式分析中的疑点，但币的历史仍然是可追溯的。如果分析人员检查 A 币，他们可以追溯到 Alice 之前的活动，反之亦然。

![BTC204](assets/en/64/07.webp)

从爱丽丝的角度来看，风险在于某些实体可能会认为 $B$ 硬币的历史可疑。例如，如果鲍勃通过黑客等犯罪行为获得了 B 币，那么该币就会与他的非法活动联系在一起。这样一来，爱丽丝就会发现自己拥有了一枚硬币，她无法在受监管的交易所平台上进行转移，否则她的资金就有可能被冻结，甚至会被指控与鲍勃的犯罪行为有关，尽管她与这些犯罪行为毫无关系。

![BTC204](assets/en/64/08.webp)

当然，像币币交换或原子交换这样的隐私保护方法也受到资金被当局监控的犯罪分子的青睐。这些协议为他们提供了处理被监控比特币的机会，以换取完全可替代的比特币。这还能让他们声东击西，将当局引向其他用户。因此，对这些人来说有双重用途。

有了 Coinjoin，即使你的币与被监控的比特币混在一起，币的历史也会被打破，这就提供了一种似是而非的可抵赖性，而这在换币或原子交换等秘密财产转移协议中是不存在的。

![BTC204](assets/notext/64/09.webp)

如果爱丽丝想避免任何风险，她就必须使用一种方法来破坏硬币 $B$ 的历史，例如通过硬币接合等。这就提出了一个问题：将所有权的秘密转移和硬币连接结合起来是否有用？硬币接合通过破坏硬币的历史记录，已经为爱丽丝提供了足够的隐私保护。因此，我认为，如果爱丽丝想要保护自己的隐私，直接进行硬币合并比先进行硬币交换再进行硬币合并更稳妥。

要使秘密所有权转移方法真正有效，并避免将用户 $A$ 的历史与用户 $B$ 联系起来的风险，矛盾的是，这些方法的使用必须广为人知。如果硬币交换被大量使用，并且当局知道这种普遍做法，那么就可以建立一种似是而非的推诿形式。然而，只要这些转账的使用仍处于边缘状态，我相信这些方法对用户来说仍将是风险太大。

到目前为止，我们主要研究了交易层面的隐私保护方法。下一章，我们将探讨网络层面和交易传播层面的问题。

## P2P 网络隐私

<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

在第 4 部分中，我们讨论了使用完整节点保护交易隐私的重要性。然而，重要的是要明白，你的节点本身也可能受到攻击，试图获取你的活动信息。因此，在本章中，我们将研究不同的隐私保护措施，但不是在交易本身或比特币流动层面，而是在网络层面。

### 蒲公英

避免各种去匿名化攻击的一种方法是使用蒲公英提案。这一广播协议在 BIP156 中正式提出，但从未在比特币上实施过。

蒲公英的理念是提高比特币网络中交易路由的私密性，以应对各种形式的攻击。它的主要目标是隐藏最初在网络上广播交易的源节点。该节点的披露可以将比特币交易与特定的 IP 地址联系起来（如果该节点在清算网上运行），从而为链分析提供切入点。

比特币上的活动与 IP 地址之间的这种关联给用户的隐私带来了巨大风险。事实上，许多实体都可以轻易地将 IP 地址与个人身份联系起来。这主要包括政府和互联网服务提供商。此外，这些信息可能会被公开，例如，如果你的 IP 地址和个人数据因网站数据库被黑客攻击而泄露。

在比特币的标准操作中，用户在其钱包软件上创建的交易会传输到其个人节点。该节点会立即向其连接的所有对等节点广播新的交易。

![BTC204](assets/notext/65/01.webp)

然后，这些对等方对交易进行验证，确保其符合共识规则和本地标准化规则。一旦验证通过，每个对等节点就会依次将交易传送给自己的对等节点，以此类推。

![BTC204](assets/notext/65/02.webp)

待整合到区块中的交易分布是以一种相当平衡且在统计上可预测的方式进行的。这种漏洞可被串通一气的间谍节点利用，这些节点合作监控和分析网络，以识别第一个广播交易的节点。如果观察者成功找到源节点，他们就可以认为交易来自该节点的操作者。这种观察可以将通常匿名的交易与特定的 IP 地址联系起来。

![BTC204](assets/notext/65/03.webp)

BIP156 的目标就是解决这个问题。为此，它在新交易的广播中引入了一个额外阶段，以在广泛公开传播之前保持匿名性。蒲公英首先使用一个 "茎 "阶段，在此阶段，交易通过节点的随机路径发送。

![BTC204](assets/notext/65/04.webp)

然后在 "蓬松 "阶段向整个网络广播交易。

![BTC204](assets/notext/65/05.webp)

茎和绒毛是指交易在网络中传播的行为，类似蒲公英的形状。

因此，间谍节点有可能将交易追溯到启动蓬松阶段（大规模广播）的节点，但该节点并不是首次广播交易的节点，因为它是从干系中的最后一个节点接收的。如果间谍节点无法追溯到干节点，它们也就无法识别源节点。

![BTC204](assets/notext/65/06.webp)

即使在干节点阶段存在间谍节点，疑虑也始终存在，因为间谍一旦遇到扩散图中的诚实节点，就无法确定该节点是原始源还是只是一个中间节点。

![BTC204](assets/notext/65/07.webp)

这种路由方法模糊了通往源节点的踪迹，使交易难以通过网络追溯到其源头。因此，蒲公英通过限制对手对网络进行去匿名化的能力来提高隐私性。当交易在 "茎 "阶段穿过一个对网络通信进行加密的节点（如 Tor 或 P2P Transport V2）时，这种方法会更加有效。

BIP156 尚未集成到比特币核心中，目前被归类为 "拒绝 "状态。该协议的主要问题之一在于，在茎阶段，交易必须先由中间节点转发，然后再进行验证。正如我们所看到的，在比特币的正常模式中，每个节点首先要验证交易，然后再将其转发给同行。如果交易不符合该节点的共识规则或本地标准化规则，它就会忽略并不广播该交易。这一过程对于抵御 DoS 攻击非常重要，因为只有有效的交易才会被广播到整个网络。无效交易可能会大量产生，导致网络超载，但会在遇到的第一个节点处停止，不会传播。蒲公英的主要风险在于，这种新协议允许在部分网络中广播无效交易，从而为 DoS 攻击引入了新的载体。

### P2P 传输 V2

P2P 传输 V2 是 BIP324 中提出的另一个网络协议。它是比特币 P2P 传输协议的一个新版本，采用了机会加密技术，以提高节点间通信的保密性和安全性。

这一改进旨在解决 P2P 协议基本版本的几个问题。一方面，它使被动观察者无法区分所交换的数据与互联网上流通的其他类型的数据。主要目的是防止政府、互联网服务提供商或 VPN 提供商大规模监控比特币用户。这也使这些实体确定互联网用户是否也是比特币用户，即他们是否在操作一个完整节点的任务变得更加复杂。

P2P V2 还可通过检测数据包中的特定模式来降低审查和攻击风险。在网络层面，P2P V2 使各种类型的 Sybil 攻击变得更加复杂，执行成本更高。Sybil 攻击是指行为者为获得不当优势而制造多个虚假身份。在比特币网络中，这通常表现为一个行为者控制了大量的完整节点，并利用它们来增加连接数。Sybil攻击可以是被动的，目的是收集信息和破坏用户机密；也可以是主动的，表现为Eclipse攻击。后者将特定节点与网络的其他部分隔离开来，从而可以审查用户或更改他们收到的数据。最后，P2P V2 还使 "中间人"（MITM）攻击成本更高，更容易被发现。

P2P V2 实现的加密不包括身份验证，以免增加不必要的复杂性，也不会损害网络连接的无许可性质。不过，这种新的 P2P 传输协议能更好地防范被动攻击，并大大提高主动攻击的成本和可探测性。在网络信息中引入伪随机数据流，使希望审查或操纵通信的攻击者的任务变得更加复杂。

在 2023 年 12 月部署的 Bitcoin Core 26.0 版本中，P2P V2 传输被列为一个选项（默认禁用）。在 2024 年 4 月的 27.0 版本中，它被默认启用。可以通过配置文件中的 `v2transport=` 选项进行修改。

### 托尔

在网络层面避免节点失密风险的另一个相对简单的解决方案是完全在 Tor 下运行。

Tor 是一个由中继服务器（节点）组成的网络，用于匿名处理互联网上 TCP 连接的来源。它的工作原理是对数据进行多层加密封装。每个中继节点都会移除一层，以显示下一个节点的地址，直至到达最终目的地。Tor 网络通过防止中间节点知道数据的来源和目的地来确保匿名性，从而使观察者很难追踪用户的活动。

![BTC204](assets/notext/65/08.webp)

因此，Tor 不仅可以对通信数据进行加密，还可以掩盖通信的来源和目的地。通过在个人节点的通信中使用 Tor，我们提高了交易的私密性：互联网服务提供商（ISP）无法解密通信，比特币网络中的其他节点也无法识别源节点的 IP 地址。此外，Tor 还可以向 ISP 隐藏你使用比特币的情况。

这种方法的主要风险在于 Tor 是一个独立于比特币的协议。如果你在 Tor 下有一个比特币节点，而 Tor 停止工作，那么你的比特币节点将无法再进行通信。

此外，需要注意的是，通过 Tor 进行通信的速度较慢。由于初始区块下载（IBD）需要大量通信，这种延迟在节点初始启动时尤其令人头疼。因此，使用 Tor，你与比特币网络的初始同步时间会大大延长。也可以在清网上执行 IBD，然后再激活 Tor。虽然这种方法会向你的互联网服务供应商透露你的比特币节点的存在，但它可以在你切换到 Tor 后保护与你的个人交易相关的信息。

在探讨了不同的网络级隐私保护方法之后，我还想在接下来的章节中介绍两种避免地址重复使用的优雅解决方案：BIP47 和静默支付。

## BIP47 和可重复使用的付款代码

<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

正如我们在第三部分所看到的，地址重复使用对比特币协议的用户隐私造成了严重的障碍。为了降低这些风险，我们强烈建议为钱包中收到的每一笔新付款生成一个新的收款地址。虽然如今使用现代软件和分层确定性钱包可以简化生成新地址的过程，但这种做法似乎有违直觉。

![BTC204](assets/notext/66/1.webp)

例如，在传统的银行系统中，我们习惯于共享我们的 IBAN，而这个 IBAN 始终保持不变。一旦告知他人，他们就可以向我们发送多笔付款，而无需再次与我们互动。新银行还提供了更多现代化的可能性，比如在贝宝（PayPal）上使用唯一的电子邮件地址，或在 Revolut 上使用 RevTags。即使在金融领域之外，我们的日常标识符，如邮政地址、电话号码和电子邮件地址，也都是独一无二的永久性标识符。我们不必在每次新的互动中更新它们。

![BTC204](assets/notext/66/2.webp)

然而，比特币的操作却与此不同：必须为每笔交易生成一个新的接收地址。这种在易用性和隐私性之间的妥协可以追溯到《比特币白皮书》的起源。中本聪在 2008 年底发表第一版文件时，就已经警告过我们这种风险：

**"*作为额外的防火墙，可以为每笔交易使用一对新的密钥，使它们与共同的所有者没有关联。

有许多方法可以在不造成地址重复使用的情况下向一个标识符接收多笔付款。每种方法都有自己的折衷方案和缺点。在这些方法中，BIP47 是由 Justus Ranvier 提出并于 2015 年发布的一项提案。该提案旨在创建可重复使用的支付代码，允许对同一个人进行多次交易，同时避免地址重复使用。从本质上讲，BIP47 试图提供一种与唯一标识符一样直观的支付系统，同时保护交易隐私。

![BTC204](assets/notext/66/3.webp)

BIP47 并没有直接改善用户隐私，因为 BIP47 支付提供的隐私水平与使用新地址的传统比特币交易相同。但是，它使比特币的使用更加方便和直观，而这种方便通常会损害隐私。由于有了 BIP47，这种易用性达到了与传统交易相同的隐私水平。这就是为什么 BIP47 是保护隐私的重要工具。

最初，BIP47 是一项整合到比特币核心中的提案，但从未被采纳。一些软件仍然选择在应用层自行实现。因此，Samourai Wallet 的团队开发了自己的 BIP47 实施方案，名为 "PayNym"。

### BIP47 和 PayNym 的一般原则

BIP47 的目标是在不造成地址重复使用的情况下接收大量付款。它依靠使用可重复使用的支付代码，允许不同的发件人向属于另一个用户的单个代码发送多笔付款。因此，收款人不必为每笔交易提供新的地址，这大大方便了他们的交流，同时也保护了他们的隐私。

![BTC204](assets/en/66/4.webp)

因此，用户可以在社交网络或自己的网站上自由分享自己的支付密码，而不会有失去隐私的风险，这与传统的接收地址或公开密钥不同。

要进行交易，交易双方都必须拥有一个实现了 BIP47 的比特币钱包，如 Samourai Wallet 或 Sparrow Wallet 上的 PayNym。共同使用他们的支付密码会在他们之间建立一个秘密通道。为了有效地建立这个通道，发送方必须在比特币区块链上执行一个特定的交易，即 "通知交易"（稍后我会详细介绍）。

两个用户的支付代码组合在一起就产生了共享秘密，进而可以创建大量唯一的比特币接收地址（正好 2^32，约 40 亿）。因此，通过 BIP47 进行的支付实际上并不是针对支付代码本身，而是针对由相关用户的支付代码衍生出的经典收款地址。

因此，支付代码是由钱包种子衍生出来的虚拟标识符。在钱包的分层衍生结构中，支付密码位于第 3 层，即账户层。

![BTC204](assets/en/66/5.webp)

BIP47 的派生目标由索引 `47'` (`0x8000002F`) 标识，指的是 BIP47。可重复使用支付代码的派生路径示例如下：

```plaintext
m/47'/0'/0'/
```

为了让您了解付款码的样子，下面是我的付款码：

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

该代码还可以编码成 QR 码，以方便通信，就像传统的接收地址一样。

关于 PayNym Bots（有时在 Twitter 上看到的机器人），它们是 Samourai 钱包创建的支付代码的可视化表示。它们是通过哈希函数生成的，因此几乎具有唯一性。它们以一小串以 "+"开头的字符串的形式出现：

```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

这些化身也可以用图像的形式表示：

![BTC204](assets/notext/66/6.webp)

虽然这些机器人在 BIP47 框架内没有特定的技术功能，但它们通过提供易于识别的视觉标识，在促进用户之间的互动方面发挥了作用。

---
*在本章有关 BIP47 的后续章节中，我们将详细介绍其功能，尤其是所使用的加密方法。要完全掌握这些略带技术性的解释，首先必须了解高清钱包的结构、密钥生成过程和椭圆曲线加密的基本原理。如果您希望加深对这些概念的了解，Plan ₿ Network 上还有另一个免费培训课程：**。

https://planb.network/courses/cyp201
*我强烈建议大家学习这本书，因为了解了 BIP47 的技术运作，就会更容易掌握我们将在以下章节讨论的其他类似提案*。

---
### 可重复使用的付款代码

如前所述，可重复使用的支付代码位于 HD 钱包的深度 3，这使其在钱包结构中的位置和作用都与 "xpub "类似。

80 个字节的支付密码细分如下：


- 字节 `0`：版本**。对于 BIP47 的第一个版本，该字节设置为 `0x01`；
- 字节 `1`：位字段**。该空间用于在特定用途中整合附加指示。对于 PayNym 的标准使用，该字节定义为 `0x00`；
- 字节 `2`：y "奇偶校验**。该字节为 `0x02` 或 `0x03`，表示公钥的序号是偶数还是奇数，因为使用的是压缩公钥；
- 从字节 `3` 到字节 `34`：x "值**。这些字节代表公钥的尾数。x "和 "y "奇偶校验的连接构成完整的压缩公钥；
- 从字节 `35` 到字节 `66`：链代码**。此空格包含与公钥相关的链代码；
- 从字节`67`到字节`79`：填充**。该空间用于未来可能的发展。在当前版本中，这里只是简单地放置零，以达到 `OP_RETURN` 输出所需的 80 字节大小。

下面是我在上一节中介绍的可重复使用的支付代码的十六进制表示法：

```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

![BTC204](assets/en/66/7.webp)

首先，还需要在开头添加前缀字节 `P`，以清楚地表明这是一个支付代码。这个字节用 `0x47` 表示：

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

最后，为确保支付密码的完整性，会使用 "HASH256 "进行校验和计算，其中包括使用 "SHA256 "函数进行双重散列。然后，将散列得到的前四个字节连接到支付密码的末尾：

```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

![BTC204](assets/en/66/8.webp)

完成这些步骤后，支付代码就准备就绪了。剩下的工作就是将其转换为基数 58，以获得最终版本：

```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

在支付密码创建过程中，我们使用压缩公钥和链码。二者都是从钱包种子的确定性分层衍生而来。实现这一点的推导路径是

```plaintext
m/47'/0'/0'/
```

要为可重复使用的支付密码生成压缩公钥和相关链码，我们首先要从钱包的种子中计算出主私钥。然后，我们使用索引 `47 + 2^31`（加固推导）推导出一对子密钥。在这一步之后，我们还将使用索引 `2^31`（加固推导）连续推导出两对子钥匙。

![BTC204](assets/notext/66/9.webp)

### 椭圆曲线 Diffie-Hellman 密钥交换（ECDH）

BIP47 的核心加密协议是 ECDH，即 *Elliptic-Curve Diffie-Hellman* 的缩写。这种方法是原始 Diffie-Hellman 密钥交换的一种变体。

Diffie-Hellman 密钥协议是 1976 年推出的一种密钥协议，它允许各自配备一对密钥（公开密钥和私人密钥）的双方就共同的秘密达成一致，即使仅通过不安全的公开渠道进行通信。

![BTC204](assets/en/66/10.webp)

然后，这个共享秘密（这里指蓝色密钥）就可以用于其他操作。通常情况下，这个共享秘密可用于在不安全的网络上加密和解密通信：

![BTC204](assets/notext/66/11.webp)

为了实现这种交换，Diffie-Hellman 使用模块算术来计算共享秘密。下面是对其工作原理的简化解释：


- 爱丽丝和鲍勃商定了一种共同的颜色（这里是黄色），这种颜色构成公共数据（攻击者知道这种颜色）；
- 爱丽丝选择了一种神秘的颜色，这里是红色，然后将两种颜色混合得到橙色；
- 鲍勃还选择了一种神秘的颜色（这里是蓝色），并与黄色混合得到绿色；
- 然后，它们交换获得的橙色和绿色。这种交换可以通过不安全的、可观察到的网络进行；
- 爱丽丝将鲍勃的绿色与自己的秘色混合，得到了棕色；
- 鲍勃用爱丽丝的橙色和他的秘密蓝色做同样的运算，也得到了棕色。

![BTC204](assets/en/66/12.webp)

在这个简化过程中，棕色代表爱丽丝和鲍勃之间的共享秘密。重要的是要明白，在现实中，攻击者不可能将橙色和绿色分开，从而发现爱丽丝或鲍勃的秘密颜色。

现在，让我们不使用颜色类比，而是使用实数和模块运算，来研究一下这个协议究竟是如何运行的！

在讨论 Diffie-Hellman 机制之前，请允许我简要提醒大家我们需要的两个基本数学概念：


- 质数**是只有两个除数的自然数：1 美元和它本身。例如，7 美元是一个质数，因为它只能被 1 美元和 7 美元整除。另一方面，8 美元不是质数，因为它能被 1 美元、2 美元、4 美元和 8 美元整除。因此，它有四个正整数除数，而不是两个；
- modulo**（表示为 $mod$ 或 $/%$）是一种数学运算，在两个整数之间，返回前一个整数除以后一个整数的余数。例如，$16 \bmod 5 = 1$。

**爱丽丝和鲍勃之间的迪菲-赫尔曼密钥交换过程如下：**


- 爱丽丝和鲍勃商定了两个共同的数字：$p$ 和 $g$。$p$ 是一个质数，这个数字越大，迪菲-赫尔曼就越安全。$g$是$p$的原始根。这两个数字可以在不安全的网络上公开交流。它们相当于前面简化过程中的**黄色**。因此，爱丽丝和鲍勃必须使用完全相同的 $p$ 和 $g$。
- 确定这些参数后，爱丽丝和鲍勃各自选择一个秘密随机数。爱丽丝将她的秘密随机数命名为 $a$（相当于**红色**），鲍勃将他的秘密随机数命名为 $b$（相当于**蓝色**）。这些数字必须严格保密。
- 双方不直接交换数字 $a$ 和 $b$，而是按如下方式计算 $A$ 和 $B$：

$A$ 等于 $g$ 升至 $a$ 的幂，模为 $p$：

$$
A = g^a \bmod p
$$

$B$等于$g$乘以$b$的幂模，再乘以$p$：

$$
B = g^b \bmod p
$$


- 双方交换值 $A$（相当于**橙色**）和 $B$（相当于**绿色**）。这种交换可以通过不安全的网络公开进行；
- 爱丽丝收到 $B$ 后，计算 $z$ 的值如下：

$z$ 等于 $B$ 升至 $a$ 的幂，模为 $p$：

$$
z = B^a \bmod p
$$

回顾一下

$$
B = g^b \bmod p
$$

因此，我们得到

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

运用指数规则：

$$
(x^n)^m = x^{nm}
$$

于是我们得到

$$
z = g^{ba} \bmod p
$$


- 而鲍勃在收到 $A$ 后，也会以下面的方式计算 $z$ 的值：

$z$ 等于 $A$ 升至 $b$ 的幂，模为 $p$：

$$
z = A^b \bmod p
$$

因此，我们得到

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

由于模运算符的可分配性，爱丽丝和鲍勃得到了完全相同的值 $z$。这个数字代表了他们的共同秘密，相当于之前简化油漆罐时的**棕色**。现在，他们可以使用这个共同的秘密，在不安全的网络上对他们的通信进行对称加密。

![BTC204](assets/notext/66/13.webp)

攻击者即使掌握了 $p$、$g$、$A$ 和 $B$（公共值），也无法计算 $a$、$b$ 或 $z$（私人值）。要做到这一点，就必须将指数化反转，如果不逐一尝试所有可能性，这一操作是不可能完成的，因为这相当于计算离散对数，即有限循环群中指数的倒数。

因此，只要 $a$、$b$ 和 $p$ 的值足够大，迪菲-赫尔曼协议就是安全的。通常情况下，使用 2048 位参数（十进制有 600 位数字），测试 $a$ 和 $b$ 的所有可能性是不切实际的。时至今日，这种算法仍被认为是安全的。

这正是 Diffie-Hellman 协议的主要缺点所在。为了保证安全，算法必须使用大数字。这就是为什么现在人们更喜欢使用 ECDH 算法（*椭圆曲线 Diffie-Hellman*）的原因，它是 Diffie-Hellman 算法的一种变体，依赖于代数曲线，更准确地说，是椭圆曲线。这种方法可以在保持同等安全性的前提下使用更小的数字，从而减少计算和存储所需的资源。

算法的一般原理保持不变。不过，我们不再使用随机数 $a$ 和通过模乘计算得出的数 $A$，而是使用在椭圆曲线上建立的一对密钥。我们不再依赖模运算符的可分配性，而是使用椭圆曲线上的群律，更具体地说是该律的关联性。

简单解释一下椭圆曲线加密法的原理，私人密钥由一个介于 1 美元到 n-1 美元之间的随机数表示，其中，n 美元表示曲线的阶数。而公钥则是该曲线上的一个特定点，根据等式，从生成点开始，通过点加法和倍增运算从私钥中获得：

$$
K = k \cdot G
$$

在这个公式中，$K$ 表示公钥，$k$ 表示私钥，$G$ 表示生成点。

这些密钥的基本特征之一是很容易从 $k$ 和 $G$ 中计算出 $K$，而实际上不可能从 $K$ 和 $G$ 中找到 $k$。这种不对称性产生了一种单向函数。换句话说，如果知道私钥，就很容易计算出公钥，但从公钥中找到私钥是不可能的。这种安全性仍然基于离散对数的计算难度。

我们将利用这一特性来调整我们的 Diffie-Hellman 算法。 **ECDH 的工作原理如下：**


- 爱丽丝和鲍勃共同商定了一条加密安全的椭圆曲线及其参数。这些信息是公开的；
- 爱丽丝生成一个随机数 $ka$，作为她的私人密钥。这个私人密钥必须保密。她通过对所选椭圆曲线上的点进行加法和倍增来确定自己的公开密钥 $Ka$：

$$
K_a = k_a \cdot G
$$


- 鲍勃还会生成一个随机数 $kb$，作为他的私人密钥。他计算出相关的公钥 $Kb$：

$$
K_b = k_b \cdot G
$$


- 爱丽丝和鲍勃通过不安全的公共网络交换他们的公开密钥 $Ka$ 和 $Kb$。
- 爱丽丝用自己的私人密钥 $ka$ 和鲍勃的公开密钥 $Kb$ 计算出曲线上的一个点 $(x,y)$：

$$
(x,y) = k_a \cdot K_b
$$


- 鲍勃用自己的私人密钥 $kb$ 和爱丽丝的公开密钥 $Ka$ 计算出曲线上的一个点 $(x,y)$：

$$
(x,y) = k_b \cdot K_a
$$


- 爱丽丝和鲍勃获得椭圆曲线上的同一个点。共享秘密就是这个点的 x 坐标 $x$。

它们确实获得了相同的共享秘密，因为

$$
(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a
$$

观察不安全公共网络的攻击者只能获得各方的公开密钥和所选椭圆曲线的参数。如前所述，仅凭这些信息还不足以确定私人密钥。因此，攻击者无法找到 Alice 和 Bob 之间的共享秘密。

因此，ECDH 是一种可以进行密钥交换的算法。它通常与其他加密方法结合使用，以建立一个完整的协议。例如，ECDH 被集成到 TLS（*传输层安全*）的核心中，TLS 是用于互联网传输层的加密和验证协议。TLS 使用 ECDHE 进行密钥交换，这是 ECDH 的一种变体，其中的密钥是短暂的，以提供持久的保密性。此外，TLS 还使用 ECDSA 等验证算法、AES 等加密算法和 SHA256 等散列函数。

TLS主要负责 "https "中的 "s "以及浏览器地址栏中的挂锁，这些都是加密通信的标志。因此，通过学习本课程，您就在使用 ECDH，而且很有可能您每天都在使用它而不自知。

### 通知事务

正如我们在上一节中所看到的，ECDH 是 Diffie-Hellman 交换的一种变体，使用的是在椭圆曲线上建立的密钥对。方便的是，我们的比特币钱包中已经拥有许多符合这一标准的密钥对！BIP47 的理念是使用双方的比特币确定性分层钱包中的密钥对，在双方之间建立共享和短暂的秘密。在 BIP47 中，使用的是 ECDHE（*Elliptic Curve Diffie-Hellman Ephemeral*）。

![BTC204](assets/notext/66/14.webp)

BIP47 中首次使用 ECDHE 将付款代码从发送方传送给接收方。这就是著名的**通知交易**。这一步至关重要，因为要使 BIP47 有效工作，相关双方（发送方和接收方）必须知道对方的支付密码。有了这些知识，就可以推导出短暂的公开密钥，从而推导出相关的空白接收地址。

在交换之前，发件人在逻辑上已经知道收件人的支付密码，因为他们已经从链外获取了收件人的支付密码，例如从他们的网站、发票或社交媒体上获取的。但是，收件人不一定知道发件人的付款代码。然而，这个代码必须传送给他们；否则，他们将无法获得识别比特币存储地址所需的短暂密钥，也无法获取他们的资金。虽然发送者代码的传输在技术上可以通过其他通信方式在链外进行，但如果只需要从种子中恢复钱包，这就会造成问题。

事实上，与传统地址不同，BIP47 地址并不是直接从收件人的种子中提取的--在这种情况下，使用 "xpub "会更简单--而是结合了两个支付代码的计算结果：发件人的支付代码和收件人的支付代码。因此，如果收件人丢失了钱包，并试图从种子中恢复钱包，他们将恢复自己的支付密码，而支付密码是直接从种子中得到的。然而，要找到短暂地址，他们还必须拥有所有通过 BIP47 发送比特币的人的支付密码。因此，通知交易就显得尤为重要，它可以将这些信息保存在比特币区块链上，同时又可以非常容易地找到这些信息，而无需在 2009 年比特币发布以来执行的数十亿次交易中进行搜索。

![BTC204](assets/en/66/15.webp)

因此，只要每个用户都保存一份同伴支付密码的备份，就可以在不使用通知交易的情况下实施 BIP47。然而，如果没有一个简单、强大、高效的解决方案来创建、存储和更新这些备份，这种方法的管理就会变得复杂。因此，在当前情况下，通知交易几乎变得不可或缺。

在接下来的章节中，我们将研究目标与 BIP47 类似，但不需要通知交易的其他协议。不过，这些替代方案也有各自的缺点。

除了备份支付密码的作用外，通知交易还具有通知收款人的功能，正如其名称所示。它向收款人的客户端发出信号，表明新的支付渠道已经建立，从而建议对由此产生的短暂地址进行监控。

### BIP 的隐私模式47

在详细介绍通知交易的技术操作之前，有必要先讨论一下与 BIP47 相关的隐私模式，这也是在创建初始交易时采取某些措施的理由。

支付代码本身不会对隐私造成直接风险。传统的比特币模式旨在通过保护密钥和地址的匿名性来切断用户身份与其交易（公开）之间的联系，而支付密码则不同，它可以公开地与用户身份联系在一起，而不会构成威胁。

事实上，付款代码并不是用来直接生成接收 BIP47 付款的地址的。这些地址是通过在相关双方的付款代码派生密钥之间应用 ECDH 生成的。

因此，支付密码本身并不会直接导致隐私权的丧失，因为从支付密码中得到的只是通知地址。虽然这个地址可以透露一些信息，但除非通过彻底的链式分析，否则通常无法发现与您进行交易的各方。事实上，如果发件人使用可与其身份关联的 UTXO 来执行通知交易，那么就有可能推断出他们的身份很可能与向您的支付密码进行的 BIP47 支付有关。这不会揭示潜在的交易，但会表明它们可能存在。

因此，必须严格区分用户的支付密码。为实现这一目标，支付密码的初始通信步骤是保护支付隐私的关键时刻，也是协议正常运行的必要条件。如果其中一个支付密码可以公开获取（如在网站上），那么第二个密码，即发件人的密码，无论如何都不能与第一个密码相链接。

让我们举一个具体的例子：我想通过 BIP47 向一项政治运动捐款：


- 该组织已在其网站上或通过其社交网络公布了其付款代码；
- 因此，该准则与政治运动息息相关；
- 我找回了这个付款码；
- 在继续发送之前，我必须确保他们知道我的支付密码，这也与我的身份有关，因为我用它在社交网络上接收交易。

如何无风险地传输我的代码？使用传统通信手段可能会导致信息泄露，从而将我与这一政治运动联系起来。通知交易提供了一个解决方案，因为它有一个加密层，可以精确地防止两个代码之间的这种关联。虽然这不是秘密传送发件人付款代码的唯一方法，但事实证明它非常有效。

在下图中，橙色线条表示信息流必须中断的点，黑色箭头表示有可能被第三方观察到的连接点：

![BTC204](assets/en/66/16.webp)

实际上，在比特币的传统隐私模式中，要完全分离密钥对和用户之间的信息流通常是很复杂的，尤其是在远程交易中。例如，在捐款活动中，收款人不可避免地要通过网站或社交网络公开地址或公钥。正确使用 BIP47，特别是在通知交易中，可以规避这个问题，这要归功于 ECDHE 和我们将进一步研究的加密层。

当然，比特币的经典隐私模式仍然适用于由两个支付密码组合而成的短暂公钥。这两种模式实际上是互补的。在这里，我想强调的是，与通常使用公钥接收比特币不同，支付密码可以与特定身份联系起来，因为"_Alice 与 Bob 进行交易_"的信息在另一个阶段被破坏了。支付代码用于生成支付地址，但仅凭对区块链的观察，不可能将 BIP47 支付交易与用于执行该交易的支付代码联系起来，除非所涉及的 UTXO 之前已经与某个身份联系起来，并且用户已经将其支付代码与各自的身份联系起来。

总之，BIP47 支付所提供的隐私模式可以说优于比特币的基础模式，尽管它并不神奇。

### 通知交易的构建

现在，让我们来看看这笔通知交易是如何进行的。想象一下，Alice 想用 BIP47 向 Bob 汇款。在我的例子中，爱丽丝是发件人，鲍勃是收件人。后者已在自己的网站上公布了付款代码。因此，爱丽丝已经知道鲍勃的付款代码。

**1- 爱丽丝用 ECDH 计算共享秘密：**


- 她从自己的高清钱包中选择一个密钥对，该钱包位于与支付密码不同的分支上。注意，这对密钥不应轻易与 Alice 的通知地址或 Alice 的身份相关联（见上一节）；
- Alice 从这对密钥中选择私人密钥。我们将其命名为 $a$（小写）；

$$
a
$$


- Alice 检索与 Bob 的通知地址相关的公开密钥。该密钥是鲍勃付款代码（索引 $/0$）的第一个子代。我们将此公钥命名为 $B$（大写）。与此公钥相关的私人密钥命名为 $b$（小写）。$B$是由$G$（生成点）和$b$（私人密钥）在椭圆曲线上的点的加法和倍增决定的：

$$ B = b \cdot G $$


- 爱丽丝使用自己的私人密钥 $a$ 和鲍勃的公开密钥 $B$，通过点的加法和倍增计算出椭圆曲线上的秘密点 $S$（大写）。

$$ S = a \cdot B $$


- Alice 计算出盲区系数 $f$，这样就可以对支付密码进行加密。为此，她将使用 HMAC-SHA512 函数确定一个伪随机数。在该函数的第二个输入端，她使用了一个只有鲍勃才能检索到的值：$x$，即之前计算出的秘密点的斜率。第一个输入是 $o$，即本次交易输入（输出点）中消耗的 UTXO。

$$ f = \text{HMAC-SHA512}(o, x) $$

**2- 爱丽丝将她的个人支付密码转换成基 2（二进制）**。

**3- 她使用这个致盲因子作为密钥，对支付密码的有效载荷进行对称加密。** 使用的加密算法只是 "XOR"。**使用的加密算法是简单的 "XOR"，执行的操作类似于 Vernam 密码，也被称为 "一次性垫"。


- 爱丽丝首先将她的致盲因子一分为二：前 32 个字节名为 $f1$，后 32 个字节名为 $f2$。这样，我们就有了

$$ f = f1 || f2 $$


- 爱丽丝分别计算其支付密码的公开密钥$x$中的加密$x'$和其链密码$c$中的加密$c'$。$f1$ 和 $f2$ 分别作为加密密钥。使用的操作是 "XOR"（排他或）。

$$ x' = x \oplus f1 $$

$$ c' = c \oplus f2 $$


- 爱丽丝用加密值 x'$ 和 c'$ 替换支付密码中的公共密钥 x'$ 和链码 c'$ 的实值。

**4-**爱丽丝目前拥有带有加密有效载荷的支付密码。她将构建并广播一个交易，输入是她的公钥 $A$，输出是鲍勃的通知地址，"OP_RETURN "输出包含她的付款代码和加密的有效负载。 **该交易即为通知交易**。

OP_RETURN "是将比特币交易输出标记为无效的操作码。如今，它被用来在比特币区块链上广播或锚定信息。它最多可存储 80 字节的数据，这些数据会被写入链中，因此所有其他用户都能看到。

正如我们在前面的章节中所看到的，ECDH 被用来在两个通过不安全网络通信的用户之间生成一个共享秘密，攻击者可能会观察到这个秘密。在 BIP47 中，ECDH 被用于通过比特币网络进行通信，而比特币网络本质上是一个透明的通信网络，许多攻击者都能观察到。通过 ECDH 密钥交换计算出的共享秘密随后用于加密要传输的秘密信息：发送方（爱丽丝）的支付密码。

让我们一起回顾一下刚才复习过的执行通知交易的步骤：


- Alice 获取 Bob 的支付密码和通知地址；
- 爱丽丝在自己的高清钱包中选择一个UTXO，并选择相应的密钥对；
- 她用 ECDH 计算出了椭圆曲线上的一个秘密点；
- 她利用这个秘密点计算出一个 HMAC，也就是致盲因子；
- 她利用这个致盲因子对个人支付密码的有效载荷进行加密；
- 她使用 "OP_RETURN "事务输出将屏蔽的付款代码发送给鲍勃。

![BTC204](assets/en/66/17.webp)

### 通知交易：混凝土研究

为了更详细地了解它的功能，尤其是 `OP_RETURN` 的使用，让我们一起来检查一个真实的通知事务。我在 testnet 上执行了这样一个事务，您可以 [点击此处](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e) 找到它。

![BTC204](assets/notext/66/18.webp)

观察这个事务，我们可以发现它有一个输入和 4 个输出：


- 第一个输出是 `OP_RETURN` 包含我屏蔽的付款代码；
- 第二个输出的 546 sats 指向我的收件人通知地址；
- 第三项输出的 15,000 sats 代表服务费，因为我使用 Samourai 钱包来构建这笔交易；
- 第四个 200 万 sats 输出代表变化，即从我的输入返回到属于我的另一个地址的剩余差值。

最值得研究的显然是使用 `OP_RETURN` 的输出 0。让我们更仔细地看看它的内容。下面是十六进制的 `scriptPubKey`：

```text
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

在这个脚本中，我们可以剖析几个部分。首先是操作码：

```text
6a4c
```

在操作码中，我们可以识别指定 "OP_RETURN "的 "0x6a "和指定 "OP_PUSHDATA1 "的 "0x4c"。

最后一个操作码后面的字节表示后面有效载荷的大小。它表示 `0x50`，即 80 字节：

```text
6a4c50
```

然后，我们就有了明文的付款代码元数据：

```text
010002
```

我的支付密码的公开密钥的加密 x 坐标：

```text
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

我的支付密码的加密链码：

```text
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

最后，填充到 80 字节，这是 `OP_RETURN` 的标准大小：

```text
00000000000000000000000000
```

为了更好地理解，下面是我的付款代码，以基数 58 为单位的明文：

```text
PM8TJQCyt6ovbozreUCBrfKqmSVmTzJ5vjqse58LnBzKFFZTwny3KfCDdwTqAEYVasn11tTMPc2FJsFygFd3YzsHvwNXLEQNADgxeGnMK8Ugmin62TZU
```

基数为 16：

```text
4701000277507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42add94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc000000000000000000000000008604e4db
```

在比较我的明文支付代码和 `OP_RETURN` 时，可以发现 HRP（`0x47`）和校验和（`0x8604e4db`）没有被传送。这是意料之中的，因为这些信息是为人类准备的。

接下来，我们可以识别版本（`0x01`）、位域（`0x00`）和公钥奇偶校验（`0x02`）。在支付密码的末尾，空字节（`0x0000000000000000000000`）被用来填充密码，使其总数达到 80 个字节。所有这些元数据都以明文（未加密）形式传输。

最后，可以看到公钥的 x 坐标（`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`）和链码（`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`）已被加密。这就是付款代码的有效载荷。

### 什么是 XOR？

在前面的章节中，我们看到支付密码是通过 XOR 运算加密传输的。让我们花点时间了解一下这个运算符的工作原理，因为它在密码学中被广泛使用。

XOR 是基于布尔代数的位逻辑运算符。对于两个比特操作数，如果同级比特不同，则返回 `1`；如果同级比特相同，则返回 `0`。下面是基于操作数`D`和`E`的 XOR 的真值表：

| d | e | d xor e |

| --- | --- | ------- |

| 0 | 0 | 0 |

| 0 | 1 | 1 |

| 1 | 0 | 1 |

| 1 | 1 | 0 |

例如

$$
0110 \oplus 1110 = 1000
$$

或者

$$
010011 \oplus 110110 = 100101
$$

在 ECDH 中，使用 XOR 作为加密层尤为合适。首先，由于使用了这个运算符，加密是对称的。这样，收款人就可以用加密时使用的相同密钥来解密付款代码。加密和解密密钥是通过 ECDH 从共享秘密中计算出来的。这种对称性得益于 XOR 运算符的交换和关联特性：


- 其他属性

$$
D \oplus D = 0
$$

D ⊕ 0 = D


- 交换性

$$
D \oplus E = E \oplus D
$$


- 关联性：

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
$$

如果

$$
D \oplus E = L
$$

那么

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
$$

其次，这种加密方法与 Vernam 密码（一次性密码匙）非常相似，而 Vernam 密码是迄今为止已知的唯一具有无条件（或绝对）安全性的加密算法。要使 Vernam 密码具有这种特性，加密密钥必须是完全随机的，必须与信息大小相同，而且只能使用一次。在这里用于 BIP47 的加密方法中，密钥确实与信息大小相同，致盲因子与公共密钥的 x 坐标和支付密码的链码的连接大小完全相同。这个加密密钥确实只使用一次。不过，由于是 HMAC，所以这个密钥并不是完全随机的结果。它是伪随机的。因此，它不是 Vernam 密码，但方法类似。

### 接收通知事务

现在，爱丽丝已经向鲍勃发送了交易通知，让我们看看他是如何解读的。需要提醒的是，Bob 必须能够访问 Alice 的支付密码。没有这个信息，我们将在下一节看到，他将无法推导出 Alice 创建的密钥对，因此也就无法获取通过 BIP47 收到的比特币。现在，Alice 支付代码的有效载荷已经加密。让我们看看鲍勃是如何解密的。

**1-** 鲍勃监控使用其通知地址创建输出的交易。

**2-** 当一个事务在其通知地址上有输出时，鲍勃会分析它是否包含遵循 BIP47 标准的 OP_RETURN 输出。

**3-** 如果 OP_RETURN 有效负载的第一个字节是 "0x01"，则鲍勃开始搜索 ECDH 可能的共享密文：


- 鲍勃在交易输入中选择公钥。也就是说，爱丽丝的名为 $A$ 的公开密钥有：

$$ A = a \cdot G $$


- 鲍勃选择与其个人通知地址相关的私人密钥 $b$：

$$ b $$


- 鲍勃通过加点和倍点计算椭圆曲线上的秘密点 $S$（共享的 ECDH 秘密），并将他的私人密钥 $b$ 应用于爱丽丝的公开密钥 $A$：

$$ S = b \cdot A $$


- 鲍勃确定能够解密爱丽丝支付密码有效载荷的致盲因子 $f$。与爱丽丝之前计算的方法相同，鲍勃将通过对秘密点 $S$ 的 x 坐标 $x$ 和在此通知交易中作为输入消耗的 UTXO 应用 HMAC-SHA512 来找到 $f$：

$$ f = \text{HMAC-SHA512}(o, x) $$

**4-** 鲍勃将通知交易 OP_RETURN 中的数据解释为付款代码。他只需使用致盲因子 $f$ 对这个潜在付款代码的有效载荷进行解密即可：


- 鲍勃将致盲因子 $f$ 分成两部分：$f$ 的前 32 个字节为 $f1$，后 32 个字节为 $f2$；
- 鲍勃从爱丽丝的支付密码中解密公开密钥的 x 坐标 $x'$：

$$ x = x' \oplus f1 $$


- 鲍勃从爱丽丝的支付密码中解密加密链码值 $c'$：

$$ c = c' \oplus f2 $$

**5-** 鲍勃检查爱丽丝付款密码中的公钥值是否确实属于 secp256k1 组。如果是，他就将其视为有效的支付密码。否则，他会忽略这笔交易。

既然鲍勃知道了爱丽丝的付款代码，她就可以向爱丽丝发送多达 `2^32` 笔付款，而无需再次进行此类通知交易。

为什么会这样？鲍勃如何才能确定与爱丽丝相同的致盲因子，从而解密她的支付密码呢？让我们仔细研究一下 ECDH 在我们刚才描述的过程中的作用。

首先，我们处理的是对称加密。这意味着加密密钥和解密密钥的值相同。通知交易中的这个密钥就是致盲因子：

$$ f = f1 || f2 $$

因此，爱丽丝和鲍勃必须获得相同的 $f$ 值，但不能直接传输，因为攻击者可能窃取该值并解密秘密信息。通过对 2 个值应用 HMAC-SHA512 算法，就可以得到这个致盲因子：


- 秘密点的 x 坐标；
- 和在交易中作为输入消耗的 UTXO。

因此，鲍勃需要这两个信息来解密爱丽丝支付密码的有效载荷。对于作为输入的 UTXO，Bob 只需通过观察通知交易即可获取。至于秘密点，鲍勃则必须使用 ECDH。正如上一节关于 Diffie-Hellman 的内容所述，爱丽丝和鲍勃只需交换各自的公开密钥，并将私钥秘密应用于对方的公开密钥，就能在椭圆曲线上找到一个特定的秘密点。通知交易就是依靠这种机制实现的：


- 鲍勃的密钥对

$$ B = b \cdot G $$


- 爱丽丝的密钥对：

$$ A = a \cdot G $$


- 对于一个秘密 $S (x, y)$：

$$ S = a\cdot B = a\cdot (b\cdot G) = (b\cdot a)\cdot G = b\cdot A $$

![BTC204](assets/en/66/19.webp)

既然鲍勃知道了爱丽丝的支付密码，他就能检测到爱丽丝的 BIP47 支付，并推导出锁定所收比特币的私钥。

让我们回顾一下刚才接收和解释通知交易的步骤：


- 鲍勃监控发送到其通知地址的交易输出；
- 当检测到一个信息时，他会检索 OP_RETURN 中包含的信息；
- 鲍勃在输入中选择公钥，并使用 ECDH 计算秘密点；
- 他利用这个秘密点计算出一个 HMAC，这就是致盲因子；
- 他利用这个致盲因子来解密 OP_RETURN 中包含的爱丽丝支付密码的有效载荷。

![BTC204](assets/en/66/20.webp)

### BIP47 支付交易

现在，让我们一起来研究一下 BIP47 的付款流程。提醒您目前的状况：


- 爱丽丝知道鲍勃的支付密码，她只是从他的网站上获取了这个密码；
- 鲍勃通过通知交易知道了爱丽丝的支付密码；
- Alice 将向 Bob 支付第一笔款项。她还能以同样的方式支付其他许多款项。

在解释这一过程之前，我认为有必要回顾一下我们目前正在研究的索引。付款代码的派生路径描述如下：`m/47'/0'/0'`.下一个深度以这种方式分配索引：


- 第一个正常（非加固）子对就是我们在上一部分中提到的用于生成通知地址的子对：`m/47'/0'/0'/0`;
- 正常的子密钥对在 ECDH 中用于生成 BIP47 付款接收地址，我们将在本节中看到：从 `m/47'/0'/0'/0` 到 `m/47'/0'/0'/2 147 483 647`；
- 加固子密钥对是短暂的支付代码：从 `m/47'/0'/0'/0'` 到 `m/47'/0'/0'/2 147 483 647'`。

每当爱丽丝希望向鲍勃付款时，她都会再次通过 ECDH 协议获得一个新的唯一处女地址：


- Alice 选择从其个人可重复使用支付密码中提取的第一个私人密钥：

$$ a $$


- Alice 从 Bob 的支付密码中选择第一个未使用的公钥。这个公钥我们称之为 $B$。它与只有鲍勃知道的私人密钥 $b$ 相关联：

$$ B = b \cdot G $$


- 爱丽丝将自己的私人密钥 $a$ 与鲍勃的公开密钥 $B$ 相加，通过点加法和倍增计算出椭圆曲线上的秘密点 $S$$：

$$ S = a \cdot B $$


- 根据这个秘密点，爱丽丝将计算出共享秘密 $s$（小写）。为此，她会选择名为 $Sx$ 的秘密点 $S$ 的 x 坐标，并将此值通过 SHA256 哈希函数：

S = (Sx, Sy) $$$

$$ s = \text{SHA256}(Sx) $$


- 爱丽丝使用这个共享秘密 $s$ 计算比特币付款接收地址。首先，她要验证 $s$ 是否包含在 secp256k1 曲线的阶数内。如果不在，她就会递增鲍勃公钥的索引，从而得出另一个共享秘密；
- 其次，她通过在椭圆曲线上添加 $B$ 和 $s-G$ 两点，计算出公用密钥 $K0$。换句话说，爱丽丝将从鲍勃的支付密码 $B$ 中得到的公钥与椭圆曲线上的另一个点相加，并与 secp256k1 曲线的生成点 $G$ 中的共享秘密 $s$ 加倍。这个新点代表一个公钥，我们将其命名为 $K0$：

$$ K0 = B + s \cdot G $$


- 有了这个公钥 $K0$，爱丽丝就能推导出一个标准处女接收地址（例如，bech32 中的 SegWit V0）。

一旦爱丽丝获得了鲍勃的接收地址 $K0$，她就可以用标准方式进行比特币交易。为此，她会选择一个自己拥有的UTXO，由其HD钱包不同分支的一对密钥担保，并将其用于满足对Bob地址$K0$的输出。值得注意的是，一旦得出地址，这种支付就会按照常规流程进行，而不再依赖于与 BIP47 相关的密钥。

让我们一起回顾一下刚才发送 BIP47 付款的步骤：


- Alice 从个人支付密码中选择第一个派生子私人密钥；
- 她使用 ECDH 计算出椭圆曲线上的一个秘密点，这个秘密点来自鲍勃支付密码中第一个未使用的子公钥；
- 她使用这个秘密点用 SHA256 计算共享秘密；
- 她利用这个共享秘密计算出椭圆曲线上一个新的秘密点；
- 她将这个新密点加到鲍勃的公开密钥中；
- 她获得了一个新的短暂公开密钥，只有鲍勃拥有与之相关的私人密钥；
- 爱丽丝可以用推导出的短暂接收地址向鲍勃进行标准交易。

![BTC204](assets/en/66/21.webp)

如果爱丽丝想进行第二次支付，她将按照之前的步骤进行，只不过这次她将从鲍勃的支付密码中选择第二个派生公钥。具体来说，她将使用下一个未使用的密钥。这样，她将获得一个属于 Bob 的新接收地址，指定为 $K1$：

![BTC204](assets/en/66/22.webp)

她可以继续以这种方式推导出属于 Bob 的多达 `2^32` 个未使用的地址。

从外部角度来看，通过观察区块链，理论上无法区分 BIP47 支付和标准支付。以下是 Testnet 上的 BIP47 支付交易示例：

```text
94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
```

这看起来像一个标准的交易，有一个消耗输入、一个支付输出和一个变更：

![BTC204](assets/notext/66/23.webp)

### 接收 BIP47 付款和获取私人密钥

Alice 刚刚向属于 Bob 的新 BIP47 地址支付了第一笔款项。现在我们来看看鲍勃是如何收到这笔款项的。我们还将看到为什么 Alice 无法访问她自己刚刚生成的地址的私钥，以及 Bob 如何获取该私钥来花费他刚刚收到的比特币。

一旦鲍勃收到爱丽丝的交易通知，他就会在爱丽丝发送任何付款之前获得公开密钥 BIP47 $K0$。然后，他会监控向相关地址支付的任何款项。事实上，他会立即推导出几个他要监控的地址（$K0$, $K1$, $K2$, $K3$......）。下面是他如何获得 $K0$ 的公钥：


- 鲍勃从他的支付密码中选择第一个私人子密钥。这个私人密钥被命名为 $b$。它与公共密钥 $B$ 相关联，爱丽丝在上一步中就是用它进行计算的：

$$ b $$


- 鲍勃从爱丽丝的支付密码中选出她的第一个公开密钥。这个密钥被命名为 $A$。它与私人密钥 $a$ 相关联，Alice 用私人密钥进行了计算，只有 Alice 知道这个私人密钥。鲍勃可以执行此过程，因为他知道爱丽丝的支付密码，该密码是与通知交易一起传送给他的：

$$ A = a \cdot G $$


- 鲍勃使用自己的私人密钥$b$和爱丽丝的公开密钥$A$，通过椭圆曲线上点的加法和倍增计算出秘密点$S$。在这里，我们发现 ECDH 的使用保证了鲍勃和爱丽丝的这个点 $S$ 将是相同的：

$$ S = b \cdot A $$


- 就像爱丽丝所做的那样，鲍勃找出了这一点的 x 坐标 $S$。我们将这个值命名为 $Sx$。他将此值通过 SHA256 函数，找到共享秘密 $s$（小写）：

$$ s = \text{SHA256}(Sx) $$


- 和爱丽丝一样，鲍勃计算出椭圆曲线上的 $s-G$ 点。然后，他把这个秘密点添加到他的公开密钥 $B$中。然后，他得到椭圆曲线上的一个新点，并将其解释为公开密钥 $K0$：

$$ K0 = B + s \cdot G $$

一旦鲍勃拥有了这把公钥 $K0$，他就可以得到相关的私钥，从而能够使用他的比特币。只有他能生成这个私钥：


- 鲍勃添加自己的子私人密钥 $b$，该密钥来自他的个人支付密码。只有他能获得 $b$ 的值。然后，他将 $b$ 与共享秘密 $s$ 相加，得到 $k0$，即 $K0$ 的私人密钥：

$$ k0 = b + s $$

根据椭圆曲线的群规律，鲍勃可以准确地获得与爱丽丝使用的公开密钥相对应的私人密钥。因此，我们有

$$ K0 = k0 \cdot G $$

我将总结一下我们刚才一起完成的接收 BIP47 付款和计算相应私钥的步骤：


- 鲍勃从个人支付密码中选择第一个派生子私人密钥；
- 他使用 ECDH 计算出椭圆曲线上的一个秘密点，该秘密点来自爱丽丝链式代码中的第一个派生子公钥；
- 他利用这个秘密点用 SHA256 计算共享秘密；
- 他利用这个共享秘密，在椭圆曲线上计算出一个新的秘密点；
- 他将这个新密点添加到个人公开密钥中；
- 他获得一个新的短暂公开密钥，爱丽丝将向其发送第一笔付款；
- 鲍勃计算与这一短暂公开密钥相关的私人密钥时，要加上他从支付密码和共享秘密中得出的子私人密钥。

![BTC204](assets/en/66/24.webp)

由于爱丽丝无法获得 $b$（鲍勃的私人密钥），她也就无法确定 $k0$（与鲍勃的 BIP47 接收地址相关的私人密钥）。我们可以用这种方法来表示共享秘密 $S$ 的计算：

![BTC204](assets/en/66/19.webp)

一旦通过 ECDH 找到共享密钥，爱丽丝和鲍勃就会计算出 BIP47 支付公钥 $K0$，鲍勃也会计算出相关的私钥 $k0$：

![BTC204](assets/en/66/25.webp)

### 退还 BIP47 付款

由于 Bob 知道 Alice 可重复使用的付款代码，因此他已经掌握了向 Alice 退款所需的所有信息。他无需再次联系 Alice 询问任何信息。他只需用一个通知交易通知她，特别是让她用种子找回 BIP47 地址，然后他还可以向她发送多达 `2^32` 笔付款。

退款功能是 BIP47 特有的功能，也是它相对于其他方法（如静默支付）的优势之一，我们将在接下来的章节中学习。

然后，鲍勃可以用爱丽丝向他发送付款的同样方式向爱丽丝退款。角色互换：

![BTC204](assets/en/66/26.webp)

*衷心感谢[Fanis Michalakis](https://x.com/FanisMichalakis)对这篇文章的审阅和宝贵的专家建议，是他启发了本章的写作！* *

https://planb.network/tutorials/privacy/on-chain/paynym-bip47-a492a70b-50eb-4f95-a766-bae2c5535093
## 无声支付

<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>

BIP47 因其链上效率低下而饱受批评。如前一章所述，它需要为每个新收款人进行一次通知交易。如果计划与收款人建立持久的支付渠道，这种限制就变得微不足道了。事实上，一次通知交易就能为随后几乎无限次的 BIP47 支付铺平道路。

然而，在某些情况下，通知交易可能会成为用户的障碍。以向收款人进行一次性捐款为例：使用传统的比特币地址，只需进行一次交易即可完成捐款。但在 BIP47 中，需要进行两次交易：一次用于通知，另一次用于实际支付。当对区块空间的需求较低且交易费用较低时，这个额外的步骤通常不成问题。然而，在拥堵时期，单笔支付的交易费可能会变得非常高昂，与标准的比特币交易相比，用户的成本可能会增加一倍，这可能是用户无法接受的。

对于用户只计划向一个静态标识符支付几笔款项的情况，已经开发了其他解决方案。其中包括[BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)中描述的无声支付。该协议允许使用静态标识符接收付款，而不会产生地址重复使用，也不需要使用通知交易。让我们来看看这个协议是如何工作的。

---
*要完全理解本章内容，必须熟悉 ECDH（椭圆曲线 Diffie-Hellman）的工作原理和高清钱包中的加密密钥推导。这些概念在上一章 BIP47 中已有详细介绍。在此不再赘述。如果你还不熟悉这些概念，我建议在继续学习本章之前先查阅前一章。我也不会再讨论重复使用收款地址的风险，以及拥有唯一标识符收款的重要性*。

---
### 为什么不移动通知？

如 BIP47 章所述，通知交易主要有两个功能：


- 它会通知收件人；
- 它传输发件人的支付密码。

人们可能会天真地认为，这一通知过程可以在链外进行。从理论上讲，这是完全可行的：收件人只需指明一种通信方式，即可从发件人处接收 BIP47 付款代码。然而，这种方法存在两大问题：


- 首先，这将把代码传输过程转移到另一个通信协议上。与成本和交换隐私相关的问题依然存在，只是转移到了这个新协议上。在隐私方面，这也可能会在用户身份和链上活动之间建立联系，而这正是我们直接在区块链上执行通知所要避免的。此外，在区块链外进行通知会带来审查风险（如资金冻结），而比特币不存在这种风险；
- 其次，这将带来一个恢复问题。使用 BIP47 时，收款人必须绝对知道发款人的支付密码才能获取资金。不仅在收款时如此，在钱包丢失时通过种子找回资金时也是如此。使用链上通知可以避免这种风险，因为用户只需知道种子就可以找到并解密通知交易。但是，如果在区块链外进行通知，用户就需要对所有收到的支付代码进行动态备份，这对普通用户来说是不切实际的。

所有这些限制因素都使得在 BIP47 中使用链上通知必不可少。然而，由于成本问题，无声支付特别寻求避免这一链上通知步骤。因此，采用的解决方案不是移动通知，而是完全取消通知。为此，必须接受一种折衷方案：扫描。与 BIP47 不同的是，在 BIP47 中，由于有了通知交易，用户可以准确地知道在哪里可以找到他们的资金，而在静默支付中，用户必须检查所有现有的比特币交易，以发现任何可能是针对他们的支付。为了减轻操作负担，对无声支付的搜索仅限于可能包含此类支付的交易，即至少包含一个 Taproot P2TR 输出的交易。扫描也只关注钱包创建日期起的交易（如果钱包创建于 2024 年，则无需扫描 2009 年的交易）。

因此，你可以理解为什么 BIP47 和无声支付虽然目标相似，但涉及不同的折衷方案，**因此实际上是为了满足不同的使用情况**。对于一次性支付，如偶尔的捐款，无声支付因其成本较低而更为合适。相反，对于向同一收款人的定期交易，如交易所平台或矿池，BIP47 可能是首选。

让我们一起来探讨无声支付的技术运作，以便更好地理解其影响。为此，我建议我们采用与 BIP352 解释性文件相同的方法。我们将逐步逐项分解需要进行的计算，并对每项新增加的内容进行论证。

### 需要了解的一些概念

在我们开始之前，有必要说明一下，静默支付完全依赖于 P2TR（*支付到 Taproot*）脚本类型的使用。与 BIP47 不同的是，它不需要通过散列子公钥来推导接收地址。事实上，在 P2TR 标准中，经过调整的公钥会直接在地址中公开使用。因此，Taproot 接收地址本质上是一个公钥，并附带一些元数据。这个经过调整的公开密钥是另外两个公开密钥的集合：一个允许通过简单的签名进行直接和传统的消费，另一个代表 MAST 的梅克尔树根，它授权在满足梅克尔树中潜在条件之一的情况下进行消费。

![BTC204](assets/en/67/01.webp)

之所以决定将静默支付仅限于 Taproot，主要有两个原因：


- 首先，它大大方便了钱包软件的实施和未来更新，因为只需遵守一种标准；
- 其次，这种方法有助于提高用户的匿名性，鼓励他们不要分散使用不同类型的脚本，因为这些脚本在链分析中会产生不同的钱包指纹（关于这一概念的更多信息，请参阅第 2 部分第 4 章）。

### 沉默支付公开密钥的简单推导

让我们从一个简单的例子开始，帮助你理解 SP（静默支付）的核心功能。以两个比特币用户 Alice 和 Bob 为例。Alice 想用一个新的接收地址向 Bob 发送比特币。在这个过程中，必须实现三个目标：


- Alice 必须能够生成一个新地址；
- Bob 必须能够识别寄往这一特定地址的付款；
- 鲍勃必须能够获得与该地址相关的私人密钥，才能使用他的资金。

爱丽丝的比特币钱包里有一个UTXO，用以下配对密钥保护：


- $a$：私人密钥；
- $A$: 公钥（$A = a\cdot G$）

鲍勃在互联网上公布了自己的 SP 地址：


- b$：私人密钥；
- $B$：公开密钥（$B = b \cdot G$）

通过获取鲍勃的地址，爱丽丝可以使用 ECDH 计算出一个属于鲍勃的新空白地址。我们称这个地址为 $P$：

$$ P = B + \text{hash}(a \cdot B) \cdot G $$

在这个等式中，爱丽丝只需计算她的私人密钥 $a$ 和鲍勃的公开密钥 $B$ 的点积。她将这一结果通过一个众所周知的哈希函数。然后将输出值与椭圆曲线 `secp256k1` 的生成点 $G$ 进行标量相乘。最后，爱丽丝将得到的点添加到鲍勃的公开密钥 $B$。一旦爱丽丝得到了这个地址 $P$，她就可以在交易中使用它作为输出，也就是向它发送比特币。

> *在无声支付中，"哈希 "函数对应于一个专门标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数，以确保生成的哈希值对本协议是唯一的，不能在其他情况下重复使用，同时还提供额外保护，防止在签名中重复使用非ces。该标准对应于[在 BIP340 中指定的 Schnorr 签名](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) `secp256k1` 上的标准*。
根据 ECDH 所依赖的椭圆曲线的特性，我们可以知道

$$ a \cdot B = b \cdot A $$

因此，鲍勃可以计算出爱丽丝发送比特币的收款地址。为此，他会监控所有符合 "静默支付 "标准的比特币交易，并对每笔交易进行如下计算，以确定付款是否是发给他的（*扫描*）：

$$ P' = B + \text{hash}(b \cdot A) \cdot G $$

当他扫描 Alice 的交易时，他发现 $P'$ 等于 $P$。因此，他知道这笔钱是付给他的：

$$ P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P $$

这样，鲍勃就能计算出私人密钥 $p$，从而可以使用地址 $P$：

$$ p = (b + \text{hash}(b \cdot A))\bmod n $$

如您所见，要计算私人密钥 $p$，就必须拥有私人密钥 $b$。只有鲍勃拥有这个私人密钥 $b$。因此，只有他才能使用发送到他的静默支付地址的比特币。

![BTC204](assets/notext/67/02.webp)

*说明：*


- $B$:鲍勃发布的公开密钥/静态地址
- $b$：鲍勃的私人密钥
- $A$:作为交易输入的 Alice UTXO 的公开密钥
- $a$:爱丽丝的私人密钥
- $G$:椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$：标记为 "BIP0352/SharedSecret "的 SHA256 散列函数
- $s$:共同的 ECDH 秘密
- $P$:用于向鲍勃付款的公钥/唯一地址

这里有一种最初相当幼稚的方法，即使用 Bob 的静态地址（记为 $B$）来推导出一个唯一的地址 $P$ 用于发送比特币。然而，这种方法过于简单，有几个缺陷需要改正。第一个问题是，在这个方案中，爱丽丝无法在同一笔交易中向鲍勃创建多个输出。

### 如何创建多个输出？

在上一节的示例中，爱丽丝创建了一个单一的输出，将发送到鲍勃的唯一地址 $P$。在选择相同输入的情况下，爱丽丝不可能为鲍勃创建两个不同的原始地址，因为所使用的方法将始终导致 $P$ 的结果相同，因此地址也相同。然而，在许多情况下，爱丽丝可能希望将支付给鲍勃的款项分成几笔较小的金额，从而创建多个UTXO。因此，有必要找到一种可以实现这一目的的方法。

为此，我们将稍微修改爱丽丝为得出 $P$ 而进行的计算，这样她就能为鲍勃生成两个不同的地址，即 $P_0$ 和 $P_1$。

要修改计算结果并得到两个不同的地址，只需添加一个整数来修改结果即可。因此，爱丽丝将在计算中添加 $0$，以获得地址 $P_0$；添加 $1$，以获得地址 $P_1$。我们称这个整数为 $i$：

$$ P_i = B + text{hash}(a \cdot B \text{‖ } i) \cdot G $$

计算过程与前一种方法相同，只是这次爱丽丝会在进行哈希计算前将 $a \cdot B$ 与 $i$ 连接起来。然后，只需更改 $i$ 即可得到属于 Bob 的新地址。例如

$$ P_0 = B + text{hash}(a \cdot B \text{ ‖ } 0) \cdot G $$

$$ P_1 = B + text{hash}(a \cdot B \text{‖ } 1) \cdot G $$

当鲍勃扫描区块链以查找为他准备的静默支付时，他首先使用 $i = 0$ 作为地址 $P_0$。如果他在 $P_0$ 上没有发现任何付款，他就会得出结论，这笔交易不包含任何给他的静默支付，并停止对它的分析。但是，如果 $P_0$ 是有效的，并且包含一笔对他的付款，他就会在同一笔交易中继续处理 $P_1$，检查 Alice 是否进行了第二次付款。如果 $P_1$ 无效，他就停止对这笔交易的搜索；否则，他会继续测试连续的 $i$ 值：

$$ P_0 = B + text{hash}(b \cdot A \text{‖ } 0) \cdot G $$

$$ P_1 = B + text{hash}(b \cdot A \text{‖ } 1) \cdot G $$

由于如果 $P_0$ 没有任何结果，Bob 会立即在 $i = 0$ 处停止，因此在交易的扫描步骤中，使用这个整数几乎不会给 Bob 增加额外的操作负担。

然后，鲍勃可以用同样的方法计算私钥：

$$
p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n
$$

$$
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n
$$

![BTC204](assets/notext/67/03.webp)

*说明：*


- $B$:鲍勃发布的公开密钥/静态地址
- $b$：鲍勃的私人密钥
- $A$:作为交易输入的 Alice UTXO 的公开密钥
- $a$:爱丽丝的私人密钥
- $G$:椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s_0$:第一个共享的 ECDH 秘密
- $s_1$:第二个共享的 ECDH 秘密
- $P_0$:向鲍勃付款的第一个公钥/唯一地址
- $P_1$:第二个公开密钥/向鲍勃付款的唯一地址

通过这种方法，我们开始有了一个不错的协议，但仍有一些难题需要克服，特别是防止地址重复使用。

### 如何避免地址重复使用？

正如我们在前面章节中所看到的，爱丽丝使用一对密钥来保护她的 UTXO，她将用这对密钥来计算与鲍勃共享的 ECDH 秘密。有了这个秘密，爱丽丝就能得到唯一地址 $P_0$。但是，如果爱丽丝多次重复使用这个地址，她使用的一对密钥（$a$, $A$）可以确保多个UTXO的安全。如果爱丽丝使用由相同密钥 $A$ 保护的两个 UTXO 向鲍勃的静态地址 $B$ 支付了两次款项，这将导致鲍勃重复使用地址。

> *地址重复使用对用户隐私来说是一种非常糟糕的做法。要了解原因，我建议您回顾一下本培训的前几部分*。
事实上，由于唯一地址 $P_0$ 是由 $A$ 和 $B$ 导出的，如果 Alice 用相同的密钥 $A$ 导出第二个地址，用于向 $B$ 支付第二笔款项，她最终会得到相同的地址 $P_0$。为了避免这种风险，并防止在静默支付中重复使用地址，我们需要稍微修改一下计算方法。

我们希望爱丽丝作为支付输入所使用的每个UTXO 都能为鲍勃提供一个唯一地址，即使多个UTXO 都由同一对密钥保护。因此，在计算唯一地址 $P_0$ 时，只需添加对UTXO 的引用即可。这个引用就是作为输入的UTXO的哈希值：

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

在计算唯一地址 $P_0$ 时，爱丽丝会加上这个输入参考：

$$ P_0 = B + text{hash}(\text{inputHash} \cdot a \cdot B \text{ ‖ } 0) \cdot G $$

在扫描过程中，鲍勃也可以添加 $\text{inputHash}$，因为他只需要观察事务就可以推断出 $\text{outpoint}$：

$$ P_0 = B + \text{inputHash} （ \text{inputHash} \cdot b \cdot A \text{ ‖ } 0） \cdot G $$

当他找到有效的 $P_0$ 时，就能计算出相应的私人密钥 $p_0$：

$$
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
$$

![BTC204](assets/notext/67/04.webp)

*图例：*


- $B$:鲍勃发布的公开密钥/静态地址
- $b$：鲍勃的私人密钥
- $A$:作为交易输入的 Alice UTXO 的公开密钥
- $a$:爱丽丝的私人密钥
- $H$:作为输入的UTXO的哈希值
- $G$:椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$：标记为 "BIP0352/SharedSecret "的 SHA256 哈希函数
- $s_0$:第一个共享的 ECDH 秘密
- $P_0$:第一个公共密钥/唯一地址，用于向鲍勃付款

目前，我们的计算假设爱丽丝在交易中使用单一输入。但是，她应该可以使用多个输入。因此，在鲍勃这边，对于包含多个输入的每笔交易，理论上他都需要计算每个输入的 ECDH，以确定付款是否针对他。这种方法并不理想，因此我们需要找到一种解决方案来减少工作量！

### 调整输入中的公开密钥

为了解决这个问题，我们将使用交易输入中使用的所有密钥对的总和，而不是使用确保 Alice 一方特定输入的密钥对。然后，这个总和将被视为一对新的密钥。这种技术被称为 "调整"。

例如，假设 Alice 的交易有 3 个输入，每个输入都有一对不同的密钥：


- $a_0$ 确保输入 #0；
- $a_1$ 确保输入 #1；
- $a_2$ 保护 2 号输入。

![BTC204](assets/notext/67/05.webp)

按照上述方法，爱丽丝必须从 $a_0$、$a_1$ 和 $a_2$ 中选择一对密钥来计算 ECDH 密钥，并从鲍勃的静态地址 $B$ 生成唯一的支付地址 $P$。但是，这种方法要求鲍勃依次测试每种可能性，从 $a_0$开始，然后是 $a_1$，依此类推，直到确定一对生成有效地址 $P$的可能性。这一过程要求 Bob 对所有事务的所有输入执行 ECDH 计算，从而大大增加了操作扫描的工作量。

为了避免这种情况，我们会要求 Alice 使用输入的所有密钥之和来计算 $P$。以我们的例子为例，经过调整的私人密钥 $a$ 的计算方法如下：

$$ a = a_0 + a_1 + a_2 $$

同样，爱丽丝和鲍勃也能计算出经过调整的公开密钥：

$$ a = a_0 + a_1 + a_2 $$

利用这种方法，鲍勃只需计算交易公钥的总和，然后只需从 $A$ 计算 ECDH 密钥，这大大减少了扫描步骤的计算量。但是，请记住上一节的内容。我们在计算中包含了哈希值 $\text{inputHash}$，它被用作防止地址重复使用的 nonce：

$$ \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A) $$

但如果一个事务中有多个输入，就需要确定在计算中选择哪个 $\text{outpoint}$。根据 BIP352，$\text{outpoint}$ 的选择标准是按词典顺序选择最小的，也就是按字母顺序选择最先出现的UTXO。这种方法规范了在每个事务中选择的UTXO。例如，如果这个最小的 $\text{outpoint}$ 按词典顺序是 $\text{outpoint}_L$，那么 $\text{inputHash}$ 的计算结果将是：

$$ \text{inputHash} = \text{hash}(\text{outpoint}_L \text{‖ } A) $$

接下来的计算仍与上一节中介绍的相同，只是私钥 $a$ 及其对应的公钥 $A$ 不再是一对确保单一输入的密钥对，而是代表输入中所有密钥对的调整。

### 分离支出和扫描密钥

到目前为止，我们已经讨论了作为唯一公钥的静默支付静态地址 $B$。请记住，Alice 正是使用此公钥 $B$ 创建共享的 ECDH 密钥，而 ECDH 密钥又用于计算唯一的支付地址 $P$。鲍勃在扫描步骤中使用此公钥 $B$ 和相应的私钥 $b$。但他也会使用私人密钥 $b$ 来计算私人密钥 $p$，以允许从地址 $P$ 进行消费。

这种方法的缺点是，用于计算接收静默支付地址的所有私钥的私钥 $b$ 也被 Bob 用来扫描交易。这一步骤需要在连接到互联网的钱包软件中使用 $b$，这与将其保存在冷钱包中相比，面临着更大的被盗风险。理想的情况是，在利用静默支付的同时，将控制所有其他私钥访问权限的私钥 $b$ 保存在硬件钱包中。幸运的是，该协议的调整正是为了实现这一点。

为此，BIP352 规定接收器使用两对不同的密钥：


- $B_{text{spend}}$：计算唯一支付地址的私钥；
- $B_{text{scan}}$：查找唯一的付款地址。

这样，鲍勃就可以将私钥 $b_{\text{spend}}$ 保存在硬件钱包中，并在在线软件中使用私钥 $b_{\text{scan}}$ 来查找他的静默支付，而不会泄露 $b_{\text{spend}}$。然而，公钥 $B_{\text{scan}}$ 和 $B_{\text{spend}}$ 都是公开的，因为它们可以在鲍勃的静态地址 $B$ 中找到：

$$ B = B_{text{scan}}\文本{ ‖ }B_{text{spend}}$$

为了计算出属于 Bob 的唯一付款地址 $P_0$，Alice 现在将进行以下计算：

$$ P_0 = B_{text{spend}}+ text{hash}(text{inputHash} \cdot a \cdot B_{text{scan}} \text{ ‖ } 0) \cdot G $$

为了找出给他的付款，鲍勃将进行如下计算：

$$ P_0 = B_{text{spend}}+ \text{hash}(\text{inputHash} \cdot b_{text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$

如您所见，到目前为止，鲍勃还不需要使用硬件钱包中的 $b_{\text{spend}}$。当他希望花费 $P_0$ 时，可以执行以下计算来找到私钥 $p_0$：

$$ p_0 = （ b_{text{spend}}+ text{hash}(\text{inputHash} \cdot b_{text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$

![BTC204](assets/notext/67/06.webp)

*说明：*


- $B_{text{scan}}$：鲍勃的扫描公开密钥（静态地址）
- $b_{text{scan}}$：鲍勃的扫描私钥
- $B_{text/{spend}}$：鲍勃的支出公开密钥（静态地址）
- $b_{text{spend}}$：鲍勃的支出私人密钥
- $A$:输入中公钥的总和（调整）
- $a$:与经过调整的公开密钥相对应的私人密钥
- $H$:输入中使用的最小UTXO（按词序排列）的哈希值
- $G$:椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$：标记为 "BIP0352/SharedSecret "的 SHA256 散列函数
- $s_0$:第一个共享的 ECDH 秘密
- $P_0$:鲍勃的第一个公开密钥/唯一支付地址

### 使用带标签的 SP 地址

因此，鲍勃有一个静默支付的静态地址 $B$，如下所示：

$$ B = B_{text{scan}}\文本{ ‖ }B_{text{spend}}$$

这种方法的问题在于，它无法区分发送到该地址的不同付款。例如，如果鲍勃的公司有两个不同的客户，而他又想明确区分每个客户的付款，那么他就需要两个不同的静态地址。按照目前的方法，一个简单的解决方案是鲍勃创建两个独立的钱包，每个钱包都有自己的静态地址，或者甚至在同一个钱包中建立两个不同的静态地址。但是，这种解决方案需要对整个区块链扫描两次（每个地址一次），以分别检测出针对每个地址的付款。这种重复扫描不合理地增加了 Bob 的操作负担。

为了解决这个问题，BIP352 使用了一种标签系统，允许使用不同的静态地址，而不会不合理地增加在区块链上查找静默支付的工作量。为此，在支出公钥 $B_{\text{spend}}$ 中添加了一个整数 $m$。对于第一个静态地址，这个整数的值可以是 1$，对于第二个静态地址，这个整数的值可以是 2$，以此类推。此后，花费密钥 $B_{text{spend}}$ 将被称为 $B_m$，并将以这种方式构建：

$$ B_m = B_{text{spend}} + \text{hash}(b_{text{scan}} \text{ ‖ } m+ text{hash}(b_{text{scan}} \text{ ‖ } m) \cdot G $$

例如，第一个支出键的标签为 1$：

$$ B_1 = B_{text{spend}} + \text{hash}(B_{text{scan}} \text{ ‖ } 1+ text{hash}(b_{text{scan}} \text{ ‖ } 1) \cdot G $$

现在，Bob 发布的静态地址将由 $B_{text{scan}}$ 和 $B_m$ 组成。例如，第一个标签为 $1$ 的静态地址将是

$$ B = B_{\text{scan}}\文本{ ‖ }B_1 $$

> *我们只从标号 1 开始，因为标号 0 是为更改预留的*。
爱丽丝则将以与之前相同的方式得出唯一支付地址 $P$，但使用新的 $B_1$ 代替 $B_{text{spend}}$。

$$ P_0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G $$

实际上，爱丽丝可能根本不知道鲍勃有一个标签地址，因为她只是使用了鲍勃提供给她的静态地址的第二部分，在这种情况下，第二部分的值是 $B_1$，而不是 $B_{text{spend}}$。

在扫描付款时，鲍勃将始终以这种方式使用其初始静态地址中的 $B_{text{spend}}$ 值：

$$ P_0 = B_{text{spend}}+ \text{hash}(\text{inputHash} \cdot b_{text{scan}} \cdot A \text{ ‖ } 0) \cdot G $$

然后，他只需从每个输出中逐个减去他找到的 $P_0$ 值。然后，他检查这些减法的结果中是否有一个与他在钱包上使用的某个标签的值相匹配。如果匹配，例如标签为 $1$的输出 #4，这意味着该输出是与他的标签静态地址 $B_1$ 相关联的静默支付：

$$ Out_4 - P_0 = \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$

这样做的原因是

$$ B_1 = B_{text{spend}} + \text{hash}(B_{text{scan}} \text{ ‖ } 1+ text{hash}(b_{text{scan}} \text{ ‖ } 1) \cdot G $$

有了这种方法，Bob 可以使用大量静态地址（$B_1$、$B_2$、$B_3$......），所有这些地址都来自于他的基本静态地址（$B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}}$），以便正确区分用途。

然而，这种静态地址分离仅适用于个人钱包管理，并不能实现身份分离。由于它们都具有相同的 $B_{text/{scan}}$，因此很容易将所有静态地址联系在一起，并推断出它们属于同一个实体。

![BTC204](assets/notext/67/07.webp)

*说明：*


- $B_{text{scan}}$：鲍勃的扫描公开密钥（静态地址）
- $b_{text{scan}}$：鲍勃的扫描私钥
- $B_{text{spend}}$：鲍勃的支出公开密钥（初始地址）
- $B_m$：鲍勃的标记花费公钥（静态地址）
- $b_m$：鲍勃的标记花费私人密钥
- $A$:输入公钥的总和（调整）
- $a$:与经过调整的公开密钥相对应的私人密钥
- $H$:作为输入的最小 UTXO 的哈希值（按词序排列
- $G$:椭圆曲线 `secp256k1` 的生成点
- $\text{SHA256}$：标记为 "BIP0352/SharedSecret "的 SHA256 散列函数
- $s_0$:第一个共享的 ECDH 秘密
- $P_0$:第一个公钥/唯一地址，用于向鲍勃付款
- $p_0$:鲍勃第一个唯一付款地址的私人密钥
- $X$:扫描私人密钥的哈希值，标签为

### 如何构建静默支付地址？

要创建一个专用的静默支付地址，首先必须在其 Bitcoin HD 钱包中生成 2 对密钥：


- $b_{\text{scan}}$、$B_{\text{scan}}$ 对，用于搜索我们收到的付款；
- 一对 $b_{\text{spend}}$、$B_{\text{spend}}$ 用于花费我们收到的比特币。

这些货币对是按照这些路径（*比特币主网*）衍生出来的：

```text
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

有了这两对密钥后，只需将它们连接起来（端到端），就能创建静态地址的有效载荷：

$$ B = B_{text{scan}}\文本{ ‖ }B_{text{spend}}$$

如果希望使用标签，则用 $B_m$ 代替 $B_{text/{spend}}$：

$$ B = B_{text{scan}}\文本{ ‖ }B_m $$

标签为 $m$：

$$ B_m = B_{text{spend}} + \text{hash}(b_{text{scan}} \text{ ‖ } m+ text{hash}(b_{text{scan}} \text{ ‖ } m) \cdot G $$

一旦有了这个有效载荷，就可以添加 HRP（*人类可读部分*）`sp`和版本`q`（=版本 0）。此外，还会添加校验和，并以 bech32m 格式格式化地址。

例如，这是我的静态静默支付地址：

```text
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```

关于静态地址，有一点很重要，您可能已经在前面的章节中输入过，那就是这些地址在比特币交易中是不可见的。只有输出中使用的支付地址 $P$ 以标准的 Taproot 格式出现在区块链上。因此，从外部无法区分使用 P2TR 输出的静默支付交易和普通交易。

就像 BIP47 一样，静态地址 $B$ 和从 $B$ 导出的支付地址 $P$ 之间不可能建立联系。事实上，即使潜在攻击者夏娃试图用鲍勃的静态地址 $B$ 扫描区块链，她也无法执行必要的计算来确定 $P$。要做到这一点，她需要鲍勃的私人扫描密钥 $b_{\text{scan}$ 或发送者的私人密钥 $a$，但这两个元素当然都是私有的。因此，将一个人的静态地址与某种形式的个人身份明确联系起来是可能的。

### 如何使用静默支付？

静默支付的提议是最近才提出的，迄今为止只有非常有限的钱包实施了这一提议。据我所知，只有 3 款软件支持它们：


- [CakeWallet](https://cakewallet.com/)
- [Silentium](https://app.silentium.dev/)
- [DonationWallet](https://github.com/Sosthene00/donationwallet)

我们不久将提供关于设置自己的静默支付静态地址的详细教程。

由于该功能刚推出不久，建议谨慎使用，避免在主网上使用 "无声支付 "进行大额支付。

*为了撰写关于无声支付的这一章，我使用了[无声支付解释网站](https://silentpayments.xyz/) 和[BIP352 解释文件](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki)。*

# 结论

<partId>2aee56c0-b285-4799-b4f7-373a552ee2b2</partId>

## 评论与评级

<chapterId>195d149f-80fa-5816-8b46-995a9226d082</chapterId>

<isCourseReview>真</isCourseReview>。

## 期末考试

<chapterId>e803d394-e3c1-5816-a6b4-a69a2472019c</chapterId>

<isCourseExam>真</isCourseExam>。

## 结论

<chapterId>cd8e5c67-50e4-4dcd-8e04-88ba5ec95305</chapterId>

<isCourseConclusion>true</isCourseConclusion>（是课程结论）。